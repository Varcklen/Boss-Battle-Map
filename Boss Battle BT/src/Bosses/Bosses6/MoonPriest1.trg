{
  "Id": 50333545,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope MoonPriest1 initializer init\r\n\r\n\tglobals\r\n\t\tprivate constant real COOLDOWN = 8\r\n\t\tprivate constant real DELAY = 5\r\n\t\tprivate constant real UNIT_SPAWN_DEVIATION = 400\r\n\t\tprivate constant integer UNIT_ID = 'h01C'\r\n\t\tprivate constant string SPAWN_ANIMATION = \"Abilities\\\\Spells\\\\Orc\\\\FeralSpirit\\\\feralspirittarget.mdl\"\r\n\t\t\r\n\t\tprivate constant integer COLOR_SATURATION = 50//(up to 255)\r\n\t\t\r\n\t\tprivate constant real RED_SEARCH_RANGE = 700\r\n\t\tprivate constant real RED_DAMAGE = 350\r\n\t\tprivate constant string RED_ANIMATION = \"Abilities\\\\Spells\\\\Other\\\\Incinerate\\\\FireLordDeathExplode.mdl\"\r\n\t\t\r\n\t\tprivate constant real BLUE_AREA_RANGE = 300\r\n\t\tprivate constant real BLUE_DAMAGE = 200\r\n\t\tprivate constant string BLUE_ANIMATION = \"Abilities\\\\Spells\\\\Other\\\\HowlOfTerror\\\\HowlCaster.mdl\"\r\n\t\t\r\n\t\tprivate constant real GREEN_HEAL = 400\r\n\t\tprivate constant string GREEN_ANIMATION = \"Abilities\\\\Spells\\\\Human\\\\Resurrect\\\\ResurrectTarget.mdl\"\r\n\tendglobals\r\n\r\n\tprivate function condition takes nothing returns boolean\r\n\t    return GetUnitTypeId( udg_DamageEventTarget ) == 'e005'\r\n\tendfunction\r\n\t\r\n\tprivate function Red takes unit boss returns nothing\r\n\t\tlocal unit target\r\n\t\t\r\n\t\tset target = randomtarget( boss, RED_SEARCH_RANGE, \"enemy\", \"\", \"\", \"\", \"\" )\r\n        if target != null then\r\n            call UnitDamageTarget( boss, target, RED_DAMAGE, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)\r\n            call DestroyEffect( AddSpecialEffectTarget(RED_ANIMATION, target, \"origin\") )\r\n        endif\r\n\t\t\r\n\t\tset target = null\r\n\tendfunction\r\n\t\r\n\tprivate function Blue takes unit boss returns nothing\r\n\t\tlocal group g = CreateGroup()\r\n\t    local unit u\r\n\t    \r\n        call DestroyEffect( AddSpecialEffectTarget(BLUE_ANIMATION, boss, \"origin\") )\r\n        call GroupEnumUnitsInRange( g, GetUnitX( boss ), GetUnitY( boss ), BLUE_AREA_RANGE, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, boss, \"enemy\" ) then\r\n                call UnitDamageTarget(boss, u, BLUE_DAMAGE, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n\t    \r\n\t    call DestroyGroup( g )\r\n\t    set u = null\r\n\t    set g = null\r\n\tendfunction\r\n\t\r\n\tprivate function Green takes unit boss returns nothing\r\n\t\tlocal real heal = GREEN_HEAL * SpellPower_GetBossSpellPower()\r\n\t\tcall SetUnitState( boss, UNIT_STATE_LIFE, GetUnitState( boss, UNIT_STATE_LIFE) + heal )\r\n        call DestroyEffect( AddSpecialEffectTarget(GREEN_ANIMATION, boss, \"origin\") )\r\n\tendfunction\r\n\t\r\n\tprivate function execution takes nothing returns nothing\r\n\t\tlocal integer id = GetHandleId( GetExpiredTimer() )\r\n\t\tlocal unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"mp_crystal_delay_boss\" ) )\r\n\t\tlocal unit crystal = LoadUnitHandle( udg_hash, id, StringHash( \"mp_crystal_delay_crystal\" ) )\r\n\t\tlocal integer crystalType = LoadInteger( udg_hash, id, StringHash( \"mp_crystal_delay_type\" ) )\r\n\t\r\n\t\tcall FlushChildHashtable( udg_hash, id )\r\n\t\tif IsUnitDeadBJ(crystal) or crystal == null or IsUnitDeadBJ(boss) then\r\n\t\t\treturn\r\n\t\tendif\r\n\t    \r\n\t    if crystalType == 1 then\r\n    \t \tcall Red(boss)\r\n    \t elseif crystalType == 2 then\r\n    \t \tcall Green(boss)\r\n    \t elseif crystalType == 3 then\r\n    \t \tcall Blue(boss)\r\n    \t endif\r\n\t\r\n\t\tcall KillUnit(crystal)\r\n        \r\n\t    set crystal = null\r\n\t    set boss = null\r\n    endfunction\r\n    \r\n    private function SetColor takes unit crystal, integer crystalType returns nothing\r\n    \t if crystalType == 1 then\r\n    \t \tcall SetUnitVertexColor(crystal, 255, COLOR_SATURATION, COLOR_SATURATION, 255)\r\n    \t elseif crystalType == 2 then\r\n    \t \tcall SetUnitVertexColor(crystal, COLOR_SATURATION, 255, COLOR_SATURATION, 255)\r\n    \t elseif crystalType == 3 then\r\n    \t \tcall SetUnitVertexColor(crystal, COLOR_SATURATION, COLOR_SATURATION, 255, 255)\r\n    \t endif\r\n    endfunction\r\n    \r\n    public function CreateCrystal takes unit boss returns nothing\r\n    \tlocal integer id\r\n    \tlocal unit crystal\r\n\t    local location spawnPoint\r\n\t    local integer crystalType\r\n    \r\n    \tset spawnPoint = PolarProjectionBJ(GetUnitLoc(boss), UNIT_SPAWN_DEVIATION, GetRandomDirectionDeg())\r\n        set crystal = CreateUnitAtLoc( GetOwningPlayer(boss), UNIT_ID, spawnPoint, bj_UNIT_FACING)\r\n        set crystalType = GetRandomInt(1, 3)\r\n        call SetColor(crystal, crystalType)\r\n        call DestroyEffect( AddSpecialEffect( SPAWN_ANIMATION, GetUnitX( crystal ), GetUnitY( crystal ) ) )\r\n        \r\n        set id = GetHandleId( crystal )\r\n        if LoadTimerHandle( udg_hash, id, StringHash( \"mp_crystal_delay\" ) ) == null then\r\n\t        call SaveTimerHandle( udg_hash, id, StringHash( \"mp_crystal_delay\" ), CreateTimer() )\r\n\t    endif\r\n\t\tset id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"mp_crystal_delay\" ) ) ) \r\n\t    call SaveUnitHandle( udg_hash, id, StringHash( \"mp_crystal_delay_crystal\" ), crystal )\r\n\t    call SaveUnitHandle( udg_hash, id, StringHash( \"mp_crystal_delay_boss\" ), boss )\r\n\t    call SaveInteger( udg_hash, id, StringHash( \"mp_crystal_delay_type\" ), crystalType )\r\n\t\tcall TimerStart( LoadTimerHandle( udg_hash, GetHandleId( crystal ), StringHash( \"mp_crystal_delay\" ) ), DELAY, false, function execution )\r\n\t\t\r\n\t\tset spawnPoint = null\r\n\t\tset crystal = null\r\n    endfunction\r\n\t\r\n\tprivate function spawn takes nothing returns nothing\r\n\t    local integer id = GetHandleId( GetExpiredTimer() )\r\n\t    local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"mp_crystal\" ) )\r\n\t    \r\n\t    if GetUnitState( boss, UNIT_STATE_LIFE) <= 0.405 or not( udg_fightmod[0] ) then\r\n\t    \tcall FlushChildHashtable( udg_hash, id )\r\n\t        call DestroyTimer( GetExpiredTimer() )\r\n\t    else\r\n\t    \tcall CreateCrystal(boss)\r\n\t    endif\r\n\r\n\t    set boss = null\r\n\tendfunction\r\n\t\r\n\tprivate function action takes nothing returns nothing\r\n\t    local integer id = GetHandleId( udg_DamageEventTarget )\r\n\t\r\n\t    call DisableTrigger( GetTriggeringTrigger() )\r\n\t\r\n\t    if LoadTimerHandle( udg_hash, id, StringHash( \"mp_crystal\" ) ) == null then\r\n\t        call SaveTimerHandle( udg_hash, id, StringHash( \"mp_crystal\" ), CreateTimer() )\r\n\t    endif\r\n\t\tset id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"mp_crystal\" ) ) ) \r\n\t    call SaveUnitHandle( udg_hash, id, StringHash( \"mp_crystal\" ), udg_DamageEventTarget )\r\n\t\tcall TimerStart( LoadTimerHandle( udg_hash, GetHandleId( udg_DamageEventTarget ), StringHash( \"mp_crystal\" ) ), bosscast(COOLDOWN), true, function spawn )\r\n\tendfunction\r\n\t\r\n\t//===========================================================================\r\n\tprivate function init takes nothing returns nothing\r\n\t    set gg_trg_MoonPriest1 = CreateTrigger(  )\r\n\t    call DisableTrigger( gg_trg_MoonPriest1 )\r\n\t    call TriggerRegisterVariableEvent( gg_trg_MoonPriest1, \"udg_AfterDamageEvent\", EQUAL, 1.00 )\r\n\t    call TriggerAddCondition( gg_trg_MoonPriest1, Condition( function condition ) )\r\n\t    call TriggerAddAction( gg_trg_MoonPriest1, function action )\r\n\tendfunction\r\n\r\nendscope\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}