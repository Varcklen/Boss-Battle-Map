{
  "Id": 50333489,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope Ogre initializer init\r\n\r\n    globals\r\n        private constant integer ID_BOSS = 'h001'\r\n        private constant integer ID_BOSS_AWAKEN = 'h002'\r\n        private constant integer ID_CHARGE_ANIMATION = 'A06Z'\r\n        private constant integer ID_CHARGE_ANIMATION_BUFF = 'B019'\r\n        \r\n        private constant integer HEALTH_CHECK = 40\r\n        private constant integer BOSS_AWAKE_DELAY = 2\r\n        \r\n        private constant integer CHARGE_TICK = 1\r\n        private constant integer CHARGE_TIME = 2\r\n        private constant integer CHARGE_COOLDOWN = 10\r\n        private constant real TICK = 0.04\r\n        private constant integer FLIGHT_LENGTH = 32\r\n        private constant integer DAMAGE = 200\r\n        private constant integer SPEED = 42\r\n        private constant integer AREA = 128\r\n        \r\n        \r\n        private constant string AWAKE_ANIMATION = \"Abilities\\\\Spells\\\\NightElf\\\\BattleRoar\\\\RoarCaster.mdl\"\r\n        private constant string WAVE_ANIMATION = \"Abilities\\\\Spells\\\\Orc\\\\Shockwave\\\\ShockwaveMissile.mdl\"\r\n        private constant string AWAKE_DEALY_ANIMATION = \"Abilities\\\\Spells\\\\Other\\\\TalkToMe\\\\TalkToMe\"\r\n        \r\n    endglobals\r\n\r\n    private function Trig_Ogre1_Conditions takes nothing returns boolean\r\n        return GetUnitTypeId( udg_DamageEventTarget ) == ID_BOSS and GetUnitLifePercent(udg_DamageEventTarget) <= HEALTH_CHECK\r\n    endfunction\r\n\r\n    private function DealDamage takes unit boss, effect wave, group nodmg returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n    \r\n        call GroupEnumUnitsInRange( g, BlzGetLocalSpecialEffectX( wave ), BlzGetLocalSpecialEffectY( wave ), AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, boss, \"enemy\" ) and IsUnitInGroup( u, nodmg ) == false then\r\n                call UnitDamageTarget( boss, u, DAMAGE, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )\r\n                call GroupAddUnit( nodmg, u )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n    \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set g = null\r\n        set nodmg = null\r\n        set u = null\r\n        set boss = null\r\n        set wave = null\r\n    endfunction\r\n\r\n    private function OgreWave takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer counter = LoadInteger( udg_hash, id, StringHash( \"bsog3\" ) ) + 1\r\n        local effect wave = LoadEffectHandle( udg_hash, id, StringHash( \"bsog3\" ) )\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"bsog3b\" ) )\r\n        local group nodmg = LoadGroupHandle( udg_hash, id, StringHash( \"bsog3g\" ) )\r\n        local real angle = LoadReal( udg_hash, id, StringHash( \"bsog3\" ) )\r\n        local location newPoint = null\r\n\r\n        if counter >= FLIGHT_LENGTH or wave == null then\r\n            call DestroyEffect( wave )\r\n            call DestroyGroup( nodmg )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            set newPoint = LocationSystem_GetMovedEffect( wave, angle, SPEED )\r\n            call BlzSetSpecialEffectPositionLoc( wave, newPoint )\r\n            call DealDamage( boss, wave, nodmg )\r\n            call SaveInteger( udg_hash, id, StringHash( \"bsog3\" ), counter )\r\n        endif\r\n\r\n        call RemoveLocation(newPoint)\r\n        set newPoint = null\r\n        set wave = null\r\n        set boss = null\r\n        set nodmg = null\r\n    endfunction\r\n    \r\n    private function CreateWave takes unit boss returns nothing\r\n        local unit target\r\n        local effect wave\r\n        local real angle\r\n        local integer id\r\n    \r\n        set wave = AddSpecialEffect( WAVE_ANIMATION, GetUnitX(boss), GetUnitY(boss))\r\n        set angle = GetUnitFacing(boss)\r\n        call BlzSetSpecialEffectYaw( wave, Deg2Rad(angle) )\r\n        \r\n        set id = InvokeTimerWithEffect( wave, \"bsog3\", TICK, true, function OgreWave )\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"bsog3b\" ), boss )\r\n        call SaveReal( udg_hash, id, StringHash( \"bsog3\" ), angle )\r\n        call SaveGroupHandle( udg_hash, id, StringHash( \"bsog3g\" ), CreateGroup() )\r\n        \r\n        call IssueImmediateOrder( boss, \"stop\" )\r\n        call SetUnitAnimation( boss, \"attack slam\" )\r\n        set target = randomtarget( boss, 600, \"enemy\", \"\", \"\", \"\", \"\" )\r\n        if target == null then\r\n            call aggro( boss )\r\n        endif\r\n    \r\n        set wave = null\r\n        set boss = null\r\n        set target = null\r\n    endfunction\r\n\r\n    private function OgreEnd takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer counter = LoadInteger( udg_hash, id, StringHash( \"bsog2\" ) ) + 1\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"bsog2\" ) )\r\n        \r\n        if counter >= CHARGE_TIME then\r\n            if IsUnitAlive(boss) and udg_fightmod[0] then\r\n                call pausest( boss, -1 )\r\n                call UnitRemoveAbility( boss, ID_CHARGE_ANIMATION)\r\n                call UnitRemoveAbility( boss, ID_CHARGE_ANIMATION_BUFF)\r\n                \r\n                call CreateWave(boss)\r\n            endif\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            call SaveInteger( udg_hash, id, StringHash( \"bsog2\" ), counter )\r\n            if IsUnitAlive(boss) then\r\n                call SetUnitAnimation( boss, \"spell\" )\r\n            endif\r\n        endif\r\n        \r\n        set boss = null\r\n    endfunction\r\n\r\n    private function OgreCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"bsog1\" ) )\r\n        \r\n        if IsUnitDead(boss) or udg_fightmod[0] == false then\r\n            call DestroyTimer( GetExpiredTimer() )\r\n            call FlushChildHashtable( udg_hash, id )\r\n        else\r\n            call pausest( boss, 1 )\r\n            call SetUnitAnimation( boss, \"spell\" )\r\n            call UnitAddAbility( boss, ID_CHARGE_ANIMATION )\r\n            \r\n            call InvokeTimerWithUnit(boss, \"bsog2\", CHARGE_TICK, true, function OgreEnd)\r\n        endif\r\n        \r\n        set boss = null\r\n    endfunction\r\n    \r\n    private function Awake takes nothing returns nothing\r\n    \tlocal integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit boss = LoadUnitHandle( udg_hash, id, StringHash( \"boss_ogre_awake_delay\" ) )\r\n    \tlocal unit new = null\r\n        local real hp = GetUnitState( boss, UNIT_STATE_LIFE )\r\n        local effect particle = LoadEffectHandle( udg_hash, id, StringHash( \"boss_ogre_awake_delay_particle\" ) )\r\n        \r\n        call FlushChildHashtable( udg_hash, id )\r\n        call DestroyEffect(particle)\r\n        \r\n        call ShowUnit( boss, false)\r\n        set new = CreateUnit(GetOwningPlayer(boss), ID_BOSS_AWAKEN, GetUnitX(boss), GetUnitY(boss), GetUnitFacing(boss))\r\n        call SaveUnitHandle( udg_hash, GetHandleId( LoadTimerHandle( udg_hash, GetHandleId( boss ), StringHash( \"aggro\" ) ) ) , StringHash( \"aggro\" ), new )\r\n        call SetUnitState( new, UNIT_STATE_LIFE, hp )\r\n        call GroupRemoveUnit( udg_Bosses, boss )\r\n\r\n        if bossbar == boss then\r\n            set bossbar = new\r\n        endif\r\n        if bossbar1 == boss then\r\n            set bossbar1 = new\r\n        endif\r\n        \r\n        call BlzSetUnitBaseDamage( new, BlzGetUnitBaseDamage(boss, 0), 0 )\r\n        call BlzSetUnitArmor( new, BlzGetUnitArmor(boss) )\r\n        call RemoveUnit(boss)\r\n        \r\n        call PlaySpecialEffect(AWAKE_ANIMATION, new)\r\n        \r\n        call dummyspawn( new, 1, 'A0H6', 0, 0 )\r\n        call IssueImmediateOrder( bj_lastCreatedUnit, \"stomp\" )\r\n\r\n        if GetOwningPlayer(new) != Player(10) then\r\n            call UnitApplyTimedLife( new, 'BTLF', 20 )\r\n        endif\r\n        \r\n        call InvokeTimerWithUnit(new, \"bsog1\", bosscast(CHARGE_COOLDOWN), true, function OgreCast)\r\n\r\n        set new = null\r\n        set boss = null\r\n        set particle = null\r\n    endfunction\r\n\r\n    function Trig_Ogre1_Actions takes nothing returns nothing\r\n        local unit boss = udg_DamageEventTarget\r\n        local effect particle\r\n        local integer id\r\n\r\n        call DisableTrigger( GetTriggeringTrigger() )\r\n        \r\n        set particle = AddSpecialEffectTarget(AWAKE_DEALY_ANIMATION, boss, \"overhead\")\r\n        \r\n        set id = InvokeTimerWithUnit(boss, \"boss_ogre_awake_delay\", BOSS_AWAKE_DELAY, false, function Awake)\r\n        call SaveEffectHandle( udg_hash, id, StringHash( \"boss_ogre_awake_delay_particle\" ), particle )\r\n\r\n        set boss = null\r\n        set particle = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_Ogre1 = CreateEventTrigger( \"udg_AfterDamageEvent\", function Trig_Ogre1_Actions, function Trig_Ogre1_Conditions )\r\n        call DisableTrigger( gg_trg_Ogre1 )\r\n    endfunction\r\nendscope\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}