{
  "Id": 50332105,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "library BattleRessurectLib initializer init requires CommonTimer, DeathLib, DeathSystem, Trigger, Conditions\r\n\r\n    globals\r\n        constant integer RESSURECTION_DURATION = 3\r\n        \r\n        private constant integer INVUL_DURATION = 2\r\n        private constant integer INVUL_BUFF_ID = 'A1FR'\r\n        \r\n        private group UnderRessurection = CreateGroup()\r\n        \r\n        private boolean IsNotificationDisabled = false\r\n    endglobals\r\n\r\n\tpublic function IsAnyUnderRessurection takes nothing returns boolean\r\n\t\treturn IsUnitGroupEmptyBJ( UnderRessurection ) == false\r\n\tendfunction\r\n\r\n\tprivate function InvulEnd takes nothing returns nothing\r\n\t\tlocal integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit hero = LoadUnitHandle( udg_hash, id, StringHash( \"battle_res_invul\" ) )\r\n        \r\n        call UnitRemoveAbility(hero, INVUL_BUFF_ID)\r\n        call UnitRemoveAbility(hero, 'A1FS')\r\n        call UnitRemoveAbility(hero, 'B01C')\r\n        call FlushChildHashtable( udg_hash, id )\r\n        \r\n        set hero = null\r\n\tendfunction\r\n\r\n    private function BattleRessurectEnd takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"btrs1\" ) )\r\n        local player owner = GetOwningPlayer(target)\r\n        local real setPercent = LoadReal( udg_hash, id, StringHash( \"btrs1\" ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"btrs1c\" ) )\r\n        local real x = LoadReal( udg_hash, id, StringHash( \"btrs1x\" ) )\r\n        local real y = LoadReal( udg_hash, id, StringHash( \"btrs1y\" ) )\r\n\r\n        if combat(target, false, 0) and IsUnitDead(target) and target != null then\r\n            call ReviveHero( target, x, y, true )\r\n            call ShowUnitShow( target )\r\n            call PanCameraToTimedForPlayer( owner, GetUnitX(target), GetUnitY(target), 0.25 )\r\n            call SelectUnitForPlayerSingle( target, GetOwningPlayer( target ) )\r\n            \r\n            if IsUnitDead(target) then\r\n                call BJDebugMsg(\"Error! BattleRessurectLib - BattleRessurectEnd: The hero could not be resurrected.\")\r\n            endif\r\n            if setPercent < 1 or setPercent > 100 then\r\n            \tcall BJDebugMsg(\"Error! BattleRessurectLib - BattleRessurectEnd: setPercent is less than 0 or more than 100. Current: \" + R2S(setPercent))\r\n            \tset setPercent = 50\r\n            endif\r\n            set setPercent = setPercent * 0.01\r\n            \r\n            //call DeathSystem_BattleRessurect_Add(u)\r\n            call PauseUnit( target, false )\r\n            call SetUnitState( target, UNIT_STATE_LIFE, GetUnitState( target, UNIT_STATE_MAX_LIFE) * setPercent )\r\n            call SetUnitState( target, UNIT_STATE_MANA, GetUnitState( target, UNIT_STATE_MAX_MANA) * setPercent )\r\n            call UnitRemoveAbility(target, 'A19D')\r\n            \r\n            //Temporary Invul\r\n            call UnitAddAbility(target, INVUL_BUFF_ID)\r\n            call UnitAddAbility(target, 'A1FS')\r\n            call InvokeTimerWithUnit( target, \"battle_res_invul\", INVUL_DURATION, false, function InvulEnd )\r\n        endif\r\n        \r\n        call FlushChildHashtable( udg_hash, id )\r\n        set target = null\r\n        set caster = null\r\n        set owner = null\r\n    endfunction\r\n\r\n    private function BattleRessurectExecute takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"btrs\" ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"btrsc\" ) )\r\n        local integer id1 = GetHandleId( target )\r\n        local real setPercent = LoadInteger( udg_hash, id, StringHash( \"btrslvl\" ) )\r\n        local player p = GetOwningPlayer( target )\r\n        local boolean isNotificationActive = LoadBoolean(udg_hash, id, StringHash( \"btrsn\" ) )\r\n\r\n        if combat( caster, false, 0) then\r\n        \tif isNotificationActive == false then\r\n\t            if GetLocalPlayer() == p then\r\n\t                call StartSound(gg_snd_Warning)\r\n\t            endif\r\n\t            call DisplayTimedTextToPlayer( p, 0, 0, 5, \"|cffffcc00WARNING!|r Your hero will be resurrected.\" )\r\n            endif\r\n            \r\n            call UnitAddAbility(target, 'A19D')\r\n\r\n            set bj_lastCreatedUnit = CreateUnit( Player( PLAYER_NEUTRAL_PASSIVE ), 'u000', GetUnitX( caster ), GetUnitY( caster ), 270 )\r\n            call UnitApplyTimedLife( bj_lastCreatedUnit, 'BTLF', RESSURECTION_DURATION )\r\n            call DestroyEffect( AddSpecialEffectTarget( \"Abilities\\\\Spells\\\\Human\\\\Resurrect\\\\ResurrectCaster.mdl\",  bj_lastCreatedUnit, \"origin\" ) )\r\n            \r\n            set id1 = InvokeTimerWithUnit( target, \"btrs1\", RESSURECTION_DURATION, false, function BattleRessurectEnd )\r\n            call SaveUnitHandle( udg_hash, id1, StringHash( \"btrs1c\" ), caster )\r\n            call SaveReal( udg_hash, id1, StringHash( \"btrs1\" ), setPercent )\r\n            call SaveReal( udg_hash, id1, StringHash( \"btrs1x\" ), GetUnitX( caster ) )\r\n            call SaveReal( udg_hash, id1, StringHash( \"btrs1y\" ), GetUnitY( caster ) )\r\n        endif\r\n\r\n        call FlushChildHashtable( udg_hash, id )\r\n\r\n        set target = null\r\n        set caster = null\r\n        set p = null\r\n    endfunction \r\n\r\n\tpublic function DisableNextNotification takes nothing returns nothing\r\n\t\tset IsNotificationDisabled = true\r\n\tendfunction\r\n\r\n    function ResInBattle takes unit caster, unit target, integer perc returns nothing\r\n        local integer id \r\n\r\n        if target != null or IsUnitHasAbility( target, 'A19D') then\r\n            if perc > 100 then\r\n                set perc = 100\r\n            elseif perc < 1 then\r\n                set perc = 1\r\n            endif\r\n            call DeathSystem_BattleRessurect_Remove(target)\r\n            call GroupAddUnit( UnderRessurection, target )\r\n            \r\n            set id = InvokeTimerWithUnit( target, \"btrs\", 0.01, false, function BattleRessurectExecute )\r\n            call SaveUnitHandle( udg_hash, id, StringHash( \"btrsc\" ), caster )\r\n            call SaveInteger( udg_hash, id, StringHash( \"btrslvl\" ), perc )\r\n            call SaveBoolean(udg_hash, id, StringHash( \"btrsn\" ), IsNotificationDisabled)\r\n        endif\r\n        set IsNotificationDisabled = false\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function action_revive takes nothing returns nothing\r\n    \tcall GroupRemoveUnit( UnderRessurection, GetRevivingUnit() )\r\n    endfunction\r\n    \r\n    private function init takes nothing returns nothing\r\n\t\tcall CreateNativeEvent( EVENT_PLAYER_HERO_REVIVE_FINISH, function action_revive, null )\r\n\tendfunction\r\nendlibrary",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}