{
  "Id": 50333169,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "globals\r\n    constant real MEAT_WAGON_R_GOLD_DISCOUNT = 0.8\r\nendglobals\r\n\r\nfunction Trig_WagonR_Conditions takes nothing returns boolean\r\n    return GetSpellAbilityId() == 'A0OY' and not(udg_fightmod[3]) and combat( GetSpellAbilityUnit(), false, 0 )\r\nendfunction\r\n\r\nfunction WagonRCast takes nothing returns nothing\r\n    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n    local unit dummy = LoadUnitHandle( udg_hash, id, StringHash( \"mwgr\" ) )\r\n    local real dmg = LoadReal( udg_hash, id, StringHash( \"mwgrdmg\" ) )\r\n    local real x = LoadReal( udg_hash, id, StringHash( \"mwgrx\" ) )\r\n    local real y = LoadReal( udg_hash, id, StringHash( \"mwgry\" ) )\r\n    local integer gold = LoadInteger( udg_hash, id, StringHash( \"mwgrg\" ) )\r\n    local real xc = GetUnitX( dummy )\r\n    local real yc = GetUnitY( dummy )\r\n    local integer counter = LoadInteger( udg_hash, id, StringHash( \"mwgr\" ) ) + 1\r\n    local real angle = Atan2( y - yc, x - xc )\r\n    local real NewX = xc + 20 * Cos( angle )\r\n    local real NewY = yc + 20 * Sin( angle )\r\n    local group g = CreateGroup()\r\n    local unit u\r\n    local real dist = LoadReal( udg_hash, id, StringHash( \"mwgrd\" ) )\r\n    local real IfX = ( x - xc ) * ( x - xc )\r\n    local real IfY = ( y - yc ) * ( y - yc )\r\n    local real IfS = SquareRoot( IfX + IfY )\r\n    local real perc = (IfS * 100)/dist\r\n    local boolean l = LoadBoolean( udg_hash, id, StringHash( \"mwgr\" ))\r\n    local integer cyclA\r\n\r\n    if perc <= 50 and not(l) then\r\n        call SetUnitFlyHeight( dummy, -400, 1000 )\r\n        call SaveBoolean( udg_hash, id, StringHash( \"mwgr\" ), true )\r\n    endif\r\n\r\n    if IfS < 100 or GetUnitState( dummy, UNIT_STATE_LIFE) <= 0.405 then\r\n        if GetUnitState( dummy, UNIT_STATE_LIFE) > 0.405 then\r\n            call DestroyEffect( AddSpecialEffect( \"Abilities\\\\Weapons\\\\MeatwagonMissile\\\\MeatwagonMissile.mdl\", x, y ) )\r\n            call GroupEnumUnitsInRange( g, x, y, 300, null )\r\n            loop\r\n                set u = FirstOfGroup(g)\r\n                exitwhen u == null\r\n                if unitst( u, dummy, \"enemy\" ) then\r\n                    call UnitDamageTarget(dummy, u, dmg, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)\r\n                endif\r\n                call GroupRemoveUnit(g,u)\r\n                set u = FirstOfGroup(g) \r\n            endloop\r\n        endif\r\n        set gold  = R2I(gold * MEAT_WAGON_R_GOLD_DISCOUNT)\r\n        set cyclA = 1\r\n        loop\r\n            exitwhen cyclA > 1\r\n            if gold >= 500 then\r\n                set gold = gold - 500\r\n                set bj_lastCreatedItem = CreateItem( 'I04Q', x+GetRandomReal(-300, 300), y+GetRandomReal(-300, 300) )\r\n                if not( RectContainsItem( bj_lastCreatedItem, udg_Boss_Rect) ) then\r\n                    call SetItemPositionLoc( bj_lastCreatedItem, GetRectCenter( udg_Boss_Rect ) )\r\n                endif\r\n                set cyclA = cyclA - 1\r\n            elseif gold >= 100 then\r\n                set gold = gold - 100\r\n                set bj_lastCreatedItem = CreateItem( 'I04P', x+GetRandomReal(-300, 300), y+GetRandomReal(-300, 300) )\r\n                if not( RectContainsItem( bj_lastCreatedItem, udg_Boss_Rect) ) then\r\n                    call SetItemPositionLoc( bj_lastCreatedItem, GetRectCenter( udg_Boss_Rect ) )\r\n                endif\r\n                set cyclA = cyclA - 1\r\n            elseif gold >= 50 then\r\n                set gold = gold - 50\r\n                set bj_lastCreatedItem = CreateItem( 'I04J', x+GetRandomReal(-300, 300), y+GetRandomReal(-300, 300) )\r\n                if not( RectContainsItem( bj_lastCreatedItem, udg_Boss_Rect) ) then\r\n                    call SetItemPositionLoc( bj_lastCreatedItem, GetRectCenter( udg_Boss_Rect ) )\r\n                endif\r\n                set cyclA = cyclA - 1\r\n            elseif gold >= 10 then\r\n                set gold = gold - 10\r\n                set bj_lastCreatedItem = CreateItem( 'I02U', x+GetRandomReal(-300, 300), y+GetRandomReal(-300, 300) )\r\n                if not( RectContainsItem( bj_lastCreatedItem, udg_Boss_Rect) ) then\r\n                    call SetItemPositionLoc( bj_lastCreatedItem, GetRectCenter( udg_Boss_Rect ) )\r\n                endif\r\n                set cyclA = cyclA - 1\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        call RemoveUnit(dummy)\r\n        call FlushChildHashtable( udg_hash, id ) \r\n        call DestroyTimer( GetExpiredTimer() )\r\n    else\r\n        call SaveInteger( udg_hash, id, StringHash( \"mwgr\" ), counter )\r\n        call SetUnitPosition( dummy, NewX, NewY )\r\n    endif\r\n    \r\n    call GroupClear( g )\r\n    call DestroyGroup( g )\r\n    set u = null\r\n    set g = null\r\n    set dummy = null\r\nendfunction\r\n\r\nfunction Trig_WagonR_Actions takes nothing returns nothing\r\n    local integer id \r\n    local integer lvl\r\n    local unit caster\r\n    local unit target\r\n    local real dmg\r\n    local real x\r\n    local real y\r\n    local real dist\r\n    local real dx\r\n    local real dy\r\n    local integer g\r\n    \r\n    if CastLogic() then\r\n        set caster = udg_Caster\r\n        set target = udg_Target\r\n        set lvl = udg_Level\r\n    elseif RandomLogic() then\r\n        set caster = udg_Caster\r\n        set target = randomtarget( caster, 900, \"enemy\", \"\", \"\", \"\", \"\" )\r\n        set lvl = udg_Level\r\n        call textst( udg_string[0] + GetObjectName('A0OY'), caster, 64, 90, 10, 1.5 )\r\n        if target == null then\r\n            set caster = null\r\n            return\r\n        endif\r\n    else\r\n        set caster = GetSpellAbilityUnit()\r\n        set target = GetSpellTargetUnit()\r\n        set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n    endif\r\n    \r\n    call dummyspawn( caster, 0, 'A0PA', 0, 0 )\r\n    call UnitAddAbility(bj_lastCreatedUnit, 'Amrf')\r\n    \r\n    set g = R2I(0.4 * GetPlayerState( GetOwningPlayer( caster ), PLAYER_STATE_RESOURCE_GOLD))\r\n    set dmg = g*(0.75+(0.25*lvl))\r\n\tset x = GetUnitX(target)\r\n    set y = GetUnitY(target)\r\n    set dx = x - GetUnitX(bj_lastCreatedUnit)\r\n    set dy = y - GetUnitY(bj_lastCreatedUnit)\r\n    set dist = SquareRoot(dx * dx + dy * dy)\r\n\r\n    call SetUnitFlyHeight( bj_lastCreatedUnit, 400, 1000 )\r\n    \r\n    set id = GetHandleId( bj_lastCreatedUnit )\r\n    if LoadTimerHandle( udg_hash, id, StringHash( \"mwgr\" ) ) == null then\r\n        call SaveTimerHandle( udg_hash, id, StringHash( \"mwgr\" ), CreateTimer() )\r\n    endif\r\n    set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"mwgr\" ) ) )\r\n    call SaveUnitHandle( udg_hash, id, StringHash( \"mwgr\" ), bj_lastCreatedUnit)\r\n    call SaveReal( udg_hash, id, StringHash( \"mwgrx\" ), x )\r\n    call SaveReal( udg_hash, id, StringHash( \"mwgry\" ), y )\r\n    call SaveReal( udg_hash, id, StringHash( \"mwgrd\" ), dist)\r\n    call SaveReal( udg_hash, id, StringHash( \"mwgrdmg\" ), dmg)\r\n    call SaveInteger( udg_hash, id, StringHash( \"mwgrg\" ), g)\r\n    call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( bj_lastCreatedUnit ), StringHash( \"mwgr\" ) ), 0.02, true, function WagonRCast )\r\n    \r\n    call SetPlayerState( GetOwningPlayer( caster ), PLAYER_STATE_RESOURCE_GOLD, IMaxBJ( 0, GetPlayerState( GetOwningPlayer( caster ), PLAYER_STATE_RESOURCE_GOLD) - g ) )\r\n\r\n    set caster = null\r\n    set target = null\r\nendfunction\r\n\r\n//===========================================================================\r\nfunction InitTrig_WagonR takes nothing returns nothing\r\n    set gg_trg_WagonR = CreateTrigger(  )\r\n    call TriggerRegisterAnyUnitEventBJ( gg_trg_WagonR, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n    call TriggerAddCondition( gg_trg_WagonR, Condition( function Trig_WagonR_Conditions ) )\r\n    call TriggerAddAction( gg_trg_WagonR, function Trig_WagonR_Actions )\r\nendfunction",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}