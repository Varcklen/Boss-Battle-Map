{
  "Id": 50333389,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope ThePlagueR initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A1CX'\r\n        \r\n        private constant integer DAMAGE_FIRST_LEVEL = 100\r\n        private constant integer DAMAGE_LEVEL_BONUS = 50\r\n        private constant integer STEP_SIZE = 150\r\n        \r\n        private constant real DAMAGE_BONUS_FIRST_LEVEL = 0.5\r\n        private constant real DAMAGE_BONUS_LEVEL_BONUS = 0.2\r\n        \r\n        private constant string ANIMATION = \"war3mapImported\\\\Soul Discharge.mdx\"\r\n        private constant string LIGHTNING = \"DNKL\"\r\n    endglobals\r\n\r\n    function Trig_The_PlagueR_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n    \r\n    private function DestroyLight takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        call DestroyLightning( LoadLightningHandle( udg_hash, id, StringHash( \"light\" ) ) )\r\n        call FlushChildHashtable( udg_hash, id )\r\n    endfunction\r\n    \r\n    private function CreateLightning takes unit caster, unit target returns nothing\r\n        local lightning light\r\n        local integer id\r\n        \r\n        call PlaySpecialEffect(ANIMATION, target)\r\n        set light = AddLightningEx(LIGHTNING, true, GetUnitX(caster), GetUnitY(caster), GetUnitFlyHeight(caster) + 50, GetUnitX(target), GetUnitY(target), GetUnitFlyHeight(target) + 50 )\r\n        set id = GetHandleId( light )\r\n        call SaveTimerHandle( udg_hash, id, StringHash( \"light\" ), CreateTimer() )\r\n        set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"light\" ) ) ) \r\n        call SaveLightningHandle( udg_hash, id, StringHash( \"light\" ), light )\r\n        call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( light ), StringHash( \"light\" ) ), 0.5, false, function DestroyLight )\r\n    \r\n        set light = null\r\n        set target = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function UseLightning takes unit caster, group units, real damage, real bonus returns nothing\r\n        local unit u\r\n        local real bonusDamage\r\n        \r\n        loop\r\n            set u = FirstOfGroup(units)\r\n            exitwhen u == null\r\n            call CreateLightning(caster, u)\r\n            \r\n            set bonusDamage = 1\r\n            if IsUnitHasAbility( u, ThePlagueE_BUFF) then\r\n                set bonusDamage = bonusDamage + bonus\r\n            endif\r\n            if IsUnitHasAbility( u, ThePlagueW_EFFECT) then\r\n                set bonusDamage = bonusDamage + bonus\r\n            endif\r\n            call UnitTakeDamage(caster, u, damage*bonusDamage, DAMAGE_TYPE_MAGIC)\r\n            call GroupRemoveUnit(units,u)\r\n        endloop\r\n    \r\n        set u = null\r\n        set units = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function AddToGroup takes unit caster, group units, real x, real y returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        \r\n        call GroupEnumUnitsInRange( g, x, y, STEP_SIZE*2, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, \"enemy\" ) and IsUnitInGroup( u, units ) == false then\r\n                call GroupAddUnit( units, u )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n    \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set units = null\r\n        set caster = null\r\n    endfunction\r\n\r\n    private function AddUnitsToGroup takes unit caster, real x, real y, real damage, real bonus returns nothing\r\n        local group units = CreateGroup()\r\n        local Math_point newPoint = 0\r\n        local Math_point casterPoint = Math_point.create()\r\n        local Math_point targetPoint = Math_point.create()\r\n        local real distance\r\n        local real angle\r\n        local integer i\r\n        local integer iEnd\r\n        \r\n        call casterPoint.Set(GetUnitX( caster ), GetUnitY( caster ))\r\n        call targetPoint.Set(x, y)\r\n        set distance = DistanceBetweenCustomPoints(casterPoint, targetPoint)\r\n        set angle = Deg2Rad(GetAngleBetweenPoints(targetPoint, casterPoint))\r\n\r\n        call newPoint.SetFromPoint(casterPoint)\r\n        set i = 1\r\n        set iEnd = R2I(distance/STEP_SIZE) + 1\r\n        loop\r\n            exitwhen i > iEnd\r\n            set newPoint = GetMovedPointByPoint( newPoint, angle, STEP_SIZE )\r\n            call AddToGroup( caster, units, newPoint.x, newPoint.y)\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        call UseLightning(caster, units, damage, bonus)\r\n        \r\n        call casterPoint.destroy()\r\n        call targetPoint.destroy()\r\n        call newPoint.destroy()\r\n        call GroupClear( units )\r\n        call DestroyGroup( units )\r\n        set caster = null\r\n        set units = null\r\n    endfunction\r\n\r\n    function Trig_The_PlagueR_Actions takes nothing returns nothing\r\n        local unit caster\r\n        local integer level\r\n        local real x\r\n        local real y\r\n        local real damage\r\n        local real bonus\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Target\r\n            set level = udg_Level\r\n            set x = GetLocationX( GetSpellTargetLoc() )\r\n            set y = GetLocationY( GetSpellTargetLoc() )\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set level = udg_Level\r\n            set x = GetUnitX( caster ) + GetRandomReal( -650, 650 )\r\n            set y = GetUnitY( caster ) + GetRandomReal( -650, 650 )\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set level = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set x = GetLocationX( GetSpellTargetLoc() )\r\n            set y = GetLocationY( GetSpellTargetLoc() )\r\n        endif\r\n        \r\n        set damage = DAMAGE_FIRST_LEVEL + (DAMAGE_LEVEL_BONUS * level)\r\n        set bonus = DAMAGE_BONUS_FIRST_LEVEL + (level*DAMAGE_BONUS_LEVEL_BONUS)\r\n        call AddUnitsToGroup(caster, x, y, damage, bonus )\r\n\r\n        set caster = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_The_PlagueR = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_The_PlagueR, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_The_PlagueR, Condition( function Trig_The_PlagueR_Conditions ) )\r\n        call TriggerAddAction( gg_trg_The_PlagueR, function Trig_The_PlagueR_Actions )\r\n    endfunction\r\n\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}