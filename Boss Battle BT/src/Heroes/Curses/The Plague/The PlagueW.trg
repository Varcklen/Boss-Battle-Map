{
  "Id": 50333387,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope ThePlagueW initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A1CU'\r\n        \r\n        private constant integer DURATION = 15\r\n        private constant integer DISTANCE = 200\r\n        private constant integer AREA = 300\r\n        private constant integer CHARGE_LIMIT = 10\r\n        private constant integer DAMAGE_NEEDED = 500\r\n        \r\n        public constant integer EFFECT = 'A1CV'\r\n        private constant integer BUFF = 'B0A9'\r\n        \r\n        private constant integer DAMAGE_FIRST_LEVEL = 75\r\n        private constant integer DAMAGE_LEVEL_BONUS = 25\r\n\r\n        private constant string ANIMATION = \"Abilities\\\\Spells\\\\Orc\\\\FeralSpirit\\\\feralspiritdone.mdl\"\r\n        private constant string DAMAGE_ANIMATION = \"Acid Ex.mdx\"\r\n    endglobals\r\n\r\n    function Trig_The_PlagueW_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n\r\n    private function Spike_End takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle(udg_hash, id, StringHash(\"tplw\"))\r\n        local integer unitId = GetHandleId(target)\r\n\r\n        call UnitRemoveAbility( target, EFFECT )\r\n        call UnitRemoveAbility( target, BUFF )\r\n        call RemoveSavedReal( udg_hash, unitId, StringHash( \"tplw\" ) )\r\n        call RemoveSavedInteger( udg_hash, unitId, StringHash( \"tplw\" ) )\r\n        call FlushChildHashtable( udg_hash, id )\r\n\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function Spike takes unit caster, real damage, real x, real y, real duration returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local integer id \r\n        local integer charges\r\n    \r\n        call GroupEnumUnitsInRange( g, x, y, AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, \"enemy\" ) then \r\n                set id = GetHandleId(u)\r\n                call PlaySpecialEffect(ANIMATION, u)\r\n                call UnitAddAbility( u, EFFECT )\r\n                call InvokeTimerWithUnit(u, \"tplw\", duration, false, function Spike_End)\r\n                set charges = IMinBJ(LoadInteger(udg_hash, id, StringHash(\"tplw\") ) + 1, CHARGE_LIMIT)\r\n                call SaveInteger(udg_hash, id, StringHash(\"tplw\"), charges )\r\n                call SaveReal(udg_hash, id, StringHash(\"tplwd\"), damage )\r\n                call SaveUnitHandle(udg_hash, id, StringHash(\"tplwc\"), caster )\r\n                call textst( \"|cFF57E5C6\" + I2S(charges), u, 64, 90, 12, 1 )\r\n                call RemoveSavedReal( udg_hash, id, StringHash( \"tplw\" ) )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_The_PlagueW_Actions takes nothing returns nothing\r\n        local real x \r\n        local real y\r\n        local real dmg\r\n        local integer lvl\r\n        local unit caster\r\n        local real duration\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            set duration = udg_Time\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n            set duration = DURATION\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId() )\r\n            set duration = DURATION\r\n        endif\r\n        \r\n        set duration = timebonus(caster, duration)\r\n        set dmg = DAMAGE_FIRST_LEVEL + ( DAMAGE_LEVEL_BONUS * lvl ) \r\n        set x = GetUnitX( caster ) + DISTANCE * Cos( 0.017 * GetUnitFacing( caster ) )\r\n        set y = GetUnitY( caster ) + DISTANCE * Sin( 0.017 * GetUnitFacing( caster ) )\r\n        \r\n        call Spike(caster, dmg, x, y, duration )   \r\n        \r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function AfterDamageEvent_Conditions takes nothing returns boolean\r\n        return IsUnitHasAbility(udg_DamageEventTarget, EFFECT) and udg_DamageEventAmount > 0\r\n    endfunction\r\n    \r\n    private function Damage takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle(udg_hash, id, StringHash(\"tplw1\"))\r\n        local unit dealer = LoadUnitHandle(udg_hash, id, StringHash(\"tplw1c\"))\r\n        local real damage = LoadReal(udg_hash, id, StringHash(\"tplw1d\") )\r\n\r\n        call UnitTakeDamage(dealer, target, damage, DAMAGE_TYPE_MAGIC)\r\n        call FlushChildHashtable( udg_hash, id )\r\n\r\n        set dealer = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function DealDamage takes unit target, integer unitId returns nothing\r\n        local real damage = LoadReal(udg_hash, unitId, StringHash(\"tplwd\") )\r\n        local integer charges = LoadInteger(udg_hash, unitId, StringHash(\"tplw\") )\r\n        local unit caster = LoadUnitHandle(udg_hash, unitId, StringHash(\"tplwc\") )\r\n        local integer id\r\n        \r\n        set id = InvokeTimerWithUnit(target, \"tplw1\", 0.01, false, function Damage )\r\n        call SaveUnitHandle(udg_hash, id, StringHash(\"tplw1c\"), caster )\r\n        call SaveReal(udg_hash, id, StringHash(\"tplw1d\"), damage*charges )\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function AfterDamageEvent takes nothing returns nothing\r\n        local unit target = udg_DamageEventTarget\r\n        local integer unitId = GetHandleId(target)\r\n        local real damageDealed = LoadReal(udg_hash, unitId, StringHash( \"tplw\" ) ) + udg_DamageEventAmount\r\n        local integer id\r\n\r\n        if damageDealed >= DAMAGE_NEEDED then\r\n            call DestroyEffect( AddSpecialEffect(DAMAGE_ANIMATION, GetUnitX(target), GetUnitY(target)))\r\n            call UnitRemoveAbility( target, EFFECT )\r\n            call UnitRemoveAbility( target, BUFF )\r\n            call DealDamage(target, unitId)\r\n            call RemoveSavedReal( udg_hash, unitId, StringHash( \"tplw\" ) )\r\n            call RemoveSavedInteger( udg_hash, unitId, StringHash( \"tplw\" ) )\r\n        else\r\n            call SaveReal(udg_hash, unitId, StringHash( \"tplw\" ), damageDealed )\r\n        endif\r\n        \r\n        set target = null\r\n    endfunction\r\n    \r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        local unit hero = Event_DeleteBuff_Unit\r\n\r\n        call UnitRemoveAbility( hero, EFFECT )\r\n        call UnitRemoveAbility( hero, BUFF )\r\n        call RemoveSavedReal( udg_hash, GetHandleId( hero ), StringHash( \"tplw\" ) )\r\n        call RemoveSavedInteger( udg_hash, GetHandleId( hero ), StringHash( \"tplw\" ) )\r\n        \r\n        set hero = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_The_PlagueW = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_The_PlagueW, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_The_PlagueW, Condition( function Trig_The_PlagueW_Conditions ) )\r\n        call TriggerAddAction( gg_trg_The_PlagueW, function Trig_The_PlagueW_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n        call CreateEventTrigger( \"udg_AfterDamageEvent\", function AfterDamageEvent, function AfterDamageEvent_Conditions )\r\n    endfunction\r\n\r\nendscope",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}