{
  "Id": 50333386,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope ThePlagueQ initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A1CS'\r\n        \r\n        private constant integer LIFE_TIME = 18\r\n        private constant integer AREA = 300\r\n        private constant real TICK = 0.04\r\n        private constant integer TICK_DAMAGE = 1\r\n        private constant integer FLIGHT_LIMIT = 200\r\n        private constant integer DISTANCE_TO_ACTIVATE = 50\r\n        private constant integer SPEED = 40\r\n        private constant integer WAVE_Z = 60\r\n        \r\n        private constant integer EFFECT = 'A1CT'\r\n        \r\n        public constant integer DAMAGE_FIRST_LEVEL = 2\r\n        public constant integer DAMAGE_LEVEL_BONUS = 8\r\n        \r\n        private constant string ORB_ANIMATION = \"Abilities\\\\Weapons\\\\GreenDragonMissile\\\\GreenDragonMissile.mdl\"\r\n        private constant string ANIMATION = \"Abilities\\\\Spells\\\\NightElf\\\\Blink\\\\BlinkTarget.mdl\"\r\n    endglobals\r\n\r\n    function Trig_The_PlagueQ_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n    \r\n    private function FogDamage takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit fog = LoadUnitHandle( udg_hash, id, StringHash( \"tplqf\" ) )\r\n        local real damage = LoadReal( udg_hash, id, StringHash( \"tplqfd\" ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"tplqfc\" ) )\r\n\r\n        if IsUnitDead(fog) then\r\n            call RemoveUnit( fog )\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            call GroupAoE(caster, GetUnitX( fog ), GetUnitY( fog ), damage, AREA, \"enemy\", null, null )\r\n        endif\r\n\r\n        set fog = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    public function CreatePoisonousFog takes unit caster, real damage, integer level, real x, real y, real duration returns nothing\r\n        local unit fog\r\n        local integer id1\r\n    \r\n        call DestroyEffect( AddSpecialEffect( ANIMATION, x, y ) )\r\n        set fog = CreateUnit( GetOwningPlayer( caster ), 'u000', x, y, 270 )\r\n        call UnitApplyTimedLife( fog , 'BTLF', duration)\r\n        call UnitAddAbility( fog , EFFECT)\r\n        call SetUnitAbilityLevel( fog , EFFECT, level )\r\n        \r\n        set id1 = InvokeTimerWithUnit(fog, \"tplqf\", TICK_DAMAGE, true, function FogDamage )\r\n        call SaveReal( udg_hash, id1, StringHash( \"tplqfd\" ), damage )\r\n        call SaveUnitHandle( udg_hash, id1, StringHash( \"tplqfc\" ), caster )\r\n        \r\n        set fog = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function CreateFog takes integer id, real x, real y returns nothing\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"tplqc\" ) )\r\n        local real damage = LoadReal( udg_hash, id, StringHash( \"tplqd\" ) )\r\n        local integer level = LoadInteger( udg_hash, id, StringHash( \"tplqlvl\" ) )\r\n        \r\n        call CreatePoisonousFog(caster, damage, level, x, y, LIFE_TIME)\r\n        \r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function WaveMove takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer counter = LoadInteger( udg_hash, id, StringHash( \"tplq\" ) ) + 1\r\n        local effect wave = LoadEffectHandle( udg_hash, id, StringHash( \"tplq\" ) )\r\n        local real angle = LoadReal( udg_hash, id, StringHash( \"tplq\" ) )\r\n        local real x = LoadReal( udg_hash, id, StringHash( \"tplqx\" ) )\r\n        local real y = LoadReal( udg_hash, id, StringHash( \"tplqy\" ) )\r\n        local location newPoint = null\r\n        local location endPoint = Location(x, y)\r\n        local location wavePoint = Location(BlzGetLocalSpecialEffectX( wave ), BlzGetLocalSpecialEffectY( wave ))\r\n        local real distance = DistanceBetweenPoints(wavePoint, endPoint)\r\n\r\n        if counter >= FLIGHT_LIMIT or wave == null then\r\n            call DestroyEffect( wave )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        elseif distance <= DISTANCE_TO_ACTIVATE then\r\n            call CreateFog(id, x, y )\r\n        \r\n            call DestroyEffect( wave )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            set newPoint = LocationSystem_GetMovedEffect( wave, angle, SPEED )\r\n            call BlzSetSpecialEffectPositionLoc( wave, newPoint )\r\n            call SaveInteger( udg_hash, id, StringHash( \"tplq\" ), counter )\r\n        endif\r\n\r\n        call RemoveLocation(newPoint)\r\n        call RemoveLocation(endPoint)\r\n        call RemoveLocation(wavePoint)\r\n        set endPoint = null\r\n        set wavePoint = null\r\n        set newPoint = null\r\n        set wave = null\r\n    endfunction\r\n    \r\n    private function CreateOrb takes unit caster, real damage, real x, real y, integer level returns nothing\r\n        local integer id\r\n        local effect wave\r\n        local real angle\r\n        local location startPoint = Location( GetUnitX(caster), GetUnitY(caster) )\r\n        local location endPoint = Location(x, y)\r\n    \r\n        set wave = AddSpecialEffectLoc( ORB_ANIMATION, startPoint )\r\n        set angle = AngleBetweenPoints(startPoint, endPoint )\r\n        call BlzSetSpecialEffectYaw( wave, Deg2Rad(angle) )\r\n        call BlzSetSpecialEffectZ( wave, WAVE_Z )\r\n        \r\n        set id = InvokeTimerWithEffect( wave, \"tplq\", TICK, true, function WaveMove )\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"tplqc\" ), caster )\r\n        call SaveInteger( udg_hash, id, StringHash( \"tplqlvl\" ), level )\r\n        call SaveReal( udg_hash, id, StringHash( \"tplq\" ), angle )\r\n        call SaveReal( udg_hash, id, StringHash( \"tplqd\" ), damage )\r\n        call SaveReal( udg_hash, id, StringHash( \"tplqx\" ), x )\r\n        call SaveReal( udg_hash, id, StringHash( \"tplqy\" ), y )\r\n    \r\n    \tcall RemoveLocation(startPoint)\r\n    \tcall RemoveLocation(endPoint)\r\n    \tset startPoint = null\r\n    \tset endPoint = null\r\n        set wave = null\r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_The_PlagueQ_Actions takes nothing returns nothing\r\n        local unit caster\r\n        local integer level\r\n        local real x\r\n        local real y\r\n        local real damage\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Target\r\n            set level = udg_Level\r\n            set x = GetLocationX( GetSpellTargetLoc() )\r\n            set y = GetLocationY( GetSpellTargetLoc() )\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set level = udg_Level\r\n            set x = GetUnitX( caster ) + GetRandomReal( -650, 650 )\r\n            set y = GetUnitY( caster ) + GetRandomReal( -650, 650 )\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set level = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set x = GetLocationX( GetSpellTargetLoc() )\r\n            set y = GetLocationY( GetSpellTargetLoc() )\r\n        endif\r\n        \r\n        set damage = ( DAMAGE_FIRST_LEVEL + (DAMAGE_LEVEL_BONUS * level) )\r\n        \r\n        call CreateOrb( caster, damage, x, y, level )\r\n\r\n        set caster = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_The_PlagueQ = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_The_PlagueQ, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_The_PlagueQ, Condition( function Trig_The_PlagueQ_Conditions ) )\r\n        call TriggerAddAction( gg_trg_The_PlagueQ, function Trig_The_PlagueQ_Actions )\r\n    endfunction\r\n\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}