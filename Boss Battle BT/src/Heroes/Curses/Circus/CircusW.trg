{
  "Id": 50333341,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope CircusW initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A0SI'\r\n        \r\n        private constant integer WAVES = 8\r\n        private constant integer ANGLE_DIFFERENCE = 45\r\n        private constant integer DAMAGE_FIRST_LEVEL = 100\r\n        private constant integer DAMAGE_LEVEL_BONUS = 25\r\n        private constant real TICK = 0.04\r\n        \r\n        private constant integer FLIGHT_LENGTH = 30\r\n        private constant integer AREA = 128\r\n        private constant integer SPEED = 30\r\n        \r\n        private constant string WAVE_ANIMATION = \"Abilities\\\\Spells\\\\Orc\\\\Shockwave\\\\ShockwaveMissile.mdl\"\r\n        \r\n        private trigger Wave_Use = null\r\n    endglobals\r\n\r\n    function Trig_CircusW_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n    \r\n    /*private function DealDamage takes effect wave, integer id returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local real currentDamage\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"crcwc\" ) )\r\n        local real damage = LoadReal( udg_hash, id, StringHash( \"crcwd\" ) )\r\n        local group nodmg = LoadGroupHandle( udg_hash, id, StringHash( \"crcwg\" ) )\r\n        \r\n        call GroupEnumUnitsInRange( g, BlzGetLocalSpecialEffectX( wave ), BlzGetLocalSpecialEffectY( wave ), AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, \"enemy\" ) and not( IsUnitInGroup( u, nodmg ) ) then\r\n                set currentDamage = damage\r\n                if GetUnitAbilityLevel( u, 'B1B1') > 0 then\r\n                    set currentDamage = currentDamage + damage\r\n                endif\r\n                if GetUnitAbilityLevel( u, 'B1B2') > 0 then\r\n                    set currentDamage = currentDamage + damage\r\n                endif\r\n                if GetUnitAbilityLevel( u, 'B1B3') > 0 then\r\n                    set currentDamage = currentDamage + damage\r\n                endif\r\n                if GetUnitAbilityLevel( u, 'B1B4') > 0 then\r\n                    set currentDamage = currentDamage + damage\r\n                endif\r\n                call DemomanCurse( caster, u )\r\n                set IsDisableSpellPower = true\r\n                call UnitTakeDamage(caster, u, currentDamage, DAMAGE_TYPE_MAGIC)\r\n                call GroupAddUnit( nodmg, u )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n        set wave = null\r\n        set nodmg = null\r\n    endfunction\r\n    \r\n    private function DeleteGroup takes group affected returns nothing\r\n        local integer count = LoadInteger( udg_hash, GetHandleId(affected), StringHash( \"crcwc\" ) ) - 1\r\n        \r\n        if affected != null then\r\n            if count <= 0 then\r\n                call RemoveSavedInteger( udg_hash, GetHandleId(affected), StringHash( \"crcwc\" ) )\r\n                call GroupClear( affected )\r\n                call DestroyGroup( affected )\r\n            else\r\n                call SaveInteger( udg_hash, GetHandleId(affected), StringHash( \"crcwc\" ), count )\r\n            endif\r\n        endif\r\n    \r\n        set affected = null\r\n    endfunction\r\n\r\n    private function WaveCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer counter = LoadInteger( udg_hash, id, StringHash( \"crcw\" ) ) + 1\r\n        local effect wave = LoadEffectHandle( udg_hash, id, StringHash( \"crcw\" ) )\r\n        local real yaw = LoadReal( udg_hash, id, StringHash( \"crcwy\" ) )\r\n        local point newPoint = 0\r\n        \r\n        if counter >= FLIGHT_LENGTH or wave == null then\r\n            call DestroyEffect( wave )\r\n            call DeleteGroup( LoadGroupHandle( udg_hash, id, StringHash( \"crcwg\" ) ) )\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            set newPoint = GetMovedPoint( wave, yaw, SPEED )\r\n            call BlzSetSpecialEffectPosition( wave, newPoint.x, newPoint.y, BlzGetLocalSpecialEffectZ(wave) )\r\n            call DealDamage( wave, id )\r\n            call SaveInteger( udg_hash, id, StringHash( \"crcw\" ), counter )\r\n        endif\r\n\r\n        call newPoint.destroy()\r\n        set wave = null\r\n    endfunction\r\n    \r\n    private function CreateWave takes unit caster, real angle, real damage, group affected returns nothing\r\n        local effect wave\r\n        local real yaw\r\n        local integer id\r\n        local integer count = LoadInteger( udg_hash, GetHandleId(affected), StringHash( \"crcwc\" ) )\r\n    \r\n        set wave = AddSpecialEffect( WAVE_ANIMATION, GetUnitX(caster), GetUnitY(caster))\r\n        set yaw = Deg2Rad(angle)\r\n        call BlzSetSpecialEffectYaw( wave, yaw )\r\n        \r\n        set id = InvokeTimerWithEffect( wave, \"crcw\", TICK, true, function WaveCast )\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"crcwc\" ), caster )\r\n        call SaveReal( udg_hash, id, StringHash( \"crcwy\" ), yaw )\r\n        call SaveReal( udg_hash, id, StringHash( \"crcwd\" ), damage )\r\n        call SaveGroupHandle( udg_hash, id, StringHash( \"crcwg\" ), affected )\r\n        call SaveInteger( udg_hash, GetHandleId(affected), StringHash( \"crcwc\" ), count + 1 )\r\n    \r\n        set wave = null\r\n        set caster = null\r\n        set affected = null\r\n    endfunction*/\r\n    \r\n    private function DealDamage takes nothing returns nothing\r\n        local unit caster = Event_WaveHit_Caster\r\n        local unit target = Event_WaveHit_Target\r\n        local real damage = LoadReal( udg_hash, GetHandleId(Event_WaveHit_Wave), StringHash( \"crcwd\" ) )\r\n        local real currentDamage = damage\r\n        \r\n        if GetUnitAbilityLevel( target, 'B1B1') > 0 then\r\n            set currentDamage = currentDamage + damage\r\n        endif\r\n        if GetUnitAbilityLevel( target, 'B1B2') > 0 then\r\n            set currentDamage = currentDamage + damage\r\n        endif\r\n        if GetUnitAbilityLevel( target, 'B1B3') > 0 then\r\n            set currentDamage = currentDamage + damage\r\n        endif\r\n        if GetUnitAbilityLevel( target, 'B1B4') > 0 then\r\n            set currentDamage = currentDamage + damage\r\n        endif\r\n        call DemomanCurse( caster, target )\r\n        set IsDisableSpellPower = true\r\n        call UnitTakeDamage(caster, target, currentDamage, DAMAGE_TYPE_MAGIC)\r\n                \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n\r\n    function Trig_CircusW_Actions takes nothing returns nothing\r\n        local integer i\r\n        local real damage\r\n        local unit caster\r\n        local integer lvl\r\n        local group affected\r\n        local effect wave\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n        endif\r\n\r\n        set damage = (DAMAGE_FIRST_LEVEL+(DAMAGE_LEVEL_BONUS*lvl)) * GetUnitSpellPower(caster)\r\n        set affected = CreateGroup()\r\n        \r\n        set i = 1\r\n        loop\r\n            exitwhen i > WAVES\r\n            //call CreateWave(caster, ANGLE_DIFFERENCE * i, damage, affected)\r\n            set wave = Wave_CreateWave( caster, GetUnitX(caster), GetUnitY(caster), ANGLE_DIFFERENCE * i, TICK, AREA, FLIGHT_LENGTH, SPEED, TARGET_ENEMY, WAVE_BASE_ANIMATION, Wave_Use, affected )\r\n            call SaveReal( udg_hash, GetHandleId(wave), StringHash( \"crcwd\" ), damage)\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        set affected = null\r\n        set caster = null\r\n        set wave = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_CircusW = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_CircusW, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_CircusW, Condition( function Trig_CircusW_Conditions ) )\r\n        call TriggerAddAction( gg_trg_CircusW, function Trig_CircusW_Actions )\r\n        \r\n        set Wave_Use = CreateTrigger()\r\n        call TriggerAddAction( Wave_Use, function DealDamage )\r\n    endfunction\r\n\r\nendscope",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}