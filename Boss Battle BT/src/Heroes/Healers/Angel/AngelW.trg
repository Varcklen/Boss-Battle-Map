{
  "Id": 50333286,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "function Trig_AngelW_Conditions takes nothing returns boolean\r\n    return GetSpellAbilityId() == 'A07F'\r\nendfunction\r\n\r\nfunction AngelWCast takes nothing returns nothing\r\n    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n    local real counter = LoadReal( udg_hash, id, StringHash( \"angwt\" ) )\r\n    local integer sp = LoadInteger( udg_hash, id, StringHash( \"angwsp\" ) )\r\n    local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"angw\" ) )\r\n    local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"angw1\" ) )\r\n    local real heal = LoadReal( udg_hash, id, StringHash( \"angw\" ) )\r\n    local real dmg = LoadReal( udg_hash, id, StringHash( \"angw1\" ) )\r\n    local group g = CreateGroup()\r\n    local unit u\r\n    \r\n    if GetUnitState( target, UNIT_STATE_LIFE) > 0.405 then\r\n        call healst( caster, target, heal )\r\n    endif\r\n    \r\n    if counter > 0 and GetUnitState( target, UNIT_STATE_LIFE) > 0.405 and GetUnitAbilityLevel( target, sp ) > 0 then\r\n        call SaveReal( udg_hash, id, StringHash( \"angwt\" ), counter - 1 )\r\n        if counter == 1 then\r\n            call DestroyEffect( AddSpecialEffectTarget( \"Falling Light.mdx\", target, \"origin\" ) )\r\n        endif\r\n    else\r\n        if GetUnitState( target, UNIT_STATE_LIFE) > 0.405 and GetUnitAbilityLevel( target, sp ) > 0 then\r\n            call dummyspawn( caster, 1, 0, 'A0N5', 0 )\r\n            call GroupEnumUnitsInRange( g, GetUnitX( target ), GetUnitY( target ), 450, null )\r\n            loop\r\n                set u = FirstOfGroup( g )\r\n                exitwhen u == null\r\n                if unitst( u, caster, \"enemy\" )  then\r\n                    call UnitDamageTarget( bj_lastCreatedUnit, u, dmg, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )\r\n                endif\r\n                call GroupRemoveUnit( g, u )\r\n                set u = FirstOfGroup( g )\r\n            endloop\r\n        endif\r\n        call UnitRemoveAbility( target, sp )\r\n        call UnitRemoveAbility( target, 'B01Z' )\r\n        call DestroyTimer( GetExpiredTimer() )\r\n        call FlushChildHashtable( udg_hash, id )\r\n    endif\r\n    \r\n    call DestroyGroup( g )\r\n    set g = null\r\n    set target = null\r\n    set caster = null\r\n    set u = null\r\nendfunction\r\n\r\nfunction Trig_AngelW_Actions takes nothing returns nothing\r\n    local integer id\r\n    local integer cyclA = 1\r\n    local real dmg\r\n    local real heal\r\n    local unit caster\r\n    local unit target\r\n    local integer lvl\r\n    local integer sp\r\n    local real t\r\n    local unit n\r\n    local integer i\r\n\r\n    if CastLogic() then\r\n        set caster = udg_Caster\r\n        set target = udg_Target\r\n        set lvl = udg_Level\r\n        set t = udg_Time\r\n    elseif RandomLogic() then\r\n        set caster = udg_Caster\r\n        set target = randomtarget( caster, 900, \"ally\", \"notfull\", \"\", \"\", \"\" )\r\n        set lvl = udg_Level\r\n        call textst( udg_string[0] + GetObjectName('A07F'), caster, 64, 90, 10, 1.5 )\r\n        set t = 12\r\n        if target == null then\r\n            set caster = null\r\n            return\r\n        endif\r\n    else\r\n        set caster = GetSpellAbilityUnit()\r\n        set target = GetSpellTargetUnit()\r\n        set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n        set t = 12\r\n    endif\r\n    set t = timebonus(caster, t)\r\n    set dmg = 10 + ( 20 * lvl )\r\n    set heal = 8 + ( 8 * lvl )\r\n    \r\n    set sp = 'A0BO'\r\n    \r\n    if lvl == 5  then\r\n        set i = 4\r\n        loop\r\n            exitwhen cyclA > i\r\n            set n = udg_hero[cyclA]\r\n            if unitst( n, caster, \"ally\" ) then\r\n                set id = GetHandleId( n )\r\n                call UnitAddAbility( n, sp )\r\n                call DestroyEffect(AddSpecialEffectTarget(\"Life Magic.mdx\", n, \"chest\"))\r\n                \r\n                if LoadTimerHandle( udg_hash, id, StringHash( \"angw\" ) ) == null then\r\n                    call SaveTimerHandle( udg_hash, id, StringHash( \"angw\" ), CreateTimer() )\r\n                endif\r\n                set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"angw\" ) ) ) \r\n                call SaveUnitHandle( udg_hash, id, StringHash( \"angw\" ), n )\r\n                call SaveUnitHandle( udg_hash, id, StringHash( \"angw1\" ), caster )\r\n                call SaveReal( udg_hash, id, StringHash( \"angw\" ), heal )\r\n                call SaveReal( udg_hash, id, StringHash( \"angw1\" ), dmg )\r\n                call SaveReal( udg_hash, id, StringHash( \"angwt\" ), t )\r\n                call SaveInteger( udg_hash, id, StringHash( \"angwsp\" ), sp )\r\n                call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( n ), StringHash( \"angw\" ) ), 1, true, function AngelWCast )\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n    else\r\n        set id = GetHandleId( target )\r\n        call UnitAddAbility( target, sp )\r\n        call DestroyEffect(AddSpecialEffectTarget(\"Life Magic.mdx\", target, \"chest\"))\r\n        \r\n        if LoadTimerHandle( udg_hash, id, StringHash( \"angw\" ) ) == null then\r\n            call SaveTimerHandle( udg_hash, id, StringHash( \"angw\" ), CreateTimer() )\r\n        endif\r\n        set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"angw\" ) ) ) \r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"angw\" ), target )\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"angw1\" ), caster )\r\n        call SaveReal( udg_hash, id, StringHash( \"angw\" ), heal )\r\n        call SaveReal( udg_hash, id, StringHash( \"angw1\" ), dmg )\r\n        call SaveReal( udg_hash, id, StringHash( \"angwt\" ), t )\r\n        call SaveInteger( udg_hash, id, StringHash( \"angwsp\" ), sp )\r\n        call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( target ), StringHash( \"angw\" ) ), 1, true, function AngelWCast )\r\n    endif\r\n    \r\n    set caster = null\r\n    set target = null\r\n    set n = null\r\nendfunction\r\n\r\n//===========================================================================\r\nfunction InitTrig_AngelW takes nothing returns nothing\r\n    set gg_trg_AngelW = CreateTrigger(  )\r\n    call TriggerRegisterAnyUnitEventBJ( gg_trg_AngelW, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n    call TriggerAddCondition( gg_trg_AngelW, Condition( function Trig_AngelW_Conditions ) )\r\n    call TriggerAddAction( gg_trg_AngelW, function Trig_AngelW_Actions )\r\nendfunction\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}