{
  "Id": 50333290,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "globals\r\n    constant string DRUID_Q_END_ANIMATION = \"Objects\\\\Spawnmodels\\\\NightElf\\\\EntBirthTarget\\\\EntBirthTarget.mdl\"\r\n\r\n    constant integer DRUID_Q_DURATION = 3\r\n    constant integer DRUID_Q_HEAL_FIRST_LEVEL = 175\r\n    constant integer DRUID_Q_HEAL_LEVEL_BONUS = 125\r\n    \r\n    constant integer DRUID_Q_DURATION_ALTERNATIVE = 15\r\n    constant integer DRUID_Q_TICK_ALTERNATIVE = 3\r\n    constant real DRUID_Q_HEAL_ALTERNATIVE = 0.1\r\nendglobals\r\n\r\nfunction Trig_DruidQ_Conditions takes nothing returns boolean\r\n    return GetSpellAbilityId() == 'A0M3'\r\nendfunction\r\n\r\nfunction DruidQCast_Alternative takes nothing returns nothing\r\n    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n    local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"drqac\" ) )\r\n    local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"drqa\" ) )\r\n    local real heal = LoadReal( udg_hash, id, StringHash( \"drqa\" ) )\r\n    \r\n    if GetUnitState( target, UNIT_STATE_LIFE) > 0.405 and GetUnitAbilityLevel( target, 'A0M2') > 0 then\r\n        call DestroyEffect( AddSpecialEffectTarget( DRUID_Q_END_ANIMATION, target, \"origin\" ) )\r\n        call healst( caster, target, heal )\r\n    else\r\n        call UnitRemoveAbility( target, 'A0M2' )\r\n        call UnitRemoveAbility( target, 'B004' )\r\n        call FlushChildHashtable( udg_hash, id )\r\n        call DestroyTimer( GetExpiredTimer() )\r\n    endif  \r\n\r\n    set caster = null\r\n    set target = null\r\nendfunction\r\n\r\nfunction DruidQCast takes nothing returns nothing\r\n    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n    local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"drqc\" ) )\r\n    local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"drq\" ) )\r\n    local real heal = LoadReal( udg_hash, id, StringHash( \"drq\" ) )\r\n    \r\n    if GetUnitState( target, UNIT_STATE_LIFE) > 0.405 and GetUnitAbilityLevel(target, 'A0M2') > 0 then\r\n        call DestroyEffect( AddSpecialEffectTarget( DRUID_Q_END_ANIMATION, target, \"origin\" ) )\r\n        call healst( caster, target, heal )\r\n     endif  \r\n    call UnitRemoveAbility( target, 'A0M2' )\r\n    call UnitRemoveAbility( target, 'B004' )\r\n     \r\n    call FlushChildHashtable( udg_hash, id )\r\n    set caster = null\r\n    set target = null\r\nendfunction\r\n\r\nfunction DruidQ_Alternative takes unit caster, unit target, real heal, real duration returns nothing\r\n    local integer id\r\n    local real healPerTick = heal*DRUID_Q_HEAL_ALTERNATIVE\r\n    \r\n    set duration = timebonus(caster, DRUID_Q_DURATION_ALTERNATIVE)\r\n    \r\n    call UnitAddAbility( target, 'A0M2' )\r\n    \r\n    set id = InvokeTimerWithUnit(target, \"drq\", duration, false, function DruidQCast )\r\n    call SaveUnitHandle( udg_hash, id, StringHash( \"drqc\" ), caster )\r\n    call SaveReal( udg_hash, id, StringHash( \"drq\" ), heal )\r\n    \r\n    set id = InvokeTimerWithUnit(target, \"drqa\", DRUID_Q_TICK_ALTERNATIVE, true, function DruidQCast_Alternative )\r\n    call SaveUnitHandle( udg_hash, id, StringHash( \"drqac\" ), caster )\r\n    call SaveReal( udg_hash, id, StringHash( \"drqa\" ), healPerTick )\r\n    \r\n    set caster = null\r\n    set target = null\r\nendfunction\r\n\r\nfunction DruidQ takes unit caster, unit target, real heal, real duration returns nothing\r\n    local integer id\r\n    \r\n    set duration = timebonus(caster, duration)\r\n\r\n    call UnitAddAbility( target, 'A0M2' )\r\n    \r\n    set id = InvokeTimerWithUnit(target, \"drq\", duration, false, function DruidQCast )\r\n    call SaveUnitHandle( udg_hash, id, StringHash( \"drqc\" ), caster )\r\n    call SaveReal( udg_hash, id, StringHash( \"drq\" ), heal )\r\n    \r\n    set caster = null\r\n    set target = null\r\nendfunction\r\n\r\nfunction Trig_DruidQ_Actions takes nothing returns nothing\r\n    local unit caster\r\n    local unit target\r\n    local integer lvl\r\n    local real t\r\n    local real heal\r\n    \r\n    if CastLogic() then\r\n        set caster = udg_Caster\r\n        set target = udg_Target\r\n        set lvl = udg_Level\r\n        set t = udg_Time\r\n    elseif RandomLogic() then\r\n        set caster = udg_Caster\r\n        set target = randomtarget( caster, 900, \"ally\", \"notfull\", \"\", \"\", \"\" )\r\n        set lvl = udg_Level\r\n        call textst( udg_string[0] + GetObjectName('A0M3'), caster, 64, 90, 10, 1.5 )\r\n        set t = DRUID_Q_DURATION\r\n        if target == null then\r\n            set caster = null\r\n            return\r\n        endif\r\n    else\r\n        set caster = GetSpellAbilityUnit()\r\n        set target = GetSpellTargetUnit()\r\n        set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n        set t = DRUID_Q_DURATION\r\n    endif\r\n    \r\n    set heal = DRUID_Q_HEAL_FIRST_LEVEL + ( DRUID_Q_HEAL_LEVEL_BONUS * lvl )\r\n    \r\n    if Aspects_IsHeroAspectActive(caster, ASPECT_01 ) then\r\n        call DruidQ_Alternative( caster, target,  heal, t )\r\n    else\r\n        call DruidQ( caster, target, heal, t )\r\n    endif\r\n    \r\n    set caster = null\r\n    set target = null\r\nendfunction\r\n\r\n//===========================================================================\r\nfunction InitTrig_DruidQ takes nothing returns nothing\r\n    set gg_trg_DruidQ = CreateTrigger(  )\r\n    call TriggerRegisterAnyUnitEventBJ( gg_trg_DruidQ, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n    call TriggerAddCondition( gg_trg_DruidQ, Condition( function Trig_DruidQ_Conditions ) )\r\n    call TriggerAddAction( gg_trg_DruidQ, function Trig_DruidQ_Actions )\r\nendfunction\r\n\r\nscope DruidQ initializer Triggs\r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, 'A0F7') > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        local unit hero = Event_DeleteBuff_Unit\r\n\r\n        call UnitRemoveAbility( hero, 'A0M2' )\r\n        call UnitRemoveAbility( hero, 'B004' )\r\n        \r\n        set hero = null\r\n    endfunction\r\n\r\n    private function Triggs takes nothing returns nothing\r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n    endfunction\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}