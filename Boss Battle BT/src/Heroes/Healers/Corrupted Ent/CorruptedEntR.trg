{
  "Id": 50333330,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope CorruptedR initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A0OJ'\r\n    \r\n        private constant integer ID_ARMOR_REDUCE = 'A0OR'\r\n        private constant integer EFFECT = 'A0P7'\r\n        private constant integer BUFF = 'B0A0'\r\n    \r\n        private constant integer DURATION = 5\r\n        private constant integer INTERVAL = 1\r\n        private constant integer DAMAGE_FIRST_LEVEL = 30\r\n        private constant integer DAMAGE_LEVEL_BONUS = 10\r\n        private constant integer HEAL_AREA = 600\r\n        \r\n        private constant integer ALT_AREA = 400\r\n    endglobals\r\n\r\n    function Trig_CorruptedEntR_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n\r\n    function CorruptedEnrRHeal takes unit caster, real x, real y, integer id returns nothing\r\n        local real heal = LoadReal( udg_hash, id, StringHash( \"entrh\" ) )\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        \r\n        if heal > 0 then\r\n            call GroupEnumUnitsInRange( g, x, y, HEAL_AREA, null )\r\n            loop\r\n                set u = FirstOfGroup(g)\r\n                exitwhen u == null\r\n                if unitst( u, caster, \"ally\" ) and IsUnitType( u, UNIT_TYPE_HERO) then\r\n                    call healst(caster, u , heal)\r\n                endif\r\n                call GroupRemoveUnit(g,u)\r\n            endloop\r\n        endif\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set g = null\r\n        set u = null\r\n    endfunction\r\n\r\n    function CorruptedEnrRCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"entrc\" ) )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"entr\" ) )\r\n        local real damage = LoadReal( udg_hash, id, StringHash( \"entr\" ) )\r\n        \r\n        if IsUnitAlive(target) and IsUnitHasAbility( target, EFFECT)  then\r\n            call CorruptedEnrRHeal(caster, GetUnitX(target), GetUnitY(target), id )\r\n            set IsDisableSpellPower = true\r\n            call UnitTakeDamage( caster, target, damage, DAMAGE_TYPE_MAGIC )\r\n        else\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        endif\r\n        \r\n        set target = null\r\n        set caster = null\r\n    endfunction\r\n\r\n    private function Corrupted_EntR_Alternative takes unit caster, unit target, real damage, real duration, integer level returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local integer id\r\n        \r\n        call GroupEnumUnitsInRange( g, GetUnitX(target), GetUnitY(target), ALT_AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, \"enemy\" ) then\r\n                set id = InvokeTimerWithUnit(u, \"entr\", INTERVAL, true, function CorruptedEnrRCast)\r\n                call SaveUnitHandle( udg_hash, id, StringHash( \"entrc\" ), caster )\r\n                call SaveReal( udg_hash, id, StringHash( \"entr\" ), damage )\r\n                call SaveReal( udg_hash, id, StringHash( \"entrh\" ), 0 )\r\n                \r\n                call bufallst(caster, u, EFFECT, ID_ARMOR_REDUCE, 0, 0, 0, BUFF, \"entrb\", duration )\r\n                call SetUnitAbilityLevel( u, ID_ARMOR_REDUCE, level )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n        \r\n        call DestroyGroup( g )\r\n        set g = null\r\n        set u = null\r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n\r\n    private function Corrupted_EntR takes unit caster, unit target, real damage, real duration, integer level, real heal returns nothing\r\n        local integer id\r\n\r\n        set id = InvokeTimerWithUnit(target, \"entr\", INTERVAL, true, function CorruptedEnrRCast)\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"entrc\" ), caster )\r\n        call SaveReal( udg_hash, id, StringHash( \"entr\" ), damage )\r\n        call SaveReal( udg_hash, id, StringHash( \"entrh\" ), heal )\r\n        \r\n        call bufallst(caster, target, EFFECT, ID_ARMOR_REDUCE, 0, 0, 0, BUFF, \"entrb\", duration )\r\n        call SetUnitAbilityLevel( target, ID_ARMOR_REDUCE, level )\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n\r\n    function Trig_CorruptedEntR_Actions takes nothing returns nothing\r\n        local unit caster\r\n        local unit target\r\n        local integer lvl\r\n        local real t\r\n        local real damage\r\n        local real heal\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Caster\r\n            set target = udg_Target\r\n            set lvl = udg_Level\r\n            set t = udg_Time\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set target = randomtarget( caster, 900, \"enemy\", \"\", \"\", \"\", \"\" )\r\n            set lvl = udg_Level\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n            set t = DURATION\r\n            if target == null then\r\n                set caster = null\r\n                return\r\n            endif\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set target = GetSpellTargetUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set t = DURATION\r\n        endif\r\n\r\n        set damage = (DAMAGE_FIRST_LEVEL + (DAMAGE_LEVEL_BONUS * lvl) ) * GetUnitSpellPower(caster)\r\n        set heal = damage\r\n        \r\n        if Aspects_IsHeroAspectActive(caster, ASPECT_03 ) then\r\n            call Corrupted_EntR_Alternative( caster, target, damage, t, lvl )\r\n        else\r\n            call Corrupted_EntR( caster, target, damage, t, lvl, heal )\r\n        endif\r\n\r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n\r\n    private function BuffDelete_Condition takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT) > 0\r\n    endfunction\r\n\r\n    private function BuffDelete takes nothing returns nothing\r\n        call UnitRemoveAbility(Event_DeleteBuff_Unit, EFFECT)\r\n        call UnitRemoveAbility(Event_DeleteBuff_Unit, ID_ARMOR_REDUCE)\r\n        call UnitRemoveAbility(Event_DeleteBuff_Unit, BUFF)\r\n    endfunction\r\n\r\n    private function Corrupted_End_Q_Condition takes nothing returns boolean\r\n        return IsUnitHasAbility( Event_Corrupted_End_Q_Unit, EFFECT)\r\n    endfunction\r\n    \r\n    private function Corrupted_End_Q takes nothing returns nothing\r\n        call bufallst(Event_Corrupted_End_Q_Caster, Event_Corrupted_End_Q_Unit, EFFECT, ID_ARMOR_REDUCE, 0, 0, 0, BUFF, \"entrb\", DURATION )\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_CorruptedEntR = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_CorruptedEntR, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_CorruptedEntR, Condition( function Trig_CorruptedEntR_Conditions ) )\r\n        call TriggerAddAction( gg_trg_CorruptedEntR, function Trig_CorruptedEntR_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_Corrupted_End_Q_Real\", function Corrupted_End_Q, function Corrupted_End_Q_Condition )\r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function BuffDelete, function BuffDelete_Condition )\r\n    endfunction\r\n\r\nendscope",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}