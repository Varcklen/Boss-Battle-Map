{
  "Id": 50332892,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope Curse initializer init\r\n\r\n\tglobals\r\n\t\tprivate constant string ANIMATION = \"Abilities\\\\Spells\\\\Undead\\\\DeathandDecay\\\\DeathandDecayTarget.mdl\"\r\n\t\r\n\t\tprivate constant real DURATION = 15\r\n\t\t\r\n\t\tprivate constant real ATTACK_TO_ADD_PERC = -0.15\r\n\t\tprivate constant real ATTACK_TO_ADD_PERC_UPGRADED = -0.3\r\n\t\r\n\t\tprivate constant integer ABILITY_ID = 'A0GF'\r\n\t\tprivate constant integer UPGRADED_ABILITY_ID = 'A035'\r\n\t\t\r\n\t\tprivate constant integer EFFECT_ID = 'A0KN'\r\n\t\tprivate constant integer BUFF_ID = 'B02I'\r\n\tendglobals\r\n\r\n\tprivate function condition takes nothing returns boolean\r\n\t    return GetSpellAbilityId() == ABILITY_ID or GetSpellAbilityId() == UPGRADED_ABILITY_ID\r\n\tendfunction\r\n\t\r\n\tprivate function BuffClear takes unit target returns nothing\r\n\t\tlocal integer attackAdded = LoadInteger( udg_hash, GetHandleId(target), StringHash( \"curse_attack\" ) )\r\n\t\t\r\n\t\tcall BlzSetUnitBaseDamage( target, BlzGetUnitBaseDamage(target, 0) - attackAdded, 0 )\r\n\t    call SaveInteger( udg_hash, GetHandleId(target), StringHash( \"curse_attack\" ), 0 )\r\n\t    call UnitRemoveAbility( target, EFFECT_ID )\r\n\t    call UnitRemoveAbility( target, BUFF_ID )\r\n\tendfunction\r\n\t\r\n\tprivate function BuffCast takes nothing returns nothing\r\n\t    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n\t    local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"curse\" ) )\r\n\t    \r\n\t    call BuffClear(target)\r\n\t    call FlushChildHashtable( udg_hash, id )\r\n\t    \r\n\t    set target = null\r\n\tendfunction\r\n\t\r\n\tprivate function action takes nothing returns nothing\r\n\t    local integer id \r\n\t    local unit caster\r\n\t    local unit target\r\n\t    local real duration\r\n\t    local integer attackToAdd\r\n\t    local real attackMultiplier\r\n\t    \r\n\t    if CastLogic() then\r\n\t        set caster = udg_Caster\r\n\t        set target = udg_Target\r\n\t    elseif RandomLogic() then\r\n\t        set caster = udg_Caster\r\n\t        set target = randomtarget( caster, 900, \"enemy\", \"\", \"\", \"\", \"\" )\r\n\t        call textst( udg_string[0] + GetObjectName(ABILITY_ID), caster, 64, 90, 10, 1.5 )\r\n\t        if target == null then\r\n\t            set caster = null\r\n\t            return\r\n\t        endif\r\n\t    else\r\n\t        set caster = GetSpellAbilityUnit()\r\n\t        set target = GetSpellTargetUnit()\r\n\t    endif\r\n\t    \r\n\t    call BuffClear(target)\r\n\t    \r\n\t    /*Attack To Add*/\r\n\t    if IsUniqueUpgraded(caster) then\r\n\t        set attackMultiplier = ATTACK_TO_ADD_PERC_UPGRADED\r\n\t    else\r\n\t        set attackMultiplier = ATTACK_TO_ADD_PERC\r\n\t    endif\r\n\t    set attackToAdd = R2I(BlzGetUnitBaseDamage(target, 0) * attackMultiplier * GetUnitSpellPower(caster) * GetUniqueSpellPower(caster))\r\n\t    call SaveInteger( udg_hash, GetHandleId(target), StringHash( \"curse_attack\" ), attackToAdd )\r\n\t    call BlzSetUnitBaseDamage( target, BlzGetUnitBaseDamage(target, 0) + attackToAdd, 0 )\r\n\t    /*===============*/\r\n\t    \r\n\t    set duration = timebonus(caster, DURATION)\r\n\t    call spectimeunit( target, ANIMATION, \"overhead\", 2 )\r\n\t    call UnitAddAbility( target, EFFECT_ID )\r\n\t    \r\n\t    set id = GetHandleId( target )\r\n\t    if LoadTimerHandle( udg_hash, id, StringHash( \"curse\" ) ) == null  then\r\n\t        call SaveTimerHandle( udg_hash, id, StringHash( \"curse\" ), CreateTimer() )\r\n\t    endif\r\n\t\tset id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"curse\" ) ) ) \r\n\t\tcall SaveUnitHandle( udg_hash, id, StringHash( \"curse\" ), target )\r\n\t\tcall TimerStart( LoadTimerHandle( udg_hash, GetHandleId( target ), StringHash( \"curse\" ) ), duration, false, function BuffCast )\r\n\t    \r\n\t    set Event_MaliceTrigger_Hero = caster\r\n\t\tset Event_MaliceTrigger = 1\r\n\t\tset Event_MaliceTrigger = 0\r\n\t    \r\n\t    set caster = null\r\n\t    set target = null\r\n\tendfunction\r\n\t\r\n\t//===========================================================================\r\n\tprivate function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT_ID) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n    \tcall BuffClear(Event_DeleteBuff_Unit)\r\n    endfunction\r\n\t\r\n\t//===========================================================================\r\n\tprivate function init takes nothing returns nothing\r\n\t    set gg_trg_Curse = CreateTrigger(  )\r\n\t    call TriggerRegisterAnyUnitEventBJ( gg_trg_Curse, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n\t    call TriggerAddCondition( gg_trg_Curse, Condition( function condition ) )\r\n\t    call TriggerAddAction( gg_trg_Curse, function action )\r\n\t    \r\n\t    call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n\tendfunction\r\n\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}