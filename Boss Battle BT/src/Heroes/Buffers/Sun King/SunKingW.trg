{
  "Id": 50332977,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope SunKingW initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'AV00'\r\n        \r\n        private constant integer DURATION = 10\r\n        private constant integer STACK_LIMIT = 3\r\n        private constant integer TICK = 1\r\n        private constant integer AREA = 800\r\n        \r\n        private constant integer DAMAGE_FIRST_LEVEL = 0\r\n        private constant integer DAMAGE_LEVEL_BONUS = 25\r\n        private constant integer TICK_DAMAGE_FIRST_LEVEL = 0\r\n        private constant integer TICK_DAMAGE_LEVEL_BONUS = 1\r\n        private constant real MAGIC_DAMAGE_BONUS_FIRST_LEVEL = 0\r\n        private constant real MAGIC_DAMAGE_BONUS_LEVEL_BONUS = 0.01\r\n        \r\n        private constant integer EFFECT = 'A02Y'\r\n        private constant integer BUFF = 'B08S'\r\n    endglobals\r\n\r\n    function Trig_SunKingW_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n    \r\n    private function TickDamage takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"snkw\" ) )\r\n        local unit caster = LoadUnitHandle(udg_hash, id, StringHash(\"snkwc\") )\r\n        local real damage = LoadReal(udg_hash, id, StringHash(\"snkw\") )\r\n    \r\n        if IsUnitAlive(target) and IsUnitHasAbility(target, EFFECT) then\r\n            call UnitTakeDamage(caster, target, damage, DAMAGE_TYPE_MAGIC )\r\n        else\r\n            call RemoveSavedReal( udg_hash, GetHandleId(target), StringHash(\"snkwm\") )\r\n            call RemoveSavedInteger( udg_hash, GetHandleId(target), StringHash(\"snkws\") )\r\n            call RemoveEffect( target, EFFECT, BUFF )\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        endif\r\n    \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function DealDamage takes unit caster, unit target, real duration, real damage, real tickDamage, real magicBonus returns nothing\r\n        local integer id\r\n        local integer stack = IMinBJ(STACK_LIMIT, LoadInteger(udg_hash, GetHandleId(target), StringHash(\"snkws\") ) + 1 )\r\n    \r\n        call textst( \"|cFFffcc00\" + I2S(stack), target, 64, GetRandomReal( 80, 100 ), 12, 1 )\r\n        call UnitTakeDamage(caster, target, damage, DAMAGE_TYPE_MAGIC )\r\n        call bufst(caster, target, EFFECT, BUFF, \"snkwe\", duration)\r\n        call SaveInteger(udg_hash, GetHandleId(target), StringHash(\"snkws\"), stack )\r\n        call SaveReal(udg_hash, GetHandleId(target), StringHash(\"snkwm\"), magicBonus*stack)\r\n        \r\n        set id = InvokeTimerWithUnit(target, \"snkw\", TICK, true, function TickDamage )\r\n        call SaveUnitHandle(udg_hash, id, StringHash(\"snkwc\"), caster)\r\n        call SaveReal(udg_hash, id, StringHash(\"snkw\"), tickDamage*stack)\r\n    \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n\r\n    private function AreaDamage takes unit caster, integer level, real duration returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local real damage = DAMAGE_FIRST_LEVEL + (DAMAGE_LEVEL_BONUS * level)\r\n        local real tickDamage = TICK_DAMAGE_FIRST_LEVEL + (TICK_DAMAGE_LEVEL_BONUS * level)\r\n        local real magicBonus = MAGIC_DAMAGE_BONUS_FIRST_LEVEL + (MAGIC_DAMAGE_BONUS_LEVEL_BONUS * level)\r\n        \r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, TARGET_ENEMY ) then\r\n                call DealDamage(caster, u, duration, damage, tickDamage, magicBonus)\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n        \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_SunKingW_Actions takes nothing returns nothing\r\n        local unit caster\r\n        local integer lvl\r\n        local real t\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            set t = udg_Time\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n            set t = DURATION\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set t = DURATION\r\n        endif\r\n        \r\n        set t = timebonus(caster, t)\r\n        call AreaDamage(caster, lvl, t )\r\n\r\n        set caster = null\r\n    endfunction\r\n    \r\n    //Delete buff\r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        call RemoveEffect( Event_DeleteBuff_Unit, EFFECT, BUFF )\r\n    endfunction\r\n    \r\n    //Add magic damage\r\n    private function OnDamageChange_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( udg_DamageEventTarget, EFFECT) > 0 and udg_IsDamageSpell\r\n    endfunction\r\n    \r\n    private function OnDamageChange takes nothing returns nothing\r\n        local real magicBonus = LoadReal(udg_hash, GetHandleId(udg_DamageEventTarget), StringHash(\"snkwm\") )\r\n        \r\n        set udg_DamageEventAmount = udg_DamageEventAmount + (Event_OnDamageChange_StaticDamage*magicBonus)\r\n    endfunction\r\n    \r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_SunKingW = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_SunKingW, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_SunKingW, Condition( function Trig_SunKingW_Conditions ) )\r\n        call TriggerAddAction( gg_trg_SunKingW, function Trig_SunKingW_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n        call CreateEventTrigger( \"Event_OnDamageChange_Real\", function OnDamageChange, function OnDamageChange_Conditions )\r\n        call StackAbilities_AddAbilityStack( ID_ABILITY, 1, 2, 3 )\r\n    endfunction\r\n\r\nendscope",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}