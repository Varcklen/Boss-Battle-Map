{
  "Id": 50332974,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "function Trig_SunKingQxxx_Conditions takes nothing returns boolean\r\n    return GetSpellAbilityId() == 'A01H'\r\nendfunction\r\n\r\nfunction SunKingQCast takes nothing returns nothing\r\n    local integer id = GetHandleId( GetExpiredTimer() )\r\n    local integer counter = LoadInteger( udg_hash, id, StringHash( \"snkq\" ) )\r\n    local unit dummy = LoadUnitHandle( udg_hash, id, StringHash( \"snkqd\" ) )\r\n    local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"snkq\" ) )\r\n    local group g = CreateGroup()\r\n    local unit u\r\n    local real dmg = LoadReal( udg_hash, id, StringHash( \"snkq\" ) )\r\n    local real x = LoadReal( udg_hash, id, StringHash( \"snkqx\" ) )\r\n    local real y = LoadReal( udg_hash, id, StringHash( \"snkqy\" ) )\r\n    local real heal = 0\r\n    local unit target = null\r\n    local integer cyclA\r\n    \r\n    call GroupEnumUnitsInRange( g, x, y, 250, null )\r\n    loop\r\n        set u = FirstOfGroup(g)\r\n        exitwhen u == null\r\n        if unitst( u, dummy, \"enemy\" ) then\r\n            call DestroyEffect( AddSpecialEffectTarget( \"Abilities\\\\Spells\\\\NightElf\\\\Immolation\\\\ImmolationDamage.mdl\", u, \"overhead\" ) )\r\n            call UnitDamageTarget( dummy, u, dmg, true, false, ATTACK_TYPE_NORMAL, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS )\r\n            set heal = heal + dmg\r\n        endif\r\n        call GroupRemoveUnit(g,u)\r\n        set u = FirstOfGroup(g)\r\n    endloop\r\n    \r\n    if heal > 0 then\r\n        set cyclA = 1\r\n        loop\r\n            exitwhen cyclA > 4\r\n            if inv(udg_hero[cyclA], 'I09N') == 0 and IsUnitAlly(udg_hero[cyclA], GetOwningPlayer(caster)) and GetUnitState(udg_hero[cyclA], UNIT_STATE_LIFE) > 0.405 and ( RMinBJ(GetUnitLifePercent(udg_hero[cyclA]), GetUnitLifePercent(udg_hero[cyclA - 3])) == GetUnitLifePercent(udg_hero[cyclA]) or GetUnitState(udg_hero[cyclA - 3], UNIT_STATE_LIFE) <= 0.405 ) and ( RMinBJ(GetUnitLifePercent(udg_hero[cyclA]), GetUnitLifePercent(udg_hero[cyclA - 1])) == GetUnitLifePercent(udg_hero[cyclA]) or GetUnitState(udg_hero[cyclA - 1], UNIT_STATE_LIFE) <= 0.405 ) and ( RMinBJ(GetUnitLifePercent(udg_hero[cyclA]), GetUnitLifePercent(udg_hero[cyclA - 2])) == GetUnitLifePercent(udg_hero[cyclA]) or GetUnitState(udg_hero[cyclA - 2], UNIT_STATE_LIFE) <= 0.405 ) then\r\n                set target = udg_hero[cyclA]\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        if target != null then\r\n            call healst( caster, target, heal )\r\n        endif\r\n    endif\r\n    \r\n    if counter > 0 and GetUnitState( dummy, UNIT_STATE_LIFE) > 0.405 then\r\n        call SaveInteger( udg_hash, id, StringHash( \"snkq\" ), counter - 1 )\r\n    else\r\n        call RemoveUnit( dummy )\r\n        call FlushChildHashtable( udg_hash, id )\r\n        call DestroyTimer( GetExpiredTimer() )\r\n    endif\r\n    \r\n    call GroupClear( g )\r\n    call DestroyGroup( g )\r\n    set g = null\r\n    set u = null\r\n    set target = null\r\n    set dummy = null\r\n    set caster = null\r\nendfunction\r\n\r\nfunction Trig_SunKingQxxx_Actions takes nothing returns nothing\r\n    local unit dummy\r\n    local integer id \r\n    local unit caster\r\n    local integer lvl\r\n    local real x\r\n    local real y\r\n    local real dmg\r\n    \r\n    if CastLogic() then\r\n        set caster = udg_Caster\r\n        set lvl = udg_Level\r\n        set x = GetSpellTargetX()\r\n        set y = GetSpellTargetY()\r\n    elseif RandomLogic() then\r\n        set caster = udg_Caster\r\n        set lvl = udg_Level\r\n        set x = GetUnitX( caster ) + GetRandomReal( -650, 650 )\r\n        set y = GetUnitY( caster ) + GetRandomReal( -650, 650 )\r\n        call textst( udg_string[0] + GetObjectName('A01H'), caster, 64, 90, 10, 1.5 )\r\n    else\r\n        set caster = GetSpellAbilityUnit()\r\n        set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n        set x = GetSpellTargetX()\r\n        set y = GetSpellTargetY()\r\n    endif\r\n\r\n    set dmg = (BlzGetUnitBaseDamage(caster, 0)*(0.2+(0.1*lvl))) * udg_SpellDamage[GetPlayerId(GetOwningPlayer(caster)) + 1]\r\n    \r\n    set bj_lastCreatedUnit = CreateUnit( GetOwningPlayer( caster ), 'u000', x, y, bj_UNIT_FACING )\r\n    call DestroyEffect( AddSpecialEffect( \"Objects\\\\Spawnmodels\\\\NightElf\\\\NECancelDeath\\\\NECancelDeath.mdl\", GetUnitX( bj_lastCreatedUnit ), GetUnitY( bj_lastCreatedUnit ) ) )\r\n    call UnitAddAbility( bj_lastCreatedUnit, 'A01J' )\r\n     \r\n    set id = GetHandleId( bj_lastCreatedUnit ) \r\n    call SaveTimerHandle( udg_hash, id, StringHash( \"snkq\" ), CreateTimer() )\r\n\tset id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"snkq\" ) ) ) \r\n\tcall SaveUnitHandle( udg_hash, id, StringHash( \"snkq\" ), caster )\r\n    call SaveUnitHandle( udg_hash, id, StringHash( \"snkqd\" ), bj_lastCreatedUnit )\r\n    call SaveInteger( udg_hash, id, StringHash( \"snkq\" ), 15 )\r\n    call SaveReal( udg_hash, id, StringHash( \"snkq\" ), dmg )\r\n    call SaveReal( udg_hash, id, StringHash( \"snkqx\" ), x )\r\n    call SaveReal( udg_hash, id, StringHash( \"snkqy\" ), y )\r\n\tcall TimerStart( LoadTimerHandle( udg_hash, GetHandleId( bj_lastCreatedUnit ), StringHash( \"snkq\" ) ), 1, true, function SunKingQCast )\r\n    \r\n    set caster = null\r\nendfunction\r\n\r\n//===========================================================================\r\nfunction InitTrig_SunKingQxxx takes nothing returns nothing\r\n    set gg_trg_SunKingQxxx = CreateTrigger(  )\r\n    call TriggerRegisterAnyUnitEventBJ( gg_trg_SunKingQxxx, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n    call TriggerAddCondition( gg_trg_SunKingQxxx, Condition( function Trig_SunKingQxxx_Conditions ) )\r\n    call TriggerAddAction( gg_trg_SunKingQxxx, function Trig_SunKingQxxx_Actions )\r\nendfunction\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}