{
  "Id": 50332988,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope WandererE initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A0LD'\r\n        \r\n        private constant integer EFFECT = 'A0LE'\r\n        private constant integer BUFF = 'B01W'\r\n        \r\n        private constant integer EFFECT_HEAL = 'A1EU'\r\n        private constant integer BUFF_HEAL = 'B0AJ'\r\n        \r\n        private constant integer HEAL_TICK = 1\r\n        \r\n        private constant integer SPELL_POWER_BONUS = 3\r\n        \r\n        private constant integer DURATION_FIRST_LEVEL = 2\r\n        private constant integer DURATION_LEVEL_BONUS = 1\r\n        \r\n        private constant real HEAL_PERCENT_FIRST_LEVEL = 0.01\r\n        private constant real HEAL_PERCENT_LEVEL_BONUS = 0\r\n        \r\n        private constant integer ALTERNATIVE02_SPELL_POWER_BONUS = -1\r\n        private constant integer ALTERNATIVE02_DURATION_BONUS = 4\r\n        \r\n        private constant integer ALTERNATIVE03_HEAL_PERCENT_BONUS = 2\r\n        \r\n        private constant string ANIMATION = \"DarkSwirl.mdx\"\r\n    endglobals\r\n\r\n    function Trig_WandererE_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel(GetSpellAbilityUnit(), ID_ABILITY) > 0 and combat( GetSpellAbilityUnit(), false, 0 ) and Ability_IsUnitAbility(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n    endfunction\r\n\r\n    private function EndBuff takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local integer p = LoadInteger( udg_hash, id, StringHash( \"wnde\" ) )\r\n        local unit hero = LoadUnitHandle( udg_hash, id, StringHash( \"wnde\" ) )\r\n        local integer heroId = GetHandleId( hero )\r\n        local real spellPower = LoadReal( udg_hash, heroId, StringHash( \"wnde\" ) )\r\n\r\n        call spdst(hero, -spellPower)\r\n        call UnitRemoveAbility( hero, EFFECT )\r\n        call UnitRemoveAbility( hero, BUFF )\r\n        call RemoveSavedReal( udg_hash, heroId, StringHash( \"wnde\" ) )\r\n        \r\n        call FlushChildHashtable( udg_hash, id )\r\n        \r\n        set hero = null\r\n    endfunction\r\n    \r\n    private function HealTick takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash(\"wanderer_e_heal\") )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash(\"wanderer_e_heal_caster\") )\r\n        local real healPercent = LoadReal( udg_hash, id, StringHash(\"wanderer_e_heal_percent\") )\r\n        local real durationLeft = LoadReal( udg_hash, id, StringHash(\"wanderer_e_heal_duration\") )\r\n        local real tickValue = LoadReal( udg_hash, id, StringHash(\"wanderer_e_heal_check\") )\r\n\r\n\t\tcall healst( caster, target, GetUnitState( target, UNIT_STATE_MAX_LIFE) * healPercent )\r\n        call manast( caster, target, GetUnitState( target, UNIT_STATE_MAX_MANA) * healPercent )\r\n\t\t\r\n\t\tset durationLeft = durationLeft - tickValue\r\n\t\tif durationLeft <= 0 or GetUnitAbilityLevel(target, EFFECT_HEAL) == 0 then\r\n\t\t\tcall UnitRemoveAbility( target, EFFECT_HEAL )\r\n        \tcall UnitRemoveAbility( target, BUFF_HEAL )\r\n\t\t\tcall DestroyTimer(GetExpiredTimer())\r\n\t\telse\r\n\t\t\tcall SaveReal( udg_hash, id, StringHash(\"wanderer_e_heal_duration\"), durationLeft )\r\n\t\tendif\r\n  \r\n        set target = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function AddHealBuff takes unit caster, unit target, real duration, real healPercent returns nothing \r\n    \tlocal integer id\r\n    \t\r\n    \tcall UnitAddAbility( target, EFFECT_HEAL)\r\n    \t\r\n    \tset id = InvokeTimerWithUnit(target, \"wanderer_e_heal\", HEAL_TICK, true, function HealTick )\r\n    \tcall SaveUnitHandle( udg_hash, id, StringHash(\"wanderer_e_heal_caster\"), caster )\r\n    \tcall SaveReal( udg_hash, id, StringHash(\"wanderer_e_heal_percent\"), healPercent )\r\n    \tcall SaveReal( udg_hash, id, StringHash(\"wanderer_e_heal_duration\"), duration )\r\n    \tcall SaveReal( udg_hash, id, StringHash(\"wanderer_e_heal_check\"), HEAL_TICK )\r\n        //call healst( caster, udg_hero[i], GetUnitState( udg_hero[i], UNIT_STATE_MAX_LIFE) * healPercent )\r\n        //call manast( caster, udg_hero[i], GetUnitState( udg_hero[i], UNIT_STATE_MAX_MANA) * healPercent )\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n\r\n    private function Alternative01 takes unit caster, real duration, real healPercent returns nothing \r\n        local integer id\r\n        local integer casterId = GetHandleId( caster )\r\n        local integer addSpellPower = SPELL_POWER_BONUS\r\n        local integer i\r\n        local real isum\r\n        \r\n        set duration = timebonus(caster, duration)\r\n        \r\n        call UnitAddAbility( caster, EFFECT)\r\n        call spdst( caster, addSpellPower )\r\n        set isum = LoadReal( udg_hash, casterId, StringHash( \"wnde\" ) ) + addSpellPower\r\n        \r\n        set id = InvokeTimerWithUnit(caster, \"wnde\", duration, false, function EndBuff)\r\n        call SaveReal( udg_hash, GetHandleId( caster ), StringHash( \"wnde\" ), isum )\r\n        \r\n        call AddHealBuff(caster, caster, duration, healPercent)\r\n        \r\n        set caster = null\r\n    endfunction\r\n\r\n    private function Alternative02 takes unit caster, real duration, real healPercent returns nothing \r\n        local integer id\r\n        local integer casterId = GetHandleId( caster )\r\n        local integer addSpellPower = SPELL_POWER_BONUS + ALTERNATIVE02_SPELL_POWER_BONUS\r\n        local integer i\r\n        local real isum\r\n        local real newDuration\r\n        \r\n        set duration = timebonus(caster, duration)\r\n        set newDuration = duration + ALTERNATIVE02_DURATION_BONUS\r\n        \r\n        call UnitAddAbility( caster, EFFECT)\r\n        call spdst( caster, addSpellPower )\r\n        set isum = LoadReal( udg_hash, casterId, StringHash( \"wnde\" ) ) + addSpellPower\r\n        \r\n        set id = InvokeTimerWithUnit(caster, \"wnde\", newDuration, false, function EndBuff)\r\n        call SaveReal( udg_hash, GetHandleId( caster ), StringHash( \"wnde\" ), isum )\r\n        \r\n        set i = 1\r\n        loop\r\n            exitwhen i > PLAYERS_LIMIT\r\n            if udg_hero[i] != caster and unitst( udg_hero[i], caster, TARGET_ALLY ) then\r\n                call AddHealBuff(caster, udg_hero[i], duration, healPercent)\r\n            endif\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function Alternative03 takes unit caster, real duration, real healPercent returns nothing \r\n        local integer i\r\n        \r\n        set healPercent = healPercent * ALTERNATIVE03_HEAL_PERCENT_BONUS\r\n        set i = 1\r\n        loop\r\n            exitwhen i > PLAYERS_LIMIT\r\n            if udg_hero[i] != caster and unitst( udg_hero[i], caster, TARGET_ALLY ) then\r\n            \tcall AddHealBuff(caster, udg_hero[i], duration, healPercent)\r\n            endif\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function Main takes unit caster, real duration, real healPercent returns nothing \r\n        local integer id\r\n        local integer casterId = GetHandleId( caster )\r\n        local integer addSpellPower = SPELL_POWER_BONUS\r\n        local integer i\r\n        local real isum\r\n        \r\n        set duration = timebonus(caster, duration)\r\n        \r\n        call UnitAddAbility( caster, EFFECT)\r\n        call spdst( caster, addSpellPower )\r\n        set isum = LoadReal( udg_hash, casterId, StringHash( \"wnde\" ) ) + addSpellPower\r\n        \r\n        set id = InvokeTimerWithUnit(caster, \"wnde\", duration, false, function EndBuff)\r\n        call SaveReal( udg_hash, GetHandleId( caster ), StringHash( \"wnde\" ), isum )\r\n        \r\n        set i = 1\r\n        loop\r\n            exitwhen i > PLAYERS_LIMIT\r\n            if udg_hero[i] != caster and unitst( udg_hero[i], caster, TARGET_ALLY ) then\r\n            \tcall AddHealBuff(caster, udg_hero[i], duration, healPercent)\r\n                //call healst( caster, udg_hero[i], GetUnitState( udg_hero[i], UNIT_STATE_MAX_LIFE) * healPercent )\r\n                //call manast( caster, udg_hero[i], GetUnitState( udg_hero[i], UNIT_STATE_MAX_MANA) * healPercent )\r\n            endif\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_WandererE_Actions takes nothing returns nothing\r\n        local unit caster = GetSpellAbilityUnit()\r\n        local integer lvl = GetUnitAbilityLevel(caster, 'A0LD')\r\n        local real duration = DURATION_FIRST_LEVEL + (DURATION_LEVEL_BONUS*lvl)\r\n        local real healPecrent = HEAL_PERCENT_FIRST_LEVEL+(HEAL_PERCENT_LEVEL_BONUS*lvl)\r\n        \r\n        if Aspects_IsHeroAspectActive( caster, ASPECT_01 ) then\r\n            call Alternative01( caster, duration, healPecrent )\r\n        elseif Aspects_IsHeroAspectActive( caster, ASPECT_02 ) then\r\n            call Alternative02( caster, duration, healPecrent )\r\n        elseif Aspects_IsHeroAspectActive( caster, ASPECT_03 ) then\r\n            call Alternative03( caster, duration, healPecrent )\r\n        else\r\n            call Main( caster, duration, healPecrent )\r\n        endif\r\n        \r\n        call DestroyEffect(AddSpecialEffectTarget(ANIMATION, caster, \"overhead\") )\r\n        \r\n        set caster = null\r\n    endfunction\r\n\r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        local unit hero = Event_DeleteBuff_Unit\r\n        local integer heroId = GetHandleId( hero )\r\n        local real spellPower = LoadReal( udg_hash, heroId, StringHash( \"wnde\" ) )\r\n\r\n        call spdst(hero, -spellPower)\r\n        call UnitRemoveAbility( hero, EFFECT )\r\n        call UnitRemoveAbility( hero, BUFF )\r\n        call RemoveSavedReal( udg_hash, heroId, StringHash( \"wnde\" ) )\r\n        \r\n        set hero = null\r\n    endfunction\r\n    \r\n    private function DeleteBuffHeal_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT_HEAL) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuffHeal takes nothing returns nothing\r\n        call UnitRemoveAbility( Event_DeleteBuff_Unit, EFFECT_HEAL )\r\n        call UnitRemoveAbility( Event_DeleteBuff_Unit, BUFF_HEAL )\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_WandererE = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_WandererE, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_WandererE, Condition( function Trig_WandererE_Conditions ) )\r\n        call TriggerAddAction( gg_trg_WandererE, function Trig_WandererE_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuffHeal, function DeleteBuffHeal_Conditions )\r\n    endfunction\r\n\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}