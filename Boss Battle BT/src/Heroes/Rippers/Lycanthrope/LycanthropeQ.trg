{
  "Id": 50333080,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope LycanthropeQ initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A1CJ'\r\n        \r\n        private constant integer STACK_LIMIT_FIRST_LEVEL = 1\r\n        private constant integer STACK_LIMIT_LEVEL_BONUS = 1\r\n        public constant integer DURATION = 15\r\n        private constant integer AREA = 400\r\n        \r\n        private constant real DAMAGE_BONUS = 0.05\r\n        \r\n        private constant integer EFFECT = 'A1CL'\r\n        private constant integer BUFF = 'B0A4'\r\n        \r\n        private constant integer ALT_DAMAGE_FIRST_LEVEL = 60\r\n        private constant integer ALT_DAMAGE_LEVEL_BONUS = 20\r\n        private constant real ALT_DAMAGE_BONUS = 0.1\r\n        \r\n        private constant integer ALT_EFFECT = 'A1CM'\r\n        private constant integer ALT_BUFF = 'B0A5'\r\n        \r\n        private constant real ALTERNATIVE_DAMAGE_BONUS = 0.03\r\n    \r\n        private constant string ANIMATION = \"Abilities\\\\Spells\\\\Items\\\\AIem\\\\AIemTarget.mdl\"\r\n    endglobals\r\n\r\n    function Trig_LycanthropeQ_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n    \r\n    private function HumanForm_End takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle(udg_hash, id, StringHash(\"lcnq\") )\r\n\r\n        call UnitRemoveAbility(target, EFFECT)\r\n        call UnitRemoveAbility(target, BUFF)\r\n        call RemoveSavedInteger( udg_hash, GetHandleId( target ), StringHash( \"lcnq\" ) )\r\n        call FlushChildHashtable( udg_hash, id )\r\n        \r\n        set target = null\r\n    endfunction\r\n    \r\n    private function WolfForm_End takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle(udg_hash, id, StringHash(\"lcnqa\") )\r\n\r\n        call UnitRemoveAbility(target, ALT_EFFECT)\r\n        call UnitRemoveAbility(target, ALT_BUFF)\r\n        call RemoveSavedInteger( udg_hash, GetHandleId( target ), StringHash( \"lcnqa\" ) )\r\n        call FlushChildHashtable( udg_hash, id )\r\n        \r\n        set target = null\r\n    endfunction\r\n    \r\n    private function WolfForm takes unit caster, integer level, integer stackLimit, real duration returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local real damageBonus\r\n        local integer currentStack\r\n        local real damage = ALT_DAMAGE_FIRST_LEVEL + (level*ALT_DAMAGE_LEVEL_BONUS)\r\n        local integer id\r\n    \r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, \"enemy\" ) then\r\n                call PlaySpecialEffect(ANIMATION, u)\r\n                call UnitTakeDamage(caster, u, damage, DAMAGE_TYPE_MAGIC)\r\n                if IsUnitAlive(u) then\r\n                    set id = GetHandleId(u)\r\n                    call UnitAddAbility(u, ALT_EFFECT)\r\n                    call InvokeTimerWithUnit(u, \"lcnqa\", duration, false, function WolfForm_End )\r\n                    set currentStack = IMinBJ( stackLimit, LoadInteger(udg_hash, id, StringHash(\"lcnqa\") ) + 1 )\r\n                    set damageBonus = ALT_DAMAGE_BONUS * currentStack\r\n                    call textst( \"|cFFDA5061\" + I2S(currentStack), u, 64, GetRandomReal( 80, 100 ), 12, 1 )\r\n                    \r\n                    call SaveInteger(udg_hash, id, StringHash(\"lcnqa\"), currentStack )\r\n                    call SaveReal(udg_hash, id, StringHash(\"lcnqa\"), damageBonus )\r\n                endif\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n    \r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function LycanthropeQ_Alternative takes unit caster, integer level, integer stackLimit, real duration returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local real damageBonus\r\n        local integer currentStack\r\n        local integer id\r\n        local real bonus = DAMAGE_BONUS + ALTERNATIVE_DAMAGE_BONUS\r\n    \r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, \"ally\" ) and u != caster then\r\n                call PlaySpecialEffect(ANIMATION, u)\r\n                set id = GetHandleId(u)\r\n                call UnitAddAbility(u, EFFECT)\r\n                call InvokeTimerWithUnit(u, \"lcnq\", duration, false, function HumanForm_End )\r\n                set currentStack = IMinBJ( stackLimit, LoadInteger(udg_hash, id, StringHash(\"lcnq\") ) + 1 )\r\n                set damageBonus = bonus * currentStack\r\n                call textst( \"|cFF57E5C6\" + I2S(currentStack), u, 64, GetRandomReal( 80, 100 ), 12, 1 )\r\n                \r\n                call SaveInteger(udg_hash, id, StringHash(\"lcnq\"), currentStack )\r\n                call SaveReal(udg_hash, id, StringHash(\"lcnq\"), damageBonus )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n    \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function LycanthropeQ_Main takes unit caster, integer level, integer stackLimit, real duration returns nothing\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local real damageBonus\r\n        local integer currentStack\r\n        local integer id\r\n    \r\n        call GroupEnumUnitsInRange( g, GetUnitX( caster ), GetUnitY( caster ), AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, \"ally\" ) then\r\n                call PlaySpecialEffect(ANIMATION, u)\r\n                set id = GetHandleId(u)\r\n                call UnitAddAbility(u, EFFECT)\r\n                call InvokeTimerWithUnit(u, \"lcnq\", duration, false, function HumanForm_End )\r\n                set currentStack = IMinBJ( stackLimit, LoadInteger(udg_hash, id, StringHash(\"lcnq\") ) + 1 )\r\n                set damageBonus = DAMAGE_BONUS * currentStack\r\n                call textst( \"|cFF57E5C6\" + I2S(currentStack), u, 64, GetRandomReal( 80, 100 ), 12, 1 )\r\n                \r\n                call SaveInteger(udg_hash, id, StringHash(\"lcnq\"), currentStack )\r\n                call SaveReal(udg_hash, id, StringHash(\"lcnq\"), damageBonus )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n    \r\n        call GroupClear( g )\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function HumanForm takes unit caster, integer level, integer stackLimit, real duration returns nothing\r\n        if Aspects_IsHeroAspectActive(caster, ASPECT_01) then\r\n            call LycanthropeQ_Alternative( caster, level, stackLimit, duration )\r\n        else\r\n            call LycanthropeQ_Main( caster, level, stackLimit, duration )\r\n        endif\r\n    \r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_LycanthropeQ_Actions takes nothing returns nothing\r\n        local integer lvl\r\n        local unit caster\r\n        local integer stackLimit\r\n        local real duration\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            set duration = udg_Time\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n            set duration = DURATION\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set duration = DURATION\r\n        endif\r\n        \r\n        set duration = timebonus(caster, duration)\r\n        set stackLimit = STACK_LIMIT_FIRST_LEVEL + (lvl*STACK_LIMIT_LEVEL_BONUS)\r\n        \r\n        if IsUnitHasAbility(caster, LycanthropeW_WOLF_BUFF) or LycanthropeE_WolfMode then\r\n            call WolfForm(caster, lvl, stackLimit, duration)\r\n        else\r\n            call HumanForm(caster, lvl, stackLimit, duration)\r\n        endif\r\n        \r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function OnDamageChange_Conditions_Alt takes nothing returns boolean\r\n        return GetUnitAbilityLevel( udg_DamageEventTarget, ALT_BUFF) > 0\r\n    endfunction\r\n    \r\n    private function OnDamageChange_Alt takes nothing returns nothing\r\n        local real bonusDamage = LoadReal(udg_hash, GetHandleId(udg_DamageEventTarget), StringHash(\"lcnqa\") )\r\n        \r\n        set udg_DamageEventAmount = udg_DamageEventAmount + (Event_OnDamageChange_StaticDamage * bonusDamage )\r\n    endfunction\r\n    \r\n    private function OnDamageChange_Conditions_01 takes nothing returns boolean\r\n        return GetUnitAbilityLevel( udg_DamageEventTarget, BUFF) > 0\r\n    endfunction\r\n    \r\n    private function OnDamageChange_01 takes nothing returns nothing\r\n        local real bonusDamage = LoadReal(udg_hash, GetHandleId(udg_DamageEventTarget), StringHash(\"lcnq\") )\r\n        \r\n        set udg_DamageEventAmount = udg_DamageEventAmount - (Event_OnDamageChange_StaticDamage * bonusDamage )\r\n    endfunction\r\n    \r\n    private function OnDamageChange_Conditions_02 takes nothing returns boolean\r\n        return GetUnitAbilityLevel( udg_DamageEventSource, BUFF) > 0\r\n    endfunction\r\n    \r\n    private function OnDamageChange_02 takes nothing returns nothing\r\n        local real bonusDamage = LoadReal(udg_hash, GetHandleId(udg_DamageEventSource), StringHash(\"lcnq\") )\r\n        \r\n        set udg_DamageEventAmount = udg_DamageEventAmount + (Event_OnDamageChange_StaticDamage * bonusDamage )\r\n    endfunction\r\n    \r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        local unit hero = Event_DeleteBuff_Unit\r\n\r\n        call UnitRemoveAbility( hero, EFFECT )\r\n        call UnitRemoveAbility( hero, BUFF )\r\n        \r\n        set hero = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_LycanthropeQ = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_LycanthropeQ, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_LycanthropeQ, Condition( function Trig_LycanthropeQ_Conditions ) )\r\n        call TriggerAddAction( gg_trg_LycanthropeQ, function Trig_LycanthropeQ_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_OnDamageChange_Real\", function OnDamageChange_Alt, function OnDamageChange_Conditions_Alt )\r\n        call CreateEventTrigger( \"Event_OnDamageChange_Real\", function OnDamageChange_01, function OnDamageChange_Conditions_01 )\r\n        call CreateEventTrigger( \"Event_OnDamageChange_Real\", function OnDamageChange_02, function OnDamageChange_Conditions_02 )\r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n        \r\n    endfunction\r\n\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}