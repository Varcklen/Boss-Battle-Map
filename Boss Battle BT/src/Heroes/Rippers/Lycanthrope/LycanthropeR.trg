{
  "Id": 50333083,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope LycanthropeR initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A1CN'\r\n        \r\n        private constant integer DURATION_FIRST_LEVEL = 5\r\n        private constant integer DURATION_LEVEL_BONUS = 1\r\n        private constant integer TICK = 1\r\n        private constant integer COST = 125\r\n        \r\n        private constant real HEAL_COUNT = 0.10\r\n        \r\n        private constant integer EFFECT = 'A1CP'\r\n        private constant integer BUFF = 'B0A7'\r\n        \r\n        private constant real ALT_DAMAGE_COUNT = 0.10\r\n        private constant real ALT_VAMPIRISM = 0.15\r\n        \r\n        private constant integer ALT_EFFECT = 'A1CQ'\r\n        private constant integer ALT_BUFF = 'B0A6'\r\n    \r\n        private constant string ANIMATION = \"AncientExplode1.mdx\"\r\n        private constant string ALT_ANIMATION = \"BarbarianSkinQ.mdx\"\r\n    endglobals\r\n\r\n    function Trig_LycanthropeR_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n    \r\n    \r\n    private function WolfForm_Tick takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle(udg_hash, id, StringHash(\"lcnrat\") )\r\n        local unit caster = LoadUnitHandle(udg_hash, id, StringHash(\"lcnratc\") )\r\n        local integer targetId = GetHandleId(target)\r\n        local real damage = ALT_DAMAGE_COUNT * LoadReal(udg_hash, targetId, StringHash(\"lcnra\") )\r\n\r\n        if IsUnitAlive(target) and IsUnitHasAbility(target, ALT_EFFECT)  then\r\n            call UnitTakeDamage(caster,target, damage, DAMAGE_TYPE_MAGIC)\r\n            call healst(caster, null, damage*ALT_VAMPIRISM )\r\n        else\r\n            call UnitRemoveAbility(target, ALT_EFFECT)\r\n            call UnitRemoveAbility(target, ALT_BUFF)\r\n            call FlushChildHashtable( udg_hash, id )\r\n        endif\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function WolfForm takes unit caster, unit target, integer level, real duration returns nothing\r\n        local integer id\r\n        local integer targetId = GetHandleId(target)\r\n\r\n        call PlaySpecialEffect(ALT_ANIMATION, target)\r\n        \r\n        call bufallst(caster, target, ALT_EFFECT, 0, 0, 0, 0, ALT_EFFECT, \"lcnra\", duration)\r\n        call RemoveSavedReal( udg_hash, targetId, StringHash( \"lcnra\" ) )\r\n        \r\n        set id = InvokeTimerWithUnit(target, \"lcnrat\", TICK, true, function WolfForm_Tick )\r\n        call SaveUnitHandle( udg_hash, id, StringHash(\"lcnratc\"), caster ) \r\n        \r\n        set target = null\r\n        set caster = null\r\n    endfunction\r\n\r\n\r\n    private function HumanForm_Tick takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit target = LoadUnitHandle(udg_hash, id, StringHash(\"lcnrt\") )\r\n        local unit caster = LoadUnitHandle(udg_hash, id, StringHash(\"lcnrtc\") )\r\n        local integer targetId = GetHandleId(target)\r\n        local real currentHeal = HEAL_COUNT * LoadReal(udg_hash, targetId, StringHash(\"lcnr\") )\r\n\r\n        if IsUnitAlive(target) and IsUnitHasAbility(target, EFFECT) then\r\n            call healst(caster, target, currentHeal )\r\n        else\r\n            call UnitRemoveAbility(target, EFFECT)\r\n            call UnitRemoveAbility(target, BUFF)\r\n            call FlushChildHashtable( udg_hash, id )\r\n        endif\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function HumanForm takes unit caster, unit target, integer level, real duration returns nothing\r\n        local integer id\r\n        local integer targetId = GetHandleId(target)\r\n\r\n        call PlaySpecialEffect(ANIMATION, target)\r\n        \r\n        call bufallst(caster, target, EFFECT, 0, 0, 0, 0, BUFF, \"lcnr\", duration)\r\n        call RemoveSavedReal( udg_hash, targetId, StringHash( \"lcnr\" ) )\r\n        \r\n        set id = InvokeTimerWithUnit(target, \"lcnrt\", TICK, true, function HumanForm_Tick )\r\n        call SaveUnitHandle( udg_hash, id, StringHash(\"lcnrtc\"), caster ) \r\n        \r\n        set target = null\r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_LycanthropeR_Actions takes nothing returns nothing\r\n        local integer lvl\r\n        local unit caster\r\n        local unit target\r\n        local real duration\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            set target = udg_Target\r\n            set duration = udg_Time\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n            set target = randomtarget( caster, 900, \"all\", \"\", \"\", \"\", \"\" )\r\n            if target == null then\r\n                set caster = null\r\n                return\r\n            endif\r\n            set duration = DURATION_FIRST_LEVEL + (lvl*DURATION_LEVEL_BONUS)\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set target = GetSpellTargetUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set duration = DURATION_FIRST_LEVEL + (lvl*DURATION_LEVEL_BONUS)\r\n        endif\r\n        \r\n        if IsUnitHasAbility(caster, LycanthropeW_WOLF_BUFF) or LycanthropeE_WolfMode then\r\n            call WolfForm(caster, target, lvl, duration)\r\n        else\r\n            call HumanForm(caster, target, lvl, duration)\r\n        endif\r\n        \r\n        if LycanthropeE_WolfMode == false then\r\n            call SetUnitState( caster, UNIT_STATE_LIFE, RMaxBJ(0,GetUnitState( caster, UNIT_STATE_LIFE) - COST ))\r\n        endif\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    \r\n    private function AfterDamageEvent_Conditions takes nothing returns boolean\r\n        return IsUnitHasAbility( udg_DamageEventTarget, ALT_EFFECT)\r\n    endfunction\r\n    \r\n    private function AfterDamageEvent takes nothing returns nothing\r\n        local real damageCount = LoadReal(udg_hash, GetHandleId(udg_DamageEventTarget), StringHash(\"lcnra\") )\r\n        \r\n        call SaveReal(udg_hash, GetHandleId(udg_DamageEventTarget), StringHash(\"lcnra\"), damageCount + udg_DamageEventAmount )\r\n    endfunction\r\n    \r\n    \r\n    private function AfterHeal_Conditions takes nothing returns boolean\r\n        return IsUnitHasAbility( Event_AfterHeal_Target, EFFECT)\r\n    endfunction\r\n    \r\n    private function AfterHeal takes nothing returns nothing\r\n        local real healCount = LoadReal(udg_hash, GetHandleId(Event_AfterHeal_Target), StringHash(\"lcnr\") )\r\n        \r\n        call SaveReal(udg_hash, GetHandleId(Event_AfterHeal_Target), StringHash(\"lcnr\"), healCount + Event_AfterHeal_Heal )\r\n    endfunction\r\n    \r\n    \r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        local unit hero = Event_DeleteBuff_Unit\r\n\r\n        call UnitRemoveAbility( hero, EFFECT )\r\n        call UnitRemoveAbility( hero, BUFF )\r\n        \r\n        set hero = null\r\n    endfunction\r\n    \r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_LycanthropeR = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_LycanthropeR, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_LycanthropeR, Condition( function Trig_LycanthropeR_Conditions ) )\r\n        call TriggerAddAction( gg_trg_LycanthropeR, function Trig_LycanthropeR_Actions )\r\n        \r\n        call CreateEventTrigger( \"udg_AfterDamageEvent\", function AfterDamageEvent, function AfterDamageEvent_Conditions )\r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n        call CreateEventTrigger( \"Event_AfterHeal_Real\", function AfterHeal, function AfterHeal_Conditions )\r\n    endfunction\r\n\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}