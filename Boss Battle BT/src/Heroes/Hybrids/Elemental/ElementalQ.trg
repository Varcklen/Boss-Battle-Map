{
  "Id": 50333214,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope ElementalQ initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A0J6'\r\n        \r\n        private constant integer DURATION = 15\r\n        private constant integer TICK = 1\r\n        private constant integer AREA = 325\r\n        private constant integer DAMAGE_FIRST_LEVEL = 12\r\n        private constant integer DAMAGE_LEVEL_BONUS = 4\r\n        private constant real VENOM_BONUS_FIRST_LEVEL = 0.25\r\n        private constant real VENOM_BONUS_LEVEL_BONUS = 0.15\r\n        \r\n        private constant real VENOS_EXTRA_BONUS_ALTERNATIVE = 2.5\r\n        \r\n        private constant integer EFFECT = 'A0K8'\r\n        private constant integer BUFF = 'B07Q'\r\n        \r\n        private constant string ANIMATION = \"Abilities\\\\Spells\\\\Undead\\\\DeathCoil\\\\DeathCoilSpecialArt.mdl\"\r\n    endglobals\r\n\r\n    function Trig_ElementalQ_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n\r\n    function ElementalQCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local real damage = LoadReal( udg_hash, id, StringHash( \"eleq\" ) )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"eleq\" ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"eleqc\" ) )\r\n        \r\n        if IsUnitAlive(target) and IsUnitHasAbility( target, EFFECT) then\r\n            if IsUnitHasAbility(target, 'B07R') and Aspects_IsHeroAspectActive( caster, ASPECT_03 ) == false then\r\n                call healst(caster, target, damage)\r\n            else\r\n                set IsDisableSpellPower = true\r\n                call UnitTakeDamage(caster, target, damage, DAMAGE_TYPE_MAGIC)\r\n            endif\r\n        else\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        endif\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function Alternative takes unit caster, real x, real y, real venomBonus, real duration returns nothing \r\n        local group g = CreateGroup()\r\n        local unit u\r\n\r\n        set venomBonus = venomBonus * VENOS_EXTRA_BONUS_ALTERNATIVE\r\n        call GroupEnumUnitsInRange( g, x, y, AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, TARGET_ALL ) then\r\n                call PlaySpecialEffect(ANIMATION, u) \r\n                call SaveReal( udg_hash, GetHandleId( u ), StringHash( \"eleqv\" ), venomBonus )\r\n                call bufst( caster, u, EFFECT, BUFF, \"eleq1\", duration )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n\r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function Main takes unit caster, real x, real y, real damage, real venomBonus, real duration returns nothing \r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local integer id\r\n    \r\n        call GroupEnumUnitsInRange( g, x, y, AREA, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, caster, TARGET_ALL ) then\r\n                call PlaySpecialEffect(ANIMATION, u) \r\n                if GetUnitAbilityLevel( u, EFFECT) == 0 then\r\n                    set id = InvokeTimerWithUnit( u, \"eleq\", TICK, true, function ElementalQCast )\r\n                    call SaveUnitHandle( udg_hash, id, StringHash( \"eleqc\" ), caster )\r\n                    call SaveReal( udg_hash, id, StringHash( \"eleq\" ), damage )\r\n                endif\r\n                call SaveReal( udg_hash, GetHandleId( u ), StringHash( \"eleqv\" ), venomBonus )\r\n                call bufst( caster, u, EFFECT, BUFF, \"eleq1\", duration )\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n        \r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set caster = null\r\n    endfunction\r\n\r\n    function Trig_ElementalQ_Actions takes nothing returns nothing\r\n        local unit caster\r\n        local integer lvl\r\n        local real x\r\n        local real y\r\n        local real t\r\n        local real dmg\r\n        local real venomBonus\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Target\r\n            set lvl = udg_Level\r\n            set x = GetLocationX( GetSpellTargetLoc() )\r\n            set y = GetLocationY( GetSpellTargetLoc() )\r\n            set t = udg_Time\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set lvl = udg_Level\r\n            set x = GetUnitX( caster ) + GetRandomReal( -650, 650 )\r\n            set y = GetUnitY( caster ) + GetRandomReal( -650, 650 )\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n            set t = DURATION\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set x = GetLocationX( GetSpellTargetLoc() )\r\n            set y = GetLocationY( GetSpellTargetLoc() )\r\n            set t = DURATION\r\n        endif\r\n        \r\n        set t = timebonus(caster, t)\r\n        set dmg = ( DAMAGE_FIRST_LEVEL + ( DAMAGE_LEVEL_BONUS * lvl ) ) * GetUnitSpellPower(caster)\r\n        set venomBonus = VENOM_BONUS_FIRST_LEVEL + ( VENOM_BONUS_LEVEL_BONUS * lvl )\r\n\r\n        if Aspects_IsHeroAspectActive( caster, ASPECT_01 ) then\r\n            call Alternative( caster, x, y, venomBonus, t )\r\n        else\r\n            call Main( caster, x, y, dmg, venomBonus, t )\r\n        endif\r\n        \r\n        set caster = null\r\n    endfunction\r\n    \r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return IsUnitHasAbility( Event_DeleteBuff_Unit, EFFECT)\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        local unit hero = Event_DeleteBuff_Unit\r\n\r\n        call UnitRemoveAbility( hero, EFFECT )\r\n        call UnitRemoveAbility( hero, BUFF )\r\n        \r\n        set hero = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_ElementalQ = CreateTrigger()\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_ElementalQ, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_ElementalQ, Condition( function Trig_ElementalQ_Conditions ) )\r\n        call TriggerAddAction( gg_trg_ElementalQ, function Trig_ElementalQ_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n    endfunction\r\n\r\nendscope \r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}