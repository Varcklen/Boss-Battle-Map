{
  "Id": 50333217,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope ElementalR initializer init\r\n\r\n    globals\r\n        private constant integer ID_ABILITY = 'A0KG'\r\n        \r\n        private constant integer DURATION = 20\r\n        private constant real DAMAGE_BONUS_FIRST_LEVEL = 0.06\r\n        private constant real DAMAGE_BONUS_LEVEL_BONUS = 0.06\r\n        private constant real MAGIC_DAMAGE_BONUS_FIRST_LEVEL = 0.06\r\n        private constant real MAGIC_DAMAGE_BONUS_LEVEL_BONUS = 0.06\r\n        \r\n        private constant integer EXTRA_DAMAGE_BONUS_ALTERNATIVE = 2\r\n        \r\n        private constant integer EFFECT = 'A0LO'\r\n        private constant integer BUFF = 'B07R'\r\n        \r\n        private constant string ANIMATION = \"Abilities\\\\Spells\\\\Undead\\\\UnholyFrenzyAOE\\\\UnholyFrenzyAOETarget.mdl\"\r\n    endglobals\r\n\r\n    function Trig_ElementalR_Conditions takes nothing returns boolean\r\n        return GetSpellAbilityId() == ID_ABILITY\r\n    endfunction\r\n\r\n    function ElementalRCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local unit target = LoadUnitHandle( udg_hash, id, StringHash( \"elemr\" ) )\r\n         \r\n        call UnitRemoveAbility( target, EFFECT )\r\n        call UnitRemoveAbility( target, BUFF )\r\n        call FlushChildHashtable( udg_hash, id )\r\n\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function AddEffect takes unit caster, unit target, real duration, real damageBonus, real magicDamageBonus returns nothing \r\n        local integer targetId = GetHandleId( target )\r\n        \r\n        call bufallst( caster, target, EFFECT, 0, 0, 0, 0, BUFF, \"elemr\", duration )\r\n        call SaveReal( udg_hash, targetId, StringHash( \"elemrd\" ), damageBonus )\r\n        call SaveReal( udg_hash, targetId, StringHash( \"elemrm\" ), magicDamageBonus )\r\n        call PlaySpecialEffect(ANIMATION, target)\r\n        \r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function Alternative takes unit caster, unit target, real duration, real damageBonus, real magicDamageBonus returns nothing \r\n        set damageBonus = damageBonus * EXTRA_DAMAGE_BONUS_ALTERNATIVE\r\n        call AddEffect (caster, target, duration, damageBonus, magicDamageBonus )\r\n        call AddEffect (caster, caster, duration, damageBonus, magicDamageBonus )\r\n    endfunction\r\n    \r\n    private function Main takes unit caster, unit target, real duration, real damageBonus, real magicDamageBonus returns nothing \r\n        call AddEffect (caster, target, duration, damageBonus, magicDamageBonus )\r\n        call AddEffect (caster, caster, duration, damageBonus, magicDamageBonus )\r\n    endfunction\r\n\r\n    function Trig_ElementalR_Actions takes nothing returns nothing\r\n        local unit caster\r\n        local unit target\r\n        local integer lvl\r\n        local real t\r\n        local real damageBonus\r\n        local real magicDamageBonus\r\n        \r\n        if CastLogic() then\r\n            set caster = udg_Caster\r\n            set target = udg_Target\r\n            set lvl = udg_Level\r\n            set t = udg_Time\r\n        elseif RandomLogic() then\r\n            set caster = udg_Caster\r\n            set target = randomtarget( caster, 900, \"ally\", \"hero\", \"\", \"\", \"\" )\r\n            set lvl = udg_Level\r\n            call textst( udg_string[0] + GetObjectName(ID_ABILITY), caster, 64, 90, 10, 1.5 )\r\n            set t = DURATION\r\n            if target == null then\r\n                set caster = null\r\n                return\r\n            endif\r\n        else\r\n            set caster = GetSpellAbilityUnit()\r\n            set target = GetSpellTargetUnit()\r\n            set lvl = GetUnitAbilityLevel(GetSpellAbilityUnit(), GetSpellAbilityId())\r\n            set t = DURATION\r\n        endif\r\n        \r\n        set damageBonus = DAMAGE_BONUS_FIRST_LEVEL+(DAMAGE_BONUS_LEVEL_BONUS*lvl)\r\n        set magicDamageBonus = MAGIC_DAMAGE_BONUS_FIRST_LEVEL+(MAGIC_DAMAGE_BONUS_LEVEL_BONUS*lvl)\r\n        \r\n        if Aspects_IsHeroAspectActive( caster, ASPECT_03 ) then\r\n        call Alternative( caster, target, t, damageBonus, magicDamageBonus )\r\n        else\r\n            call Main( caster, target, t, damageBonus, magicDamageBonus )\r\n        endif\r\n\r\n        set caster = null\r\n        set target = null\r\n    endfunction\r\n    \r\n    private function DeleteBuff_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( Event_DeleteBuff_Unit, EFFECT) > 0\r\n    endfunction\r\n    \r\n    private function DeleteBuff takes nothing returns nothing\r\n        local unit hero = Event_DeleteBuff_Unit\r\n\r\n        call UnitRemoveAbility( hero, EFFECT )\r\n        call UnitRemoveAbility( hero, BUFF )\r\n        \r\n        set hero = null\r\n    endfunction\r\n        \r\n    private function OnDamageChange_Magical_Conditions takes nothing returns boolean\r\n        return udg_IsDamageSpell and GetUnitAbilityLevel( udg_DamageEventTarget, EFFECT ) > 0\r\n    endfunction\r\n\r\n    private function OnDamageChange_Magical takes nothing returns nothing\r\n        local unit hero = udg_DamageEventTarget\r\n        local real magicDamageBonus = LoadReal( udg_hash, GetHandleId( hero ), StringHash( \"elemrm\" ) )\r\n        \r\n        set udg_DamageEventAmount = udg_DamageEventAmount + (Event_OnDamageChange_StaticDamage*magicDamageBonus)\r\n        \r\n        set hero = null\r\n    endfunction\r\n    \r\n    private function OnDamageChange_Conditions takes nothing returns boolean\r\n        return GetUnitAbilityLevel( udg_DamageEventSource, EFFECT ) > 0\r\n    endfunction\r\n\r\n    private function OnDamageChange takes nothing returns nothing\r\n        local unit hero = udg_DamageEventSource\r\n        local real damageBonus = LoadReal( udg_hash, GetHandleId( hero ), StringHash( \"elemrd\" ) )\r\n        \r\n        set udg_DamageEventAmount = udg_DamageEventAmount + (Event_OnDamageChange_StaticDamage*damageBonus)\r\n        \r\n        set hero = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        set gg_trg_ElementalR = CreateTrigger(  )\r\n        call TriggerRegisterAnyUnitEventBJ( gg_trg_ElementalR, EVENT_PLAYER_UNIT_SPELL_EFFECT )\r\n        call TriggerAddCondition( gg_trg_ElementalR, Condition( function Trig_ElementalR_Conditions ) )\r\n        call TriggerAddAction( gg_trg_ElementalR, function Trig_ElementalR_Actions )\r\n        \r\n        call CreateEventTrigger( \"Event_DeleteBuff_Real\", function DeleteBuff, function DeleteBuff_Conditions )\r\n        call CreateEventTrigger( \"Event_OnDamageChange_Real\", function OnDamageChange_Magical, function OnDamageChange_Magical_Conditions )\r\n        call CreateEventTrigger( \"Event_OnDamageChange_Real\", function OnDamageChange, function OnDamageChange_Conditions )\r\n    endfunction\r\n    \r\nendscope",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}