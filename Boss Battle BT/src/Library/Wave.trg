{
  "Id": 50332111,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "library Wave\r\n\r\n    globals\r\n        constant string WAVE_BASE_ANIMATION = \"Abilities\\\\Spells\\\\Orc\\\\Shockwave\\\\ShockwaveMissile.mdl\"\r\n        \r\n        unit Event_WaveHit_Caster\r\n        unit Event_WaveHit_Target\r\n        effect Event_WaveHit_Wave\r\n        \r\n        private effect tempEffect = null\r\n    endglobals\r\n    \r\n    private function AddGroupCount takes group waveGroup, boolean isAdded returns nothing\r\n        local integer count\r\n        local integer add = -1\r\n        \r\n        if waveGroup == null then\r\n            return\r\n        endif\r\n        \r\n        if isAdded then\r\n            set add = 1\r\n        endif\r\n        set count = LoadInteger( udg_hash, GetHandleId(waveGroup), StringHash( \"wavec\" ) ) + add\r\n        if count <= 0 then\r\n            call RemoveSavedReal( udg_hash, GetHandleId( waveGroup ), StringHash( \"wavec\" ) )\r\n            call GroupClear( waveGroup )\r\n            call DestroyGroup( waveGroup )\r\n        else\r\n            call SaveInteger( udg_hash, GetHandleId(waveGroup), StringHash( \"wavec\" ), count )\r\n        endif\r\n        \r\n        set waveGroup = null\r\n    endfunction\r\n\r\n    private function End takes integer id, effect wave returns nothing\r\n        local group nodmg = LoadGroupHandle( udg_hash, id, StringHash( \"waveg\" ) )\r\n        local group waveGroup = LoadGroupHandle( udg_hash, id, StringHash( \"wavewg\" ) )\r\n    \r\n        call AddGroupCount(waveGroup, false)\r\n        call DestroyEffect( wave )\r\n        call DestroyGroup( nodmg )\r\n        \r\n        set wave = null\r\n    endfunction\r\n    \r\n    private function DealDamage takes integer id, effect wave returns nothing\r\n        local unit mainer = LoadUnitHandle( udg_hash, id, StringHash( \"wavem\" ) )\r\n        local group nodmg = LoadGroupHandle( udg_hash, id, StringHash( \"waveg\" ) )\r\n        local group waveGroup = LoadGroupHandle( udg_hash, id, StringHash( \"wavewg\" ) )\r\n        local real area = LoadReal( udg_hash, id, StringHash( \"wavea\" ) )\r\n        local trigger usedTrigger = LoadTriggerHandle(udg_hash, id, StringHash( \"wavet\" ) )\r\n        local string targetRelation = LoadStr( udg_hash, id, StringHash( \"wavetr\" ) )\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        \r\n        call GroupEnumUnitsInRange( g, BlzGetLocalSpecialEffectX( wave ), BlzGetLocalSpecialEffectY( wave ), area, null )\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            if unitst( u, mainer, targetRelation ) and IsUnitInGroup( u, nodmg ) == false and IsUnitInGroup( u, waveGroup ) == false then\r\n                set Event_WaveHit_Caster = mainer\r\n                set Event_WaveHit_Target = u\r\n                set Event_WaveHit_Wave = wave\r\n                call TriggerExecute( usedTrigger )\r\n                call GroupAddUnit( nodmg, u )\r\n                if waveGroup != null then\r\n                    call GroupAddUnit( waveGroup, u )\r\n                endif\r\n            endif\r\n            call GroupRemoveUnit(g,u)\r\n        endloop\r\n        \r\n        call DestroyGroup( g )\r\n        set u = null\r\n        set g = null\r\n        set mainer = null\r\n        set nodmg = null\r\n        set wave = null\r\n        set waveGroup = null\r\n    endfunction\r\n    \r\n    private function ChangePosition takes integer id, effect wave returns nothing\r\n        local real speed = LoadReal( udg_hash, id, StringHash( \"waves\" ) )\r\n        local real yaw = LoadReal( udg_hash, id, StringHash( \"wavey\" ) )\r\n        local location waveLoc = Location( BlzGetLocalSpecialEffectX( wave ), BlzGetLocalSpecialEffectY( wave ) )\r\n        local location newLoc\r\n        \r\n        set newLoc = PolarProjectionBJ( waveLoc, speed, yaw )//GetMovedPoint( wave, yaw, speed )\r\n        call BlzSetSpecialEffectPositionLoc( wave, newLoc )\r\n        \r\n        call RemoveLocation( newLoc )\r\n        call RemoveLocation( waveLoc )\r\n        set newLoc = null\r\n        set waveLoc = null\r\n    endfunction\r\n\r\n    private function WaveUse takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer counter = LoadInteger( udg_hash, id, StringHash( \"wave\" ) ) + 1\r\n        local effect wave = LoadEffectHandle( udg_hash, id, StringHash( \"wave\" ) )\r\n        local integer range = LoadInteger( udg_hash, id, StringHash( \"waver\" ) )\r\n        \r\n        if counter >= range or wave == null then\r\n            call End(id, wave)\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        else\r\n            call ChangePosition(id, wave)\r\n            call DealDamage( id, wave )\r\n            call SaveInteger( udg_hash, id, StringHash( \"wave\" ), counter )\r\n        endif\r\n        \r\n        set wave = null\r\n    endfunction\r\n    \r\n    public function Create takes unit mainer, real x, real y, real angle, real tick, real area, integer range, real speed, string targetRelation, string waveAnimation, trigger usedTrigger, group waveGroup returns effect\r\n        local integer id\r\n        local group nodmg = CreateGroup()\r\n    \r\n        if waveAnimation == null or mainer == null or speed <= 0 or usedTrigger == null or targetRelation == null then\r\n            call BJDebugMsg(\"Warning! The wave cannot be created!\")\r\n            call BJDebugMsg(\"waveAnimation: \" + waveAnimation )\r\n            call BJDebugMsg(\"mainer: \" + GetUnitName(mainer))\r\n            call BJDebugMsg(\"speed: \" + R2S(speed))\r\n            call BJDebugMsg(\"targetRelation: \" + targetRelation)\r\n            if usedTrigger == null then\r\n                call BJDebugMsg(\"usedTrigger is null\")\r\n            endif\r\n            return null\r\n        endif\r\n        \r\n        set tempEffect = AddSpecialEffect( waveAnimation, x, y)\r\n        call BlzSetSpecialEffectYaw( tempEffect, Deg2Rad(angle) )\r\n        \r\n        set id = InvokeTimerWithEffect( tempEffect, \"wave\", tick, true, function WaveUse )\r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"wavem\" ), mainer )\r\n        call SaveReal( udg_hash, id, StringHash( \"wavey\" ), angle )\r\n        call SaveReal( udg_hash, id, StringHash( \"waves\" ), speed )\r\n        call SaveReal( udg_hash, id, StringHash( \"wavea\" ), area )\r\n        call SaveStr( udg_hash, id, StringHash( \"wavetr\" ), targetRelation )\r\n        call SaveInteger( udg_hash, id, StringHash( \"waver\" ), range )\r\n        call SaveGroupHandle( udg_hash, id, StringHash( \"waveg\" ), nodmg )\r\n        call SaveTriggerHandle(udg_hash, id, StringHash( \"wavet\" ), usedTrigger )\r\n        if waveGroup != null then\r\n            call SaveGroupHandle( udg_hash, id, StringHash( \"wavewg\" ), waveGroup )\r\n            call AddGroupCount(waveGroup, true)\r\n        endif\r\n    \r\n        set nodmg = null\r\n        return tempEffect\r\n    endfunction\r\nendlibrary\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}