{
  "Id": 50332103,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "library UniquesLib requires SetCount//, CorrectPlayerLib\r\n\r\n\tglobals\r\n\t\tunit Event_UniqueChanged_Unit\r\n\t\tinteger Event_UniqueChanged_OldUnique\r\n\t\treal Event_UniqueChanged = 0\r\n\tendglobals\r\n\t\r\n\tpublic function Get takes unit hero returns integer\r\n\t\tlocal integer index = GetUnitUserData(hero)\r\n\t\treturn udg_Ability_Uniq[index]\r\n\tendfunction\r\n\r\n    //Условие использования Uniques\r\n    function Uniques_Logic takes integer spell returns boolean\r\n        local integer cyclA = 1\r\n        local boolean l = false\r\n        \r\n        loop\r\n            exitwhen cyclA > 4\r\n            if spell == udg_Ability_Uniq[cyclA] then\r\n                set l = true\r\n                set cyclA = 4\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        return l\r\n    endfunction\r\n\r\n    function IsUniqueUpgraded takes unit u returns boolean\r\n        local boolean l = false\r\n        if LoadBoolean( udg_hash, GetHandleId( u ), StringHash( \"unique\" )) then\r\n            set l = true\r\n        endif\r\n        set u = null\r\n        return l\r\n    endfunction\r\n\r\n    function BeerUqCast takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local unit caster = LoadUnitHandle( udg_hash, id, StringHash( \"beeruq\" ) )\r\n        local integer ab = LoadInteger( udg_hash, id, StringHash( \"beeruq\" ) )\r\n        local integer rand\r\n        \r\n        if GetUnitAbilityLevel( caster, ab) == 0 then\r\n            call FlushChildHashtable( udg_hash, id )\r\n            call DestroyTimer( GetExpiredTimer() )\r\n        elseif udg_fightmod[0] and GetUnitState( caster, UNIT_STATE_LIFE) > 0.405 then\r\n            set udg_RandomLogic = true\r\n            set udg_Caster = caster\r\n            set udg_Level = 5\r\n            set rand = GetRandomInt( 1, 3 )\r\n            if rand == 1 then\r\n                call TriggerExecute( udg_DB_Trigger_One[GetRandomInt( 1, udg_Database_NumberItems[14])] )\r\n            elseif rand == 2 then\r\n                call TriggerExecute( udg_DB_Trigger_Two[GetRandomInt( 1, udg_Database_NumberItems[15])] )\r\n            else\r\n                call TriggerExecute( udg_DB_Trigger_Three[GetRandomInt( 1, udg_Database_NumberItems[16])] )\r\n            endif\r\n        endif\r\n        \r\n        set caster = null\r\n    endfunction\r\n\r\n    function NewUniques takes unit caster, integer uniq returns integer\r\n        local unit u = caster\r\n        local integer i = GetUnitUserData(u)\r\n        local integer cyclA\r\n        local integer cyclAEnd\r\n        local integer spnew\r\n        local boolean l\r\n        local integer unold \r\n        local integer id\r\n\r\n        /*if udg_logic[59] then\r\n            set i = CorrectPlayer(caster)\r\n            set u = caster\r\n            set udg_logic[59] = false\r\n        else\r\n            set u = udg_hero[GetPlayerId(GetOwningPlayer(caster)) + 1]\r\n            set i = GetPlayerId(GetOwningPlayer(u)) + 1\r\n        endif*/\r\n        \r\n        set unold = udg_Ability_Uniq[i]\r\n        set l = LoadBoolean( udg_hash, GetHandleId( u ), StringHash( \"unique\" ) )\r\n\r\n        set cyclA = 1\r\n        set cyclAEnd = udg_Database_NumberItems[13]\r\n        set spnew = uniq\r\n        loop\r\n            exitwhen cyclA > cyclAEnd\r\n            if uniq == udg_DB_Hero_SpecAb[cyclA] or uniq == udg_DB_Hero_SpecAbPlus[cyclA] then\r\n                if l then\r\n                    set spnew = udg_DB_Hero_SpecAbPlus[cyclA]\r\n                else\r\n                    set spnew = udg_DB_Hero_SpecAb[cyclA]\r\n                endif\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        \r\n        if unold == 'A0XI' then\r\n            call SetCount_AddPiece( u, SET_MECH, -2 )\r\n        endif\r\n        if unold == 'A0XK' then\r\n            call SetCount_AddPiece( u, SET_MECH, -5 )\r\n        endif\r\n        \r\n        call UnitRemoveAbility( u, udg_Ability_Uniq[i] )\r\n        set udg_Ability_Uniq[i] = spnew\r\n        call UnitAddAbility( u, udg_Ability_Uniq[i] )\r\n\r\n        if spnew == 'A0XI' then\r\n            call SetCount_AddPiece( u, SET_MECH, 2 )\r\n        endif\r\n        if spnew == 'A0XK' then\r\n            call SetCount_AddPiece( u, SET_MECH, 5 )\r\n        endif\r\n        if spnew == 'A15W' then\r\n            set id = GetHandleId( u )\r\n            if LoadTimerHandle( udg_hash, id, StringHash( \"beeruq\" ) ) == null then\r\n                call SaveTimerHandle( udg_hash, id, StringHash( \"beeruq\" ), CreateTimer() )\r\n            endif\r\n            set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"beeruq\" ) ) ) \r\n            call SaveUnitHandle( udg_hash, id, StringHash( \"beeruq\" ), u )\r\n            call SaveInteger( udg_hash, id, StringHash( \"beeruq\" ), spnew )\r\n            call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( u ), StringHash( \"beeruq\" ) ), 10, true, function BeerUqCast )\r\n        endif\r\n        if spnew == 'A15X' then\r\n            set id = GetHandleId( u )\r\n            if LoadTimerHandle( udg_hash, id, StringHash( \"beeruq\" ) ) == null then\r\n                call SaveTimerHandle( udg_hash, id, StringHash( \"beeruq\" ), CreateTimer() )\r\n            endif\r\n            set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"beeruq\" ) ) ) \r\n            call SaveUnitHandle( udg_hash, id, StringHash( \"beeruq\" ), u )\r\n            call SaveInteger( udg_hash, id, StringHash( \"beeruq\" ), spnew )\r\n            call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( u ), StringHash( \"beeruq\" ) ), 5, true, function BeerUqCast )\r\n        endif\r\n        \r\n        if spnew != 0 then\r\n            call BlzFrameSetVisible( uniqframe[i],true)\r\n            call BlzFrameSetTexture( uniqframe[i], BlzGetAbilityIcon(spnew),0, true)\r\n        else\r\n            call BlzFrameSetVisible( uniqframe[i],false)\r\n        endif\r\n        \r\n        set Event_UniqueChanged_Unit = u\r\n\t\tset Event_UniqueChanged_OldUnique = unold\r\n\t\tset Event_UniqueChanged = 1\r\n\t\tset Event_UniqueChanged = 0\r\n        \r\n        set caster = null\r\n        set u = null\r\n        return spnew\r\n    endfunction\r\n\r\n    function skillst takes integer k, integer i returns nothing\r\n        local unit u = udg_hero[k]\r\n        local integer g = LoadInteger( udg_hash, GetHandleId( u ), StringHash( \"unique\" ) ) + i\r\n        local boolean b = LoadBoolean( udg_hash, GetHandleId( u ), StringHash( \"unique\" ) )\r\n\r\n        call SaveInteger( udg_hash, GetHandleId( u ), StringHash( \"unique\" ), g )\r\n\r\n        if g >= 1 and not(b) then\r\n            call SaveBoolean( udg_hash, GetHandleId( u ), StringHash( \"unique\" ), true )\r\n            set udg_logic[59] = true\r\n            call NewUniques( u, udg_Ability_Uniq[k] )\r\n        elseif g < 1 and b then\r\n            call SaveBoolean( udg_hash, GetHandleId( u ), StringHash( \"unique\" ), false )\r\n            set udg_logic[59] = true\r\n            call NewUniques( u, udg_Ability_Uniq[k] )\r\n        endif\r\n\r\n        set u = null\r\n    endfunction\r\n\r\nendlibrary",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}