{
  "Id": 50332148,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "library SaveLoadStartLib requires GameStatus\r\n\r\n\tfunction ExpEnd takes nothing returns nothing\r\n\t    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n\t    local player p = LoadPlayerHandle( udg_hash, id, StringHash( \"exp2\" ) )\r\n\t    \r\n\t    if GetLocalPlayer() == p then\r\n\t        call BlzFrameSetVisible( expbar, false )\r\n\t        call BlzFrameSetVisible( expicon, false )\r\n\t    endif\r\n\t    call FlushChildHashtable( udg_hash, id )\r\n\t    \r\n\t    set p = null\r\n\tendfunction\r\n\t\r\n\tfunction ExpDo takes nothing returns nothing\r\n\t    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n\t    local integer oldexp = LoadInteger( udg_hash, id, StringHash( \"exp1old\" ) ) + 5\r\n\t    local integer expc = LoadInteger( udg_hash, id, StringHash( \"exp1give\" ) )\r\n\t    local integer oldlvl = LoadInteger( udg_hash, id, StringHash( \"exp1lvl\" ) )\r\n\t    local integer c = LoadInteger( udg_hash, id, StringHash( \"exp1\" ) ) + 5\r\n\t    local player p = LoadPlayerHandle( udg_hash, id, StringHash( \"exp1\" ) )\r\n\t    local integer ab1 \r\n\t    local integer ab2 \r\n\t    local integer id1\r\n\t    local integer needenexp = 0\r\n\t    \r\n\t    if c < expc then\r\n\t        call SaveInteger( udg_hash, id, StringHash( \"exp1\" ), c )\r\n\t        if oldlvl <= 20 then\r\n\t            set needenexp = udg_ExpNeeded[oldlvl]\r\n\t        else\r\n\t            set needenexp = udg_ExpNeeded[20] + (1000*(oldlvl-20))\r\n\t        endif\r\n\t        if oldexp < needenexp then\r\n\t            if GetLocalPlayer() == p then\r\n\t                call BlzFrameSetValue(BlzGetFrameByName(\"ExpBarEx\",1), RMinBJ(100,(oldexp*100)/needenexp) )\r\n\t                call BlzFrameSetText(BlzGetFrameByName(\"ExpBarExText\",1), I2S(oldexp)+\"/\"+I2S(needenexp))\r\n\t            endif\r\n\t        else\r\n\t            set oldexp = 0\r\n\t            set oldlvl = oldlvl + 1\r\n\t            if udg_ExpBonuses[oldlvl + 1] != 0 then\r\n\t                set ab1 = udg_ExpBonuses[oldlvl + 1]\r\n\t                set ab2 = udg_ExpBonuses[oldlvl]\r\n\t            else\r\n\t                set ab1 = 'A0RI'\r\n\t                set ab2 = 'A0RI'\r\n\t            endif\r\n\t            \r\n\t            call SaveInteger( udg_hash, id, StringHash( \"exp1lvl\" ), oldlvl )\r\n\t            call DestroyEffect( AddSpecialEffectTarget(\"Abilities\\\\Spells\\\\Human\\\\ReviveHuman\\\\ReviveHuman.mdl\", udg_hero[GetPlayerId(p) + 1], \"origin\" ) )\r\n\t            if GetLocalPlayer() == p then\r\n\t                if udg_ExpBonuses[oldlvl + 1] != 0 then\r\n\t                    call BlzFrameSetVisible( expfon, true )\r\n\t                    call BlzFrameSetVisible( expicon, true )\r\n\t                    call BlzFrameSetTexture( expicon, BlzGetAbilityIcon(ab1),0, true)\r\n\t                endif\r\n\t                call BlzFrameSetValue(BlzGetFrameByName(\"ExpBarEx\",1), 0 )\r\n\t                call BlzFrameSetText(BlzGetFrameByName(\"ExpBarExText\",1), I2S(oldexp)+\"/\"+I2S(needenexp))\r\n\t                if ab2 != 'A0RI' then\r\n\t                    call BlzFrameSetText( expword, BlzGetAbilityExtendedTooltip(ab2, 0) ) \r\n\t                endif\r\n\t            endif\r\n\t        endif\r\n\t        call SaveInteger( udg_hash, id, StringHash( \"exp1old\" ), oldexp )\r\n\t    else    \r\n\t        set id1 = GetHandleId( p )\r\n\t        if LoadTimerHandle( udg_hash, id1, StringHash( \"exp2\" ) ) == null  then\r\n\t            call SaveTimerHandle( udg_hash, id1, StringHash( \"exp2\" ), CreateTimer() )\r\n\t        endif\r\n\t        set id1 = GetHandleId( LoadTimerHandle(udg_hash, id1, StringHash( \"exp2\" ) ) )\r\n\t        call SavePlayerHandle( udg_hash, id1, StringHash( \"exp2\" ), p )\r\n\t        call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( p ), StringHash( \"exp2\" ) ), 10, false, function ExpEnd )\r\n\t        \r\n\t        call FlushChildHashtable( udg_hash, id )\r\n\t        call DestroyTimer( GetExpiredTimer() )\r\n\t    endif\r\n\t    \r\n\t    set p = null\r\n\tendfunction\r\n\t\r\n\tfunction ExpCast takes nothing returns nothing\r\n\t    local integer id = GetHandleId( GetExpiredTimer( ) )\r\n\t    local integer oldexp = LoadInteger( udg_hash, id, StringHash( \"expold\" ) )\r\n\t    local integer expc = LoadInteger( udg_hash, id, StringHash( \"expgive\" ) )\r\n\t    local integer oldlvl = LoadInteger( udg_hash, id, StringHash( \"explvl\" ) )\r\n\t    local player p = LoadPlayerHandle( udg_hash, id, StringHash( \"exp\" ) )\r\n\t    local integer id1 \r\n\t    local integer ab1 = 0\r\n\t    local boolean isIconVisible\r\n\t    \r\n\t    set isIconVisible = udg_ExpBonuses[oldlvl+1] != 0\r\n\t    if isIconVisible then\r\n\t        set ab1 = udg_ExpBonuses[oldlvl+1]\r\n\t    endif\r\n\t\r\n\t    if GetLocalPlayer() == p then\r\n\t        call BlzFrameSetVisible( expbar, true )\r\n\t        call BlzFrameSetVisible( expfon, false )\r\n\t        call BlzFrameSetText( expgive, \"|cffffcc00 +\" + I2S(expc) )\r\n\t        \r\n\t        call BlzFrameSetVisible( expicon, isIconVisible )\r\n\t        if isIconVisible then\r\n\t        \tcall BlzFrameSetTexture( expicon, BlzGetAbilityIcon(ab1),0, true)\r\n\t        endif\r\n\t    endif\r\n\t\r\n\t    set id1 = GetHandleId( p )\r\n\t    if LoadTimerHandle( udg_hash, id1, StringHash( \"exp1\" ) ) == null then\r\n\t        call SaveTimerHandle( udg_hash, id1, StringHash( \"exp1\" ), CreateTimer() )\r\n\t    endif\r\n\t    set id1 = GetHandleId( LoadTimerHandle(udg_hash, id1, StringHash( \"exp1\" ) ) )\r\n\t    call SaveInteger( udg_hash, id1, StringHash( \"exp1old\" ), oldexp )\r\n\t    call SaveInteger( udg_hash, id1, StringHash( \"exp1lvl\" ), oldlvl )\r\n\t    call SaveInteger( udg_hash, id1, StringHash( \"exp1give\" ), expc )\r\n\t    call SavePlayerHandle( udg_hash, id1, StringHash( \"exp1\" ), p )\r\n\t    call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( p ), StringHash( \"exp1\" ) ), 0.02, true, function ExpDo )\r\n\t\r\n\t    call FlushChildHashtable( udg_hash, id )\r\n\t    \r\n\t    set p = null\r\n\tendfunction\r\n\t\r\n\tfunction ExperienceCounting takes integer i, integer exp, player p returns nothing\r\n\t    local integer needenexp\r\n\t    local integer expst = exp\r\n\t    local integer expc = exp\r\n\t    local integer oldexp = udg_Exp[i]\r\n\t    local integer oldlvl = udg_LvL[i]\r\n\t    local integer id\r\n\t    \r\n\t    if udg_LvL[i] <= 20 then\r\n\t        set needenexp = udg_ExpNeeded[udg_LvL[i]]\r\n\t    else\r\n\t        set needenexp = udg_ExpNeeded[20] + (1000*(udg_LvL[i]-20))\r\n\t    endif\r\n\t    \r\n\t    set expc = expc + udg_ExtraExp[i]\r\n\t    if udg_HardNum > 0 and udg_Boss_LvL > 3 then\r\n\t        set expc = expc + R2I(expst*0.2*udg_HardNum)\r\n\t    endif\r\n\t    if udg_logic[101] and udg_Boss_LvL > 3 then\r\n\t        set expc = expc + R2I(expst*0.3)\r\n\t    endif\r\n\t    if udg_logic[6] and udg_Boss_LvL > 3 then\r\n\t        set expc = expc + R2I(expst*0.15)\r\n\t    endif\r\n\t    if udg_logic[78] then\r\n\t        set expc = expc + R2I(expst*0.15)\r\n\t    endif\r\n\t    if udg_Preset[9] then\r\n\t        set expc = expc - R2I(expst*0.4)\r\n\t    endif\r\n\t    if udg_BossChange then\r\n\t        set expc = expc - R2I(expst*0.8)\r\n\t    endif\r\n\t    if udg_worldmod[2] then\r\n\t        set expc = expc + R2I(expst*0.25)\r\n\t    endif\r\n\t    if udg_worldmod[6] then\r\n\t        set expc = expc + R2I(expst*0.5)\r\n\t    endif\r\n\t    if udg_worldmod[7] then\r\n\t        set expc = expc + R2I(expst*0.2)\r\n\t    endif\r\n\t    \r\n\t    if expc < 0 then\r\n\t        set expc = 0\r\n\t    endif\r\n\t    if expc > 0 then\r\n\t        set udg_Exp[i] = udg_Exp[i] + expc\r\n\t        if udg_Exp[i] >= needenexp then\r\n\t            set udg_Exp[i] = udg_Exp[i] - needenexp\r\n\t            set udg_LvL[i] = udg_LvL[i] + 1\r\n\t             \r\n\t            if udg_LvL[i] <= 20 then\r\n\t                set needenexp = udg_ExpNeeded[udg_LvL[i]]\r\n\t            else\r\n\t                set needenexp = udg_ExpNeeded[20] + (1000*(udg_LvL[i]-20))\r\n\t            endif\r\n\t            if udg_Exp[i] >= needenexp then\r\n\t                set udg_Exp[i] = needenexp - 5\r\n\t            endif\r\n\t        endif\r\n\t        \r\n\t        set id = GetHandleId( p )\r\n\t        if LoadTimerHandle( udg_hash, id, StringHash( \"exp\" ) ) == null  then\r\n\t            call SaveTimerHandle( udg_hash, id, StringHash( \"exp\" ), CreateTimer() )\r\n\t        endif\r\n\t        set id = GetHandleId( LoadTimerHandle(udg_hash, id, StringHash( \"exp\" ) ) )\r\n\t        call SaveInteger( udg_hash, id, StringHash( \"expold\" ), oldexp )\r\n\t        call SaveInteger( udg_hash, id, StringHash( \"explvl\" ), oldlvl )\r\n\t        call SaveInteger( udg_hash, id, StringHash( \"expgive\" ), expc )\r\n\t        call SavePlayerHandle( udg_hash, id, StringHash( \"exp\" ), p )\r\n\t        call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( p ), StringHash( \"exp\" ) ), 2, false, function ExpCast )\r\n\t    endif\r\n\tendfunction\r\n\t\r\n\tfunction SaveCoding takes integer i, integer exp, player p returns nothing\r\n\t    local integer cyclA = 1\r\n\t    local integer cyclAEnd\r\n\t    local integer cyclB\r\n\t    local integer cyclBEnd\r\n\t    local integer cyclC\r\n\t    local integer Con\r\n\t    local integer KeyInt = 0\r\n\t    local integer SumInt = 0\r\n\t    local string Char = \"\"\r\n\t    local string String = \"\"\r\n\t    local string Key = \"\"\r\n\t    local string EnString = \"\"\r\n\t    local string FinString = \"\"\r\n\t    local integer name\r\n\t    \r\n\t    if udg_LvL[i] < 100 then\r\n\t        call ExperienceCounting(i,exp, p)\r\n\t    endif\r\n\t    \r\n\t    if GetPlayerName(Player(0)) == \"WorldEdit\" then\r\n\t    \tcall BJDebugMsg(\"SaveCoding - Reminder: The file is not creates in debug mode.\")\r\n\t    \treturn\r\n\t    endif\r\n\t    \r\n\t    set cyclAEnd = udg_SaveLoadMaxCharacters - 1\r\n\t    loop\r\n\t        exitwhen cyclA > cyclAEnd\r\n\t        set udg_SaveLoadEncryptionNumbers[cyclA] = \"\"\r\n\t        set cyclA = cyclA + 1\r\n\t    endloop\r\n\t    set cyclA = 1\r\n\t    loop\r\n\t        exitwhen cyclA > 2\r\n\t        set udg_SaveLoadTempStrings[cyclA] = \"\"\r\n\t        set cyclA = cyclA + 1\r\n\t    endloop\r\n\t    set KeyInt = GetRandomInt(1, udg_SaveLoadMaxEncryptionSets)\r\n\t    set Key = udg_SaveLoadCharacterNumbers[KeyInt]\r\n\t    set cyclA = 1\r\n\t    set cyclAEnd = udg_SaveLoadMaxCharacters\r\n\t    loop\r\n\t        exitwhen cyclA > cyclAEnd\r\n\t        set udg_SaveLoadEncryptionNumbers[cyclA - 1] = SubString(udg_SaveLoadEncryptionSet[KeyInt], cyclA - 1, cyclA)\r\n\t        set cyclA = cyclA + 1\r\n\t    endloop\r\n\t    \r\n\t    set cyclC = 1\r\n\t    loop\r\n\t        exitwhen cyclC > 2\r\n\t        if cyclC == 1 then\r\n\t            set Con = udg_Exp[i]\r\n\t        elseif cyclC == 2 then\r\n\t            set Con = udg_LvL[i]\r\n\t        endif\r\n\t        set cyclA = 1\r\n\t        set cyclAEnd = udg_SaveLoadSlots[cyclC]\r\n\t        loop\r\n\t            exitwhen cyclA > cyclAEnd\r\n\t            set udg_SaveLoadPowerOfMaxNumber = 1\r\n\t            set cyclB = cyclA\r\n\t            set cyclBEnd = udg_SaveLoadSlots[cyclC] - 1\r\n\t            loop\r\n\t                exitwhen cyclB > cyclBEnd\r\n\t                set udg_SaveLoadPowerOfMaxNumber = udg_SaveLoadPowerOfMaxNumber * udg_SaveLoadMaxCharacters\r\n\t                set cyclB = cyclB + 1\r\n\t            endloop\r\n\t            if udg_SaveLoadSlots[cyclC] - cyclA >= 1 then\r\n\t                set udg_SaveLoadConversionDividedInt = Con / udg_SaveLoadPowerOfMaxNumber\r\n\t                set udg_SaveLoadConversionRemainder = Con - ( udg_SaveLoadConversionDividedInt * udg_SaveLoadPowerOfMaxNumber )\r\n\t                set udg_SaveLoadTempStrings[cyclC] = udg_SaveLoadTempStrings[cyclC] + udg_SaveLoadCharacterNumbers[udg_SaveLoadConversionDividedInt]\r\n\t            else\r\n\t                set udg_SaveLoadTempStrings[cyclC] = udg_SaveLoadTempStrings[cyclC] + udg_SaveLoadCharacterNumbers[udg_SaveLoadConversionRemainder]\r\n\t            endif\r\n\t            set Con = udg_SaveLoadConversionRemainder\r\n\t            set cyclA = cyclA + 1\r\n\t        endloop\r\n\t        set cyclC = cyclC + 1\r\n\t    endloop\r\n\t    \r\n\t    set cyclA = 1\r\n\t    loop\r\n\t        exitwhen cyclA > 2\r\n\t        set EnString = EnString + udg_SaveLoadTempStrings[cyclA]\r\n\t        set cyclA = cyclA + 1\r\n\t    endloop\r\n\t    \r\n\t    set cyclA = 1\r\n\t    set cyclAEnd = StringLength(EnString)\r\n\t    loop\r\n\t        exitwhen cyclA > cyclAEnd\r\n\t        set cyclB = 0\r\n\t        set cyclBEnd = udg_SaveLoadMaxCharacters - 1\r\n\t        loop\r\n\t            exitwhen cyclB > cyclBEnd\r\n\t            if SubString(EnString, cyclA - 1, cyclA) == udg_SaveLoadCharacterNumbers[cyclB] then\r\n\t                set SumInt = SumInt + cyclB\r\n\t            endif\r\n\t            set cyclB = cyclB + 1\r\n\t        endloop\r\n\t        set cyclA = cyclA + 1\r\n\t    endloop\r\n\t    set Con = SumInt\r\n\t    set udg_SaveLoadConversionDividedInt = Con / udg_SaveLoadMaxCharacters\r\n\t    set udg_SaveLoadConversionRemainder = Con - ( udg_SaveLoadConversionDividedInt * udg_SaveLoadMaxCharacters )\r\n\t    set Char = udg_SaveLoadCharacterNumbers[udg_SaveLoadConversionRemainder]\r\n\t    set EnString = EnString + Char\r\n\t\r\n\t    set name = StringLength(GetPlayerName( p ))\r\n\t    set cyclA = 1\r\n\t    loop\r\n\t        exitwhen cyclA > 2\r\n\t        set cyclB = 1\r\n\t        set cyclBEnd = udg_SaveLoadMaxCharacters\r\n\t        loop\r\n\t            exitwhen cyclB > cyclBEnd\r\n\t            if SubString(GetPlayerName(p), cyclA - 1, cyclA) == SubString((udg_SaveLoadEncryptionSet[1]), cyclB - 1, cyclB) then\r\n\t                set name = name + cyclB\r\n\t            endif\r\n\t            set cyclB = cyclB + 1\r\n\t        endloop\r\n\t        set cyclA = cyclA + 1\r\n\t    endloop\r\n\t    \r\n\t    set Con = name\r\n\t    set udg_SaveLoadConversionDividedInt = Con / udg_SaveLoadMaxCharacters\r\n\t    set udg_SaveLoadConversionRemainder = Con - ( udg_SaveLoadConversionDividedInt * udg_SaveLoadMaxCharacters )\r\n\t    set Char = udg_SaveLoadCharacterNumbers[udg_SaveLoadConversionRemainder]\r\n\t    set EnString = EnString + Char\r\n\t\r\n\t    set cyclA = 1\r\n\t    set cyclAEnd = StringLength(EnString)\r\n\t    loop\r\n\t        exitwhen cyclA > cyclAEnd\r\n\t        set cyclB = 0\r\n\t        set cyclBEnd = udg_SaveLoadMaxCharacters - 1\r\n\t        loop\r\n\t            exitwhen cyclB > cyclBEnd\r\n\t            if SubString(EnString, cyclA - 1, cyclA) == udg_SaveLoadCharacterNumbers[cyclB] then\r\n\t                set String = String + udg_SaveLoadEncryptionNumbers[cyclB]\r\n\t            endif\r\n\t            set cyclB = cyclB + 1\r\n\t        endloop\r\n\t        set Con = cyclA\r\n\t        set udg_SaveLoadConversionDividedInt = Con / udg_SaveLoadBlockSize\r\n\t        set udg_SaveLoadConversionRemainder = Con - ( udg_SaveLoadConversionDividedInt * udg_SaveLoadBlockSize )\r\n\t        if udg_SaveLoadConversionRemainder <= 0 then\r\n\t            set String = String + \"-\"\r\n\t        endif\r\n\t        set cyclA = cyclA + 1\r\n\t    endloop\r\n\t    set FinString = Key + \"-\" + String\r\n\t       \r\n\t    if GetLocalPlayer() == p then\r\n\t        call PreloadGenClear() \r\n\t        call PreloadGenStart()  \r\n\t        call Preload(\"\\\")\\ncall BlzSendSyncData(\\\"myprefix\\\", \\\"-load \"+(FinString)+\"\\\")//\" )\r\n\t        call PreloadGenEnd(\"BossBattleSave\\\\Boss Battle Progress.txt\" ) \r\n\t        \r\n\t        call PreloadGenClear() \r\n\t        call PreloadGenStart()  \r\n\t        call Preload(\"\\\")\\ncall BlzSendSyncData(\\\"myprefix\\\", \\\"-load \"+(FinString)+\"\\\")//\" )\r\n\t        call PreloadGenEnd(\"BossBattleSave\\\\Backup\\\\Boss Battle BackUp \" + GetPlayerName(p) + \" LvL \" + I2S(udg_LvL[i]) + \" Exp \" + I2S(udg_Exp[i]) + \" Key \" + I2S(GetRandomInt(1, 9999 )) + \".txt\" )\r\n\t    endif\r\n\tendfunction\r\n\t\r\n\tfunction SaveLoadStart takes nothing returns nothing\r\n\t    local integer i\r\n\t    local integer exp = 0\r\n\t    local player p\r\n\t    \r\n\t    if GameStatus_Get() == GAME_STATUS_ONLINE and udg_Endgame == 1 then\r\n\t        if udg_logic[43] then\r\n\t            set exp = 500\r\n\t            if udg_Multiboard_Time[3] == 0 then\r\n\t                set exp = exp + R2I( 400 * ( 1 - ( udg_Multiboard_Time[2] / 60 ) ) )\r\n\t            endif\r\n\t        elseif udg_logic[1] then\r\n\t            set exp = 50*(udg_Boss_LvL-1)\r\n\t        endif\r\n\t        \r\n\t        set i = 0\r\n\t        loop\r\n\t            exitwhen i > 3\r\n\t            set p = Player( i )\r\n\t            if GetPlayerSlotState( p ) == PLAYER_SLOT_STATE_PLAYING then\r\n\t                call SaveCoding( i + 1, exp, p)\r\n\t            endif\r\n\t            set i = i + 1\r\n\t        endloop\r\n\t    endif\r\n\t    \r\n\t    set p = null\r\n\tendfunction\r\n\r\nendlibrary",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}