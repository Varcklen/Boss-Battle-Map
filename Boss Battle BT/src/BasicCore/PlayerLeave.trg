{
  "Id": 50332126,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "library PlayerLeave requires SpellPower, BuffDeleteLib, TextLib\r\n\r\n    globals\r\n        real Event_PlayerLeave_Real\r\n        unit Event_PlayerLeave_Hero\r\n        player Event_PlayerLeave_Player\r\n        \r\n        \r\n        private boolean array IsPlayerLeave\r\n    endglobals\r\n    \r\n    public function IsPlayerLeaver takes player playerToCheck returns boolean\r\n    \treturn IsPlayerLeave[GetPlayerId( playerToCheck ) + 1]\r\n    endfunction\r\n\r\n    function PlayerLeaveTimer takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit u = LoadUnitHandle( udg_hash, id, StringHash( \"leave\" ) )\r\n        \r\n        call FlushChildHashtable( udg_hash, GetHandleId(u) )\r\n        call RemoveUnit( u )\r\n        call FlushChildHashtable( udg_hash, id )\r\n        \r\n        set u = null\r\n    endfunction\r\n\r\n    function AllDead takes nothing returns boolean\r\n        local integer cyclA = 1\r\n        local integer i = 0\r\n        local boolean l = false\r\n        \r\n        loop\r\n            exitwhen cyclA > 4\r\n            if GetUnitState(udg_hero[cyclA], UNIT_STATE_LIFE) <= 0.405 then\r\n                set i = i + 1\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        if i >= 4 then\r\n            set l = true\r\n        endif\r\n        return l\r\n    endfunction\r\n\r\n    function AllDeadPvP takes nothing returns integer\r\n        local integer cyclA = 1\r\n        local integer i = 0\r\n        local boolean l = false\r\n        \r\n        loop\r\n            exitwhen cyclA > 4\r\n            if GetUnitState(udg_hero[cyclA], UNIT_STATE_LIFE) <= 0.405 and GetPlayerSlotState( Player( cyclA - 1 ) ) == PLAYER_SLOT_STATE_PLAYING then\r\n                set i = i + 1\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        return i\r\n    endfunction\r\n    \r\n    private function DeleteItems takes unit hero returns nothing\r\n        local integer i = 0\r\n        local item it\r\n        \r\n        loop\r\n            exitwhen i > 5\r\n            set it = UnitItemInSlot(hero, i)\r\n            if it != null then\r\n                call UnitRemoveItem(hero, it)\r\n                call RemoveItem( it )\r\n            endif\r\n            set i = i + 1\r\n        endloop\r\n        set hero = null\r\n        set it = null\r\n    endfunction\r\n\r\n    public function Launch takes player pl, boolean isSimulation returns nothing\r\n        local integer i = GetPlayerId( pl ) + 1\r\n        local integer id = GetHandleId( udg_hero[i] )\r\n        local integer cyclA = 1\r\n        local integer m = GetPlayerState(pl, PLAYER_STATE_RESOURCE_GOLD)\r\n        local boolean array l\r\n        local group g = CreateGroup()\r\n        local unit u\r\n        local integer j\r\n        \r\n        set IsPlayerLeave[i] = true\r\n        loop\r\n            exitwhen cyclA > 3\r\n            set l[cyclA] = false\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        if udg_Host == pl then\r\n            set udg_Host = null\r\n        endif\r\n        call GroupRemoveUnit(udg_heroinfo, udg_hero[i])\r\n        call BlzFrameSetTexture( iconframe[i], \"war3mapImported\\\\BTNDivineShieldOff-Reforged.blp\", 0, true )\r\n        call BlzFrameSetVisible( uniqframe[i],false)\r\n        call BlzFrameSetVisible( specframe[i],false)\r\n        call RemoveUnit( udg_unit[i + 17] )\r\n        call RemoveUnit( udg_unit[i + 10] )\r\n        call RemoveUnit( udg_unit[i + 21] )\r\n        call RemoveUnit( udg_unit[i + 25] )\r\n        call RemoveUnit( udg_unit[i + 35] )\r\n        call BlzFrameSetVisible( faceframe[i],false)\r\n        set Event_PlayerLeave_Hero = udg_hero[i]\r\n        set Event_PlayerLeave_Player = pl\r\n        set Event_PlayerLeave_Real = 0.00\r\n        set Event_PlayerLeave_Real = 1.00\r\n        set Event_PlayerLeave_Real = 0.00\r\n\r\n        set udg_BossHP = udg_BossHP - 0.15\r\n        set udg_BossAT = udg_BossAT - 0.1\r\n        call SpellPower_AddBossSpellPower( -0.1 )\r\n\r\n        if udg_BossHP < 0.2  then\r\n            set udg_BossHP = 0.2\r\n        endif\r\n        if udg_BossAT < 0.2  then\r\n            set udg_BossAT = 0.2\r\n        endif\r\n\r\n        call DeleteItems(udg_hero[i])\r\n\r\n        set udg_Heroes_Amount = -1\r\n        set cyclA = 0\r\n        loop\r\n            exitwhen cyclA > 3\r\n            if GetPlayerSlotState( Player( cyclA ) ) == PLAYER_SLOT_STATE_PLAYING then\r\n                set udg_Heroes_Amount = udg_Heroes_Amount + 1\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        set udg_Player_Readiness = 0\r\n        set udg_Player_Color_Int[i] = 0\r\n        if udg_fightmod[3] and ( udg_unit[57] == udg_hero[i] or udg_unit[58] == udg_hero[i] ) then\r\n            call TriggerExecute( gg_trg_PA_End )\r\n        endif\r\n        call DisplayTimedTextToForce( bj_FORCE_ALL_PLAYERS, 5.00, ( \"Player \" + udg_Player_Color[i] + ( GetPlayerName(Player(i - 1)) + \"|r left game.\" ) ) )\r\n        if pl == Player(0) and GetOwningPlayer(udg_UNIT_CUTE_BOB) == Player(0) then\r\n            call DisplayTimedTextToForce( bj_FORCE_ALL_PLAYERS, 5.00, \"Set mode: |cffffcc00Players|r.\" )\r\n            call UnitAddAbility( udg_UNIT_CUTE_BOB, 'Ane2')\r\n            call SetUnitOwner( udg_UNIT_CUTE_BOB, Player(PLAYER_NEUTRAL_PASSIVE), true )\r\n            call SetUnitColor( udg_UNIT_CUTE_BOB, PLAYER_COLOR_PINK )\r\n        endif\r\n        if udg_logic[61] then\r\n            call DisableTrigger( gg_trg_KickDelPlayer )\r\n            call DisplayTimedTextToForce( bj_FORCE_ALL_PLAYERS, 5.00, \"Exclusion voting aborted\" )\r\n            call PauseTimer(udg_timer[0])\r\n            set udg_logic[61] = false\r\n            set cyclA = 1\r\n            loop\r\n                exitwhen cyclA > 4\r\n                set udg_logic[cyclA +66] = false\r\n                set cyclA = cyclA + 1\r\n            endloop\r\n        endif\r\n            /*set cyclA = 0\r\n            loop\r\n                exitwhen cyclA > 2\r\n                set j = ( 3 * i ) - cyclA\r\n                call RemoveItem( udg_item[j] )\r\n                call RemoveItem( udg_SantaItem[j] )\r\n                set udg_item[j] = null\r\n                set cyclA = cyclA + 1\r\n            endloop*/\r\n        set cyclA = 0\r\n        loop\r\n            exitwhen cyclA > 5\r\n            if GetItemType(UnitItemInSlot( udg_hero[i], cyclA )) == ITEM_TYPE_PERMANENT then\r\n                set m = m + 100\r\n            elseif GetItemType(UnitItemInSlot( udg_hero[i], cyclA )) == ITEM_TYPE_ARTIFACT then\r\n                set m = m + 300\r\n            elseif GetItemType(UnitItemInSlot( udg_hero[i], cyclA )) == ITEM_TYPE_CAMPAIGN then\r\n                set m = m + 200\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        set m = m / IMaxBJ( 1, udg_Heroes_Amount )\r\n        \r\n        set bj_livingPlayerUnitsTypeId = 'u000'\r\n        call GroupEnumUnitsOfPlayer(g, pl, filterLivingPlayerUnitsOfTypeId)\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            call RemoveUnit( u )\r\n            call GroupRemoveUnit(g,u)\r\n            set u = FirstOfGroup(g)\r\n        endloop\r\n\r\n        set cyclA = 1\r\n        loop\r\n            exitwhen cyclA > 4\r\n            //call DelBuff( udg_hero[cyclA], false )\r\n            call SetUnitOwner( udg_hero[cyclA], Player(cyclA - 1), true )\r\n            set udg_logic[cyclA + 36] = false\r\n            if GetPlayerSlotState(Player(cyclA - 1)) == PLAYER_SLOT_STATE_PLAYING and Player(cyclA - 1) != pl then\r\n                if udg_Host == null then\r\n                    set udg_Host = Player(cyclA - 1)\r\n                    call BlzFrameSetText( modeshostname, \"Host: \" + udg_Player_Color[GetPlayerId( udg_Host ) + 1] + GetPlayerName(udg_Host) + \"|r\" )\r\n                endif\r\n                call BlzFrameSetTexture( iconframe[cyclA], \"ReplaceableTextures\\\\CommandButtons\\\\BTNDivineShieldOff.blp\", 0, true )\r\n                call SetPlayerState(Player(cyclA - 1), PLAYER_STATE_RESOURCE_GOLD, GetPlayerState(Player(cyclA - 1), PLAYER_STATE_RESOURCE_GOLD) + m  )\r\n                if GetUnitState(udg_hero[cyclA], UNIT_STATE_LIFE) > 0.405 then\r\n                    call textst( \"|c00FFFF00 +\" + I2S( m ), udg_hero[cyclA], 64, 90, 10, 1 )\r\n                endif\r\n            endif\r\n            set udg_fightlogic[cyclA] = false\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        call BlzFrameSetTexture(butbk, \"ReplaceableTextures\\\\CommandButtons\\\\BTNArcaniteMelee.blp\", 0, true)\r\n        if not( IsVictory ) and not( udg_logic[1] ) then\r\n            call StartSound( gg_snd_SpellbreakerWarcry1 )\r\n            set udg_DPS[i] = 0\r\n            set udg_DamageFight[i] = 0\r\n            set udg_HealFight[i] = 0\r\n            set udg_ManaFight[i] = 0\r\n            set udg_ManaAllTime[i] = 0\r\n            set udg_HealAllTime[i] = 0\r\n            set udg_DamageAllTime[i] = 0\r\n            set udg_DamagedAllTime[i] = 0\r\n            set udg_DamagedFight[i] = 0\r\n            //call MultiSetValue( udg_multi, ( 3 * udg_Multiboard_Position[i] ) + 1, 15, \"0\" )\r\n            call MultiSetIcon( udg_multi, ( udg_Multiboard_Position[i] * 3 ) - 1, 3, \"ReplaceableTextures\\\\CommandButtons\\\\BTNCritterChicken.blp\" )\r\n            set cyclA = 0\r\n            loop\r\n                exitwhen cyclA > 2\r\n                call MultiSetIcon( udg_multi, ( udg_Multiboard_Position[i] * 3 ) + cyclA, 15, \"ReplaceableTextures\\\\CommandButtons\\\\BTNCancel.blp\" )\r\n                set cyclA = cyclA + 1\r\n            endloop\r\n            //set cyclA = 6\r\n            //loop\r\n                //exitwhen cyclA > 14\r\n                //call MultiSetValue( udg_multi, ( udg_Multiboard_Position[i] * 3 ) - 1, cyclA, \"0\" )\r\n                //set cyclA = cyclA + 1\r\n            //endloop\r\n        endif\r\n        /*if not( IsVictory ) then\r\n            call MMD_FlagPlayer(pl, MMD_FLAG_LEAVER)\r\n        endif*/\r\n        \r\n        set cyclA = 1\r\n        loop\r\n            exitwhen cyclA > 12\r\n            call MultiSetColor( udg_multi,( udg_Multiboard_Position[i] * 3 ) - 1, cyclA + 2, 70.00, 70.00, 70.00, 25.00 )\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        call ShowUnit(udg_hero[i], false)\r\n        \r\n        \r\n        /*if IsTriggerEnabled(gg_trg_HeroDeath) then\r\n            set l[1] = true\r\n            call DisableTrigger( gg_trg_HeroDeath )\r\n        endif*/\r\n        /*if IsTriggerEnabled(gg_trg_IA_End) then\r\n            set l[2] = true\r\n            call DisableTrigger( gg_trg_IA_End )\r\n        endif*/\r\n        /*if IsTriggerEnabled(gg_trg_AL_End) then\r\n            set l[3] = true\r\n            call DisableTrigger( gg_trg_AL_End )\r\n        endif*/\r\n        \r\n        call KillUnit( udg_hero[i] )\r\n        /*if l[1] then\r\n            call EnableTrigger( gg_trg_HeroDeath )\r\n            if AllDead() then\r\n                set udg_Heroes_Deaths = udg_Heroes_Amount - 1\r\n                call TriggerExecute( gg_trg_HeroDeath )\r\n            endif\r\n        endif*/\r\n        /*if l[2] then\r\n            call EnableTrigger( gg_trg_IA_End )\r\n            if AllDead() then\r\n                set udg_Heroes_Deaths = udg_Heroes_Amount - 1\r\n                call TriggerExecute( gg_trg_IA_End )\r\n            endif\r\n        endif*/\r\n        /*if l[3] then\r\n            call EnableTrigger( gg_trg_AL_End )\r\n            if AllDead() then\r\n                set udg_Heroes_Deaths = udg_Heroes_Amount - 1\r\n                call TriggerExecute( gg_trg_AL_End )\r\n            endif\r\n        endif*/\r\n        \r\n        //set udg_Heroes_Deaths = AllDeadPvP() - 1\r\n        call SaveTimerHandle( udg_hash, id, StringHash( \"leave\" ), CreateTimer() )\r\n        set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"leave\" ) ) ) \r\n        call SaveUnitHandle( udg_hash, id, StringHash( \"leave\" ), udg_hero[i] )\r\n        call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( udg_hero[i] ), StringHash( \"leave\" ) ), 0.5, false, function PlayerLeaveTimer )\r\n\r\n        /*set bj_livingPlayerUnitsTypeId = 'h01M'\r\n        call GroupEnumUnitsOfPlayer(g, pl, filterLivingPlayerUnitsOfTypeId)\r\n        loop\r\n            set u = FirstOfGroup(g)\r\n            exitwhen u == null\r\n            call RemoveUnit( u )\r\n            call GroupRemoveUnit(g,u)\r\n        endloop*/\r\n\r\n        if udg_Heroes_Amount == 1 then\r\n            call BlzFrameSetVisible( pvpbk,false)\r\n        endif\r\n        \r\n        call DestroyGroup( g )\r\n        set g = null\r\n        set u = null\r\n        set pl = null\r\n        set udg_hero[i] = null\r\n    endfunction\r\n    \r\n    private function action takes nothing returns nothing\r\n    \tcall Launch(GetTriggerPlayer(), false)\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    function InitTrig_PlayerLeave takes nothing returns nothing\r\n        local integer cyclA = 0\r\n        set gg_trg_PlayerLeave = CreateTrigger()\r\n        loop\r\n            exitwhen cyclA > 3\r\n            call TriggerRegisterPlayerEvent(gg_trg_PlayerLeave, Player(cyclA), EVENT_PLAYER_LEAVE)\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        call TriggerAddAction( gg_trg_PlayerLeave, function action )\r\n    endfunction\r\n    \r\nendlibrary",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}