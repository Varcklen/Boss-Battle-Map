{
  "Id": 50333699,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "scope PAStart initializer init\r\n\r\n    globals\r\n        private constant integer BATTLE_TIME = 120\r\n        private constant integer BUTTON_COOLDOWN = 3\r\n    endglobals\r\n\r\n    private function PA_TimerEnd takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n    \r\n        if udg_fightmod[3] then\r\n            call DisplayTimedTextToForce( bj_FORCE_ALL_PLAYERS, 5, \"The draw won.\" )\r\n            set udg_logic[62] = true\r\n            call TriggerExecute( gg_trg_PA_End )\r\n        endif\r\n        \r\n        call FlushChildHashtable( udg_hash, id )\r\n    endfunction\r\n    \r\n    public function BattleStart takes integer playerIndex, integer opponentIndex returns nothing\r\n        local integer id\r\n        local integer i\r\n\r\n        set udg_fightmod[0] = true\r\n        set udg_fightmod[3] = true\r\n        set udg_unit[57] = udg_hero[playerIndex]\r\n        set udg_unit[58] = udg_hero[opponentIndex]\r\n        call Between( \"start_PA\" )\r\n        set udg_Boss_Rect = gg_rct_RandomItem\r\n        set udg_Boss_BigRect = gg_rct_Vision3\r\n        call FightStart()\r\n        set udg_logic[36 + playerIndex] = false\r\n        set udg_logic[36 + opponentIndex] = false\r\n        set udg_combatlogic[playerIndex] = true\r\n        set udg_combatlogic[opponentIndex] = true\r\n        set udg_number[69 + playerIndex] = udg_number[69 + playerIndex] - 1\r\n        set udg_number[69 + opponentIndex] = udg_number[69 + opponentIndex] - 1\r\n        call UnitRemoveAbility( udg_UNIT_CUTE_BOB, 'A08B' )   \r\n        call SetPlayerAllianceStateBJ( GetOwningPlayer(udg_unit[57]), GetOwningPlayer(udg_unit[58]), bj_ALLIANCE_UNALLIED )\r\n        call SetPlayerAllianceStateBJ( GetOwningPlayer(udg_unit[58]), GetOwningPlayer(udg_unit[57]), bj_ALLIANCE_UNALLIED )\r\n    \r\n        set id = GetHandleId( udg_UNIT_CUTE_BOB )\r\n        if LoadTimerHandle( udg_hash, id, StringHash( \"PA\" ) ) == null  then\r\n            call SaveTimerHandle( udg_hash, id, StringHash( \"PA\" ), CreateTimer() )\r\n        endif\r\n        call TimerStart( LoadTimerHandle( udg_hash, id, StringHash( \"PA\" ) ), BATTLE_TIME, false, function PA_TimerEnd )\r\n\r\n        set bj_lastCreatedTimerDialog = CreateTimerDialog( LoadTimerHandle( udg_hash, GetHandleId( udg_UNIT_CUTE_BOB ), StringHash( \"PA\" ) ) )\r\n        call TimerDialogSetTitle(bj_lastCreatedTimerDialog, \"End of battle:\" )\r\n        call TimerDialogDisplay(bj_lastCreatedTimerDialog, true)\r\n        call EnableTrigger( gg_trg_PA_End )\r\n        \r\n        set i = 0\r\n        loop\r\n            exitwhen i > 1\r\n            call UnitRemoveAbility( udg_unit[57 + i], 'B00J' )\r\n            call PanCameraToTimedLocForPlayer( GetOwningPlayer(udg_unit[57+i]), udg_point[9+i], 0.00 )\r\n            call SetUnitPosition( udg_unit[57+i], GetLocationX(udg_point[9+i]), GetLocationY(udg_point[9+i] ) )\r\n            call SetUnitFacing( udg_unit[57+i], 180*i)\r\n            call DestroyEffect( AddSpecialEffect( \"Void Teleport Caster.mdx\", GetLocationX(udg_point[9+i]), GetLocationY(udg_point[9+i] ) ) )\r\n            if GetUnitAbilityLevel( udg_unit[57 + i], 'A0LK') > 0 then\r\n                call madness( udg_unit[57 + i], GetUnitAbilityLevel( udg_unit[57 + i], 'A0LK') )\r\n            endif\r\n            set i = i + 1\r\n        endloop\r\n    endfunction\r\n    \r\n    private function WaitForBattle takes player pl, integer playerIndex returns nothing\r\n        if GetLocalPlayer() == pl then\r\n            call BlzFrameSetTexture(pvpbk, \"ReplaceableTextures\\\\CommandButtons\\\\BTNCancel.blp\", 0, true)\r\n        endif\r\n        call DisplayTimedTextToForce( bj_FORCE_ALL_PLAYERS, 2, udg_Player_Color[playerIndex] + GetPlayerName( pl ) + \"|r ready for PvP-battle.\" )\r\n        \r\n        set pl = null\r\n    endfunction\r\n    \r\n    private function Use takes player mainPlayer, integer playerIndex returns nothing\r\n        local integer i\r\n        local integer opponentIndex = -1\r\n        local player opponent = null\r\n    \r\n        set udg_logic[36 + playerIndex] = true\r\n        set i = 1\r\n        loop\r\n            exitwhen i > 4 or opponentIndex != -1\r\n            if udg_logic[36 + i] and i != playerIndex then\r\n                set opponent = Player(i - 1)\r\n                set opponentIndex = GetPlayerId( opponent ) + 1\r\n            endif\r\n            set i = i + 1\r\n        endloop\r\n    \r\n        if GetPlayerSlotState(mainPlayer) == PLAYER_SLOT_STATE_PLAYING and GetPlayerSlotState(opponent) == PLAYER_SLOT_STATE_PLAYING and udg_logic[36 + playerIndex] and udg_logic[36 + opponentIndex] then\r\n            call BattleStart( playerIndex, opponentIndex )\r\n        else\r\n            call WaitForBattle( mainPlayer, playerIndex )\r\n        endif\r\n        \r\n        set mainPlayer = null\r\n        set opponent = null\r\n    endfunction\r\n    \r\n    private function End_Cooldown takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer( ) )\r\n        local player pl = LoadPlayerHandle( udg_hash, id, StringHash( \"cool\" ) )\r\n    \r\n        if GetLocalPlayer() == pl and udg_fightmod[0] == false then\r\n            call BlzFrameSetVisible(pvpbk, true)\r\n        endif\r\n        call FlushChildHashtable( udg_hash, id )\r\n        \r\n        set pl = null\r\n    endfunction\r\n    \r\n    private function Cancel takes player pl, integer playerIndex returns nothing\r\n        local integer id\r\n\r\n        if GetLocalPlayer() == pl then\r\n            call BlzFrameSetTexture(pvpbk, \"ReplaceableTextures\\\\CommandButtons\\\\BTNMassTeleport.blp\", 0, true)\r\n            call BlzFrameSetVisible(pvpbk, false)\r\n        endif\r\n        \r\n        set udg_logic[playerIndex + 36] = false\r\n        call DisplayTimedTextToForce( bj_FORCE_ALL_PLAYERS, 2, udg_Player_Color[playerIndex] + GetPlayerName( pl ) + \"|r cancels readiness for PvP-battle.\" )\r\n        \r\n        set id = GetHandleId( pl )\r\n        if LoadTimerHandle( udg_hash, id, StringHash( \"cool\" ) ) == null  then\r\n            call SaveTimerHandle( udg_hash, id, StringHash( \"cool\" ), CreateTimer() )\r\n        endif\r\n        set id = GetHandleId( LoadTimerHandle( udg_hash, id, StringHash( \"cool\" ) ) ) \r\n        call SavePlayerHandle(udg_hash, id, StringHash(\"cool\"), pl )\r\n        call TimerStart( LoadTimerHandle( udg_hash, GetHandleId( pl ), StringHash( \"cool\" ) ), BUTTON_COOLDOWN, false, function End_Cooldown )\r\n        \r\n        set pl = null\r\n    endfunction\r\n\r\n    private function PvPButtonClicked takes nothing returns nothing\r\n        local player pl = Event_PvPButtonClicked_Player \r\n        local integer i = GetPlayerId( pl ) + 1 \r\n\r\n        if udg_logic[36 + i] == false then\r\n            call Use( pl, i )\r\n        else\r\n            call Cancel( pl, i )\r\n        endif\r\n\r\n        set pl = null\r\n    endfunction\r\n\r\n    //===========================================================================\r\n    private function init takes nothing returns nothing\r\n        call CreateEventTrigger( \"Event_PvPButtonClicked_Real\", function PvPButtonClicked, null )\r\n    endfunction\r\nendscope\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}