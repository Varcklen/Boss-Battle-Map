{
  "Id": 50332077,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "library ItemRandomizerLib initializer init requires SetRaritySpawnLib, Trigger\r\n\r\n    globals \r\n        boolean IsItemsRefreshed = false\r\n\r\n        real Event_ItemRewardCreate_Real\r\n        unit Event_ItemRewardCreate_Hero\r\n        integer Event_ItemRewardCreate_Position\r\n        integer Event_ItemRewardCreate_ItemReward\r\n        \r\n        constant integer ITEM_RARITY_COMMON = 1\r\n        constant integer ITEM_RARITY_RARE = 2\r\n        constant integer ITEM_RARITY_LEGENDARY = 3\r\n        \r\n        private constant integer REWARD_CHOISE_PER_PLAYER = 3\r\n        private constant integer MAX_REWARD_AMOUNT = REWARD_CHOISE_PER_PLAYER * 4\r\n        \r\n        public item array Reward[13]\r\n        private boolean array AnyRewardSelectedThisRound[4]\r\n    endglobals\r\n    \r\n    private function IsItemExist takes integer rarity, integer index returns boolean\r\n        local integer i = 1\r\n\r\n        loop\r\n            exitwhen i > 4\r\n            if inv( udg_hero[i], DB_Items[rarity][index] ) > 0 then\r\n                return true\r\n            endif\r\n            set i = i + 1\r\n        endloop\r\n        return false\r\n    endfunction\r\n\r\n    function ItemCreate_ItemPosition takes integer c, integer index returns boolean\r\n        if index > 3 then\r\n            set index = 3\r\n        elseif index < 1 then\r\n            set index = 1\r\n        endif\r\n        return c == index or c == (3+index) or c == (6+index) or c == (9+index)\r\n    endfunction\r\n\r\n    function ItemCreate takes integer index, integer i, integer c returns nothing\r\n        local real x = GetLocationX(udg_itemcentr[c])\r\n        local real y = GetLocationY(udg_itemcentr[c])\r\n        local integer currentIndex = 0\r\n        \r\n        set Event_ItemRewardCreate_Hero = udg_hero[i]\r\n        set Event_ItemRewardCreate_Position = c\r\n        set Event_ItemRewardCreate_ItemReward = 0\r\n        \r\n        set Event_ItemRewardCreate_Real = 0.00\r\n        set Event_ItemRewardCreate_Real = 1.00\r\n        set Event_ItemRewardCreate_Real = 0.00\r\n        \r\n        set currentIndex = Event_ItemRewardCreate_ItemReward\r\n        \r\n        if inv(udg_hero[i], 'I01I') > 0 and ItemCreate_ItemPosition(c, 2) then\r\n            set currentIndex = udg_DB_Item_Destroyed[GetRandomInt(1,udg_DB_SetItems_Num[29])]\r\n        elseif inv(udg_hero[i], 'I0FT') > 0 and ItemCreate_ItemPosition(c, 3) then\r\n            set currentIndex = DB_SetItems[7][GetRandomInt(1,udg_DB_SetItems_Num[7])]\r\n        elseif udg_FutureBall[i] != 0 then\r\n            set currentIndex = udg_FutureBall[i]\r\n            set udg_FutureBall[i] = 0\r\n            call ChangeToolItem( udg_hero[i], 'I0FH', \"Future: \", \")|r\", \"Nothing\" )\r\n        \r\n        elseif currentIndex == 0 then\r\n            set currentIndex = index\r\n        endif\r\n        \r\n        if udg_modbad[25] and ItemCreate_ItemPosition(c, 1) and GetRandomInt(1, 3) == 1 then\r\n            set Reward[c] = CreateItem('I0FC', x, y)\r\n            call SaveInteger( udg_hash, GetHandleId(Reward[c]), StringHash( \"modbad25\" ), currentIndex )\r\n        else\r\n            set Reward[c] = CreateItem( currentIndex, x, y)\r\n        endif\r\n        \r\n        if GetItemType(Reward[c]) == ITEM_TYPE_ARTIFACT then\r\n            call SpecialEffectAngle( \"Abilities\\\\Spells\\\\Human\\\\Resurrect\\\\ResurrectCaster.mdl\", 270, x, y )\r\n        else\r\n            call DestroyEffect( AddSpecialEffect( \"Abilities\\\\Spells\\\\Human\\\\Polymorph\\\\PolyMorphDoneGround.mdl\", x, y ) )\r\n        endif\r\n        \r\n        if GetItemTypeId(Reward[c]) == 'I0FC' then\r\n            set udg_LastReward[c] = LoadInteger( udg_hash, GetHandleId(Reward[c]), StringHash( \"modbad25\" ) )\r\n        else\r\n            set udg_LastReward[c] = GetItemTypeId(Reward[c])\r\n        endif\r\n    endfunction\r\n\r\n    private function ItemSpawn takes boolean a, boolean b, boolean c, boolean d returns nothing\r\n        local integer array i\r\n        local boolean array k\r\n        local integer cyclA\r\n        local integer cyclB\r\n        local integer cyclBEnd\r\n        local integer cyclC\r\n        local boolean l\r\n        local integer j\r\n        local integer m\r\n        local boolean h\r\n        local integer f\r\n\r\n        set k[0] = a\r\n        set k[1] = b\r\n        set k[2] = c\r\n        set k[3] = d\r\n        \r\n        set cyclA = 1\r\n        loop\r\n            exitwhen cyclA > 4\r\n            if k[cyclA-1] then\r\n                set udg_ItemGetChoosed[cyclA] = false\r\n                set udg_ItemGetActive[cyclA] = true\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n        \r\n        //call BJDebugMsg(\"ItemSpawn udg_ItemGetActive[1]: \" + B2S(udg_ItemGetActive[1]))\r\n        \r\n        set i[1] = GetRandomInt(1, udg_Database_NumberItems[udg_itemrarity[1]])\r\n        set cyclA = 2\r\n        loop\r\n            exitwhen cyclA > MAX_REWARD_AMOUNT\r\n            set f = udg_itemrarity[cyclA]\r\n            set i[cyclA] = GetRandomInt(1, udg_Database_NumberItems[f])\r\n            if not(udg_Dublicate) and GetPlayerSlotState(Player((cyclA - 1)/3)) == PLAYER_SLOT_STATE_PLAYING then\r\n                set cyclB = 1\r\n                set cyclBEnd = cyclA - 1\r\n                loop\r\n                    exitwhen cyclB > cyclBEnd\r\n                    if i[cyclA] == i[cyclB] and f == udg_itemrarity[cyclB] and f != 0 then\r\n                        set cyclA = cyclA - 1\r\n                        set cyclB = cyclBEnd\r\n                    endif\r\n                    set cyclB = cyclB + 1\r\n                endloop\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n\r\n        set cyclA = 1\r\n        loop\r\n            exitwhen cyclA > MAX_REWARD_AMOUNT\r\n            set j = (cyclA - 1)/3\r\n            set f = udg_itemrarity[cyclA]\r\n            set m = 0\r\n            if GetPlayerSlotState(Player( j )) == PLAYER_SLOT_STATE_PLAYING and k[j] then\r\n                set cyclB = 1\r\n                loop\r\n                    exitwhen cyclB > 1\r\n                    set cyclC = 1\r\n                    set l = false\r\n                    loop\r\n                        exitwhen cyclC > MAX_REWARD_AMOUNT\r\n                        if GetItemTypeId(Reward[cyclC]) == DB_Items[f][i[cyclA]] then\r\n                            set l = true\r\n                            set cyclC = MAX_REWARD_AMOUNT\r\n                        endif\r\n                        set cyclC = cyclC + 1\r\n                    endloop\r\n                    set cyclC = 1\r\n                    loop\r\n                        exitwhen cyclC > 4\r\n                        if inv( udg_hero[cyclC], DB_Items[f][i[cyclA]] ) > 0 then\r\n                            set l = true\r\n                            set cyclC = 4\r\n                        endif\r\n                        set cyclC = cyclC + 1\r\n                    endloop\r\n                    if l and not(udg_Dublicate) and m < 10 then\r\n                        if i[cyclA] != 1 then\r\n                            set i[cyclA] = i[cyclA] - 1\r\n                            set m = m + 1\r\n                        else\r\n                            set i[cyclA] = udg_Database_NumberItems[f]\r\n                        endif\r\n                        set cyclB = cyclB - 1\r\n                    else\r\n                        call ItemCreate(DB_Items[f][i[cyclA]], j+1, cyclA )\r\n                    endif\r\n                    set cyclB = cyclB + 1\r\n                endloop\r\n            endif\r\n            set cyclA = cyclA + 1\r\n        endloop\r\n    endfunction\r\n\r\n    function ItemRandomizerAll takes unit caster, integer it returns item\r\n        local integer randl = GetRandomInt(1, 100)\r\n        local integer cyclA = 1\r\n        local integer rand\r\n\r\n        set udg_ItemBuf = null\r\n        if randl <= udg_RarityChance[3] then\r\n            loop\r\n                exitwhen cyclA > 1\r\n                set rand = GetRandomInt(1, udg_Database_NumberItems[3])\r\n                if IsItemExist( ITEM_RARITY_LEGENDARY, rand) then\r\n                    set cyclA  = cyclA - 1\r\n                else\r\n                    set udg_ItemBuf = CreateItem(DB_Items[3][rand], GetUnitX(caster), GetUnitY(caster) )\r\n                endif\r\n                set cyclA = cyclA  + 1\r\n            endloop\r\n        elseif randl >= udg_RarityChance[3]+1 and randl <= udg_RarityChance[2] then\r\n            loop\r\n                exitwhen cyclA > 1\r\n                set rand = GetRandomInt(1, udg_Database_NumberItems[2])\r\n                if IsItemExist( ITEM_RARITY_RARE, rand) then\r\n                    set cyclA  = cyclA - 1\r\n                else\r\n                    set udg_ItemBuf = CreateItem(DB_Items[2][rand], GetUnitX(caster), GetUnitY(caster) )\r\n                endif\r\n                set cyclA = cyclA + 1\r\n            endloop\r\n        elseif randl >= udg_RarityChance[2]+1 then\r\n            loop\r\n                exitwhen cyclA > 1\r\n                set rand = GetRandomInt(1, udg_Database_NumberItems[1])\r\n                if IsItemExist( ITEM_RARITY_COMMON, rand) then\r\n                    set cyclA  = cyclA - 1\r\n                else\r\n                    set udg_ItemBuf = CreateItem(DB_Items[1][rand], GetUnitX(caster), GetUnitY(caster) )\r\n                endif\r\n                set cyclA = cyclA  + 1\r\n            endloop\r\n        endif\r\n        if it == GetItemTypeId(udg_ItemBuf) then\r\n            call SetPlayerState(GetOwningPlayer(caster), PLAYER_STATE_RESOURCE_GOLD, GetPlayerState(GetOwningPlayer(caster), PLAYER_STATE_RESOURCE_GOLD) + 200 )\r\n        endif\r\n        if udg_ItemBuf != null then\r\n            call UnitAddItem( caster, udg_ItemBuf )\r\n            set bj_lastCreatedItem = udg_ItemBuf\r\n        endif\r\n        set caster = null\r\n        return udg_ItemBuf\r\n    endfunction\r\n\r\n    function ItemRandomizer takes unit caster, string str returns item\r\n        local integer rand = GetRandomInt(1, 100)\r\n        local integer cyclA = 1\r\n        local integer i\r\n        local integer it\r\n        local integer r\r\n        local integer k = 0\r\n        \r\n        set bj_lastCreatedItem = null\r\n        if UnitInventoryCount(caster) < 6 then \r\n            if str == \"legendary\" then\r\n                set i = 3\r\n            elseif str == \"rare\" then\r\n                set i = 2\r\n            elseif str == \"common\" then\r\n                set i = 1\r\n            endif\r\n            \r\n            loop\r\n                exitwhen cyclA > 1\r\n                set r = GetRandomInt(1, udg_Database_NumberItems[i])\r\n                if k < 12 and (( IsItemExist( ITEM_RARITY_LEGENDARY, r) and str == \"legendary\" ) or ( IsItemExist( ITEM_RARITY_RARE, r) and str == \"rare\" ) or ( IsItemExist( ITEM_RARITY_COMMON, r) and str == \"common\" )) then\r\n                    set cyclA  = cyclA - 1\r\n                    set k = k + 1\r\n                else\r\n                    if str == \"legendary\" then\r\n                        set it = DB_Items[3][r]\r\n                    elseif str == \"rare\" then\r\n                        set it = DB_Items[2][r]\r\n                    elseif str == \"common\" then\r\n                        set it = DB_Items[1][r]\r\n                    endif\r\n                    //bj_lastCreatedItem обязателен\r\n                    set bj_lastCreatedItem = CreateItem( it, GetUnitX(caster), GetUnitY(caster) )\r\n                    call UnitAddItem( caster, bj_lastCreatedItem )\r\n                endif\r\n                set cyclA = cyclA  + 1\r\n            endloop\r\n        endif\r\n        set caster = null\r\n        return bj_lastCreatedItem\r\n    endfunction\r\n    \r\n    //Return set item\r\n    function ItemRandomizerSet takes unit caster, integer it, integer settag, integer salvage returns item\r\n        local integer rand = GetRandomInt(1, udg_DB_SetItems_Num[settag])\r\n        set udg_ItemBuf = null\r\n        set udg_ItemBuf = CreateItem(DB_SetItems[settag][rand], GetUnitX(caster), GetUnitY(caster) )\r\n        if it == GetItemTypeId(udg_ItemBuf) then\r\n            call SetPlayerState(GetOwningPlayer(caster), PLAYER_STATE_RESOURCE_GOLD, GetPlayerState(GetOwningPlayer(caster), PLAYER_STATE_RESOURCE_GOLD) + salvage )\r\n        endif\r\n        if udg_ItemBuf != null then\r\n            call UnitAddItem( caster, udg_ItemBuf )\r\n            set bj_lastCreatedItem = udg_ItemBuf\r\n        endif\r\n        set caster = null\r\n        return udg_ItemBuf\r\n    endfunction\r\n\r\n    function ItemRandomizerItemId takes unit caster, string str returns integer\r\n        local integer rand = GetRandomInt(1, 100)\r\n        local integer cyclA = 1\r\n        local integer i\r\n        local integer it = 0\r\n        local integer r\r\n        local integer k = 0\r\n        \r\n        if str == \"legendary\" then\r\n            set i = 3\r\n        elseif str == \"rare\" then\r\n            set i = 2\r\n        elseif str == \"common\" then\r\n            set i = 1\r\n        endif\r\n        \r\n        loop\r\n            exitwhen cyclA > 1\r\n            set r = GetRandomInt(1, udg_Database_NumberItems[i])\r\n            if k < 12 and (( IsItemExist( ITEM_RARITY_LEGENDARY, r) and str == \"legendary\" ) or ( IsItemExist( ITEM_RARITY_RARE, r) and str == \"rare\" ) or ( IsItemExist( ITEM_RARITY_COMMON, r) and str == \"common\" )) then\r\n                set cyclA  = cyclA - 1\r\n                set k = k + 1\r\n            else\r\n                if str == \"legendary\" then\r\n                    set it = DB_Items[3][r]\r\n                elseif str == \"rare\" then\r\n                    set it = DB_Items[2][r]\r\n                elseif str == \"common\" then\r\n                    set it = DB_Items[1][r]\r\n                endif\r\n            endif\r\n            set cyclA = cyclA  + 1\r\n        endloop\r\n        \r\n        set caster = null\r\n        return it\r\n    endfunction\r\n\r\n    private function Randomizer takes boolean a, boolean b, boolean c, boolean d returns nothing\r\n        local integer cyclA = 1\r\n        local integer cyclB\r\n        local integer rand\r\n        local integer j \r\n        local boolean l = false\r\n\r\n        if a and b and c and d then\r\n            set l = true\r\n        endif\r\n        \r\n        if l and udg_logic[98] and not(udg_logic[76]) then\r\n            call SetRaritySpawn( udg_RarityChance[3]+20, udg_RarityChance[2]+20 )\r\n        endif\r\n\r\n        if not( udg_worldmod[1] ) and not( udg_worldmod[8] ) then\r\n            set cyclA = 1\r\n            loop\r\n                exitwhen cyclA > 12 \r\n                set j = ( ( cyclA - 1 ) / 3 ) + 1\r\n                set udg_itemrarity[cyclA] = 0\r\n                if GetPlayerSlotState(Player( j - 1 )) == PLAYER_SLOT_STATE_PLAYING and not( inv( udg_hero[j], 'I0AC' ) > 0 and not(udg_logic[GetPlayerId( GetOwningPlayer( udg_hero[j] ) ) + 1 + 26]) and ( cyclA == 2 or cyclA == 5 or cyclA == 8 or cyclA == 11 ) ) then\r\n                    set rand = GetRandomInt(1, 100)\r\n                    if rand <= udg_RarityChance[3] or ( udg_logic[76] and l ) then\r\n                        set udg_itemrarity[cyclA] = 3\r\n                    elseif ( rand > udg_RarityChance[3] and rand <= udg_RarityChance[2] ) or ( inv( udg_hero[j], 'I0BU' ) > 0 and (cyclA == 3 or cyclA == 6 or cyclA == 9 or cyclA == 12) ) then\r\n                        set udg_itemrarity[cyclA] = 2\r\n                    elseif rand > udg_RarityChance[2] then\r\n                        set udg_itemrarity[cyclA] = 1\r\n                    endif\r\n                endif\r\n                set cyclA = cyclA + 1\r\n            endloop\r\n            call ItemSpawn( a,b,c,d)\r\n        endif\r\n        \r\n        if l and udg_logic[98] and not(udg_logic[76]) then\r\n            set udg_logic[98] = false\r\n            call SetRaritySpawn( udg_RarityChance[3]-20, udg_RarityChance[2]-20 )\r\n            call IconFrameDel( \"Rarity\" )\r\n        endif\r\n        \r\n        if udg_logic[76] and l then\r\n            set udg_logic[76] = false\r\n            call IconFrameDel( \"LegBook\" )\r\n        endif\r\n    endfunction\r\n    \r\n    public function RemoveRewards takes player playerUsed returns nothing\r\n    \tlocal integer index = GetConvertedPlayerId(playerUsed)\r\n        local integer itemSlot\r\n        local item itemToDelete\r\n        local integer i = 0\r\n\r\n        loop\r\n            exitwhen i > 2\r\n            set itemSlot = ( 3 * index ) - i\r\n            set itemToDelete = Reward[itemSlot]\r\n            if Reward[itemSlot] != null then\r\n\t            call DestroyEffect( AddSpecialEffect( \"Abilities\\\\Spells\\\\Human\\\\Polymorph\\\\PolyMorphDoneGround.mdl\", GetItemX(itemToDelete), GetItemY(itemToDelete) ) )\r\n\t            call RemoveItem( itemToDelete )\r\n            endif\r\n            set Reward[itemSlot] = null\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        set itemToDelete = null\r\n    endfunction\r\n    \r\n    public function AllRemoveRewards takes nothing returns nothing\r\n    \tlocal integer i = 0\r\n    \tlocal player PlayerCheck\r\n    \t\r\n    \tloop\r\n    \t\texitwhen i > 3\r\n    \t\tset PlayerCheck = Player(i)\r\n    \t\tif GetPlayerSlotState(PlayerCheck) == PLAYER_SLOT_STATE_PLAYING then\r\n    \t\t\tcall RemoveRewards(PlayerCheck)\r\n    \t\tendif\r\n    \t\tset i = i + 1\r\n\t\tendloop\r\n    \t\r\n    \tset PlayerCheck = null\r\n    endfunction\r\n\r\n    public function RefreshItems takes player playerUsed returns nothing\r\n    \tlocal integer index = GetConvertedPlayerId(playerUsed)\r\n    \t\r\n        call RemoveRewards(playerUsed)\r\n        \r\n        set IsItemsRefreshed = true\r\n        if index == 1 then\r\n            call Randomizer(true,false,false,false)\r\n        elseif index == 2 then\r\n            call Randomizer(false,true,false,false)\r\n        elseif index == 3 then\r\n            call Randomizer(false,false,true,false)\r\n        elseif index == 4 then\r\n            call Randomizer(false,false,false,true)\r\n        endif\r\n        set IsItemsRefreshed = false\r\n        \r\n        set playerUsed = null\r\n\tendfunction\r\n\t\r\n\tpublic function IsRewardExist takes player playerUsed returns boolean\r\n\t\tlocal integer index = GetPlayerId( playerUsed ) + 1\r\n\t\tlocal integer triple = REWARD_CHOISE_PER_PLAYER * index\r\n\t\tlocal integer i = 0\r\n\t\t\r\n\t\tset playerUsed = null\r\n\t\tloop\r\n\t\t\texitwhen i >= REWARD_CHOISE_PER_PLAYER\r\n\t\t\tif Reward[triple - i] != null then\r\n\t\t\t\treturn true\r\n\t\t\tendif\r\n\t\t\tset i = i + 1\r\n\t\tendloop\r\n\t\treturn false\r\n\tendfunction\r\n\t\r\n\tpublic function IsAnyRewardExist takes nothing returns boolean\r\n\t\tlocal integer i = 1\r\n\t\t\r\n\t\tloop\r\n\t\t\texitwhen i > MAX_REWARD_AMOUNT\r\n\t\t\tif Reward[i] != null then\r\n\t\t\t\treturn true\r\n\t\t\tendif\r\n\t\t\tset i = i + 1\r\n\t\tendloop\r\n\t\treturn false\r\n\tendfunction\r\n\t\r\n\tpublic function IsAnyRewardSelectedThisRound takes player playerUsed returns boolean\r\n\t\tlocal integer index = GetPlayerId( playerUsed )\r\n\t\treturn AnyRewardSelectedThisRound[index]\r\n\tendfunction\r\n\t\r\n\t//================================================================\r\n\tprivate function OnBossFightWin_Delay takes nothing returns nothing\r\n\t\tlocal integer i = 0\r\n\t\tloop\r\n\t\t\texitwhen i >= 4\r\n\t\t\tset AnyRewardSelectedThisRound[i] = false\r\n\t\t\tset i = i + 1\r\n\t\tendloop\r\n\t\tcall Randomizer(true,true,true,true)\r\n\tendfunction\r\n\t\r\n\tprivate function OnBossFightWin takes nothing returns nothing\r\n\t\tcall TimerStart(CreateTimer(), 0.01, false, function OnBossFightWin_Delay )\r\n\tendfunction\r\n\t\r\n\tprivate function OnRewardTaken takes nothing returns nothing\r\n\t\tlocal integer index = GetPlayerId( Event_RewardTaken_Player )\r\n\t\tset AnyRewardSelectedThisRound[index] = true\r\n\tendfunction\r\n\t\r\n\tprivate function OnPlayerLeave takes nothing returns nothing\r\n\t\tcall RemoveRewards(Event_PlayerLeave_Player)\r\n\tendfunction\r\n\t\r\n\tprivate function init takes nothing returns nothing\r\n\t\tcall CreateEventTrigger( \"Event_PlayerLeave_Real\", function OnPlayerLeave, null )\r\n\t\tcall CreateEventTrigger( \"Event_MainBattleWin\", function OnBossFightWin, null )\r\n\t\tcall CreateEventTrigger( \"Event_RewardTaken\", function OnRewardTaken, null )\r\n\tendfunction\r\n\t\r\nendlibrary",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}