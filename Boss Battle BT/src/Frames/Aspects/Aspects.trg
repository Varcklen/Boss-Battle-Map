{
  "Id": 50332333,
  "Comment": "",
  "IsScript": true,
  "RunOnMapInit": false,
  "Script": "library AspectFrames initializer init requires Tooltip, Aspects, Trigger\r\n    globals \r\n        private framehandle AspectBackground = null \r\n        private trigger TriggerAspectBackGround = null \r\n        private framehandle AspectVision = null \r\n        \r\n        private framehandle array AspectButton[4]\r\n        private framehandle array BackdropAspect[4]\r\n        private trigger array TriggerAspect[4]\r\n        string array AspectName[PLAYERS_LIMIT_ARRAYS][4]//players/aspect position\r\n        string array AspectDescription[PLAYERS_LIMIT_ARRAYS][4]//players/aspect position\r\n        \r\n        framehandle ChoosedAspect = null \r\n        private trigger TriggerChoosedAspect = null \r\n        \r\n        private constant string ASPECT_CANCEL_NAME = \"Disable Aspect\"\r\n        private constant string ASPECT_CANCEL_DESCRIPTION = \"You turn off the current aspect. It will no longer give positive and negative effects.\"\r\n        \r\n        real Event_AspectAdded_Real\r\n        integer Event_AspectAdded_Key01\r\n        integer Event_AspectAdded_Key02\r\n        unit Event_AspectAdded_Hero\r\n        \r\n        real Event_AspectRemoved_Real\r\n        integer Event_AspectRemoved_Key01\r\n        integer Event_AspectRemoved_Key02\r\n        unit Event_AspectRemoved_Hero\r\n        \r\n        integer array ChoosedAspect[5]\r\n    endglobals\r\n\r\n    public function SetAspectButtons takes player localPlayer, integer whichButton, integer aspectAbility returns nothing \r\n        local integer playerIndex = GetPlayerId(localPlayer)\r\n    \r\n        if whichButton < 1 or whichButton > 3 then\r\n            call BJDebugMsg(\"Error! You are trying to access an AspectButton button that does not exist. You cannot change its description. Please contact the developer. Current: \" + I2S(whichButton))\r\n            return\r\n        endif\r\n        set AspectName[playerIndex][whichButton] = BlzGetAbilityTooltip(aspectAbility, 0)\r\n        set AspectDescription[playerIndex][whichButton] = BlzGetAbilityExtendedTooltip(aspectAbility, 0)\r\n\r\n        if GetLocalPlayer() == localPlayer then\r\n            call BlzFrameSetTexture(BackdropAspect[whichButton], BlzGetAbilityIcon(aspectAbility), 0, true) \r\n        endif\r\n        \r\n        set localPlayer = null\r\n    endfunction \r\n    \r\n    private function AddAspect takes unit hero, integer key01, integer key02 returns nothing\r\n        if IsAspectActive[key01][key02] == false then\r\n            set IsAspectActive[key01][key02] = true\r\n            //call BJDebugMsg(\"add key 01 02: \" + I2S(key01) + \" \" + I2S(key02))\r\n            \r\n            set Event_AspectAdded_Key01 = key01\r\n            set Event_AspectAdded_Key02 = key02\r\n            set Event_AspectAdded_Hero = hero\r\n            \r\n            set Event_AspectAdded_Real = 0.00\r\n            set Event_AspectAdded_Real = 1.00\r\n            set Event_AspectAdded_Real = 0.00\r\n        endif\r\n        \r\n        set hero = null\r\n    endfunction \r\n    \r\n    private function EnableHeroAspectTimer takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local unit hero = LoadUnitHandle( udg_hash, id, StringHash( \"acpe\" ) )\r\n        local integer heroIndex = LoadInteger( udg_hash, id, StringHash( \"acpe\" ) )\r\n        local integer usedButton = LoadInteger( udg_hash, id, StringHash( \"acpeb\" ) )\r\n        \r\n        call AddAspect(hero, heroIndex, usedButton)\r\n        \r\n        set hero = null\r\n    endfunction\r\n    \r\n    private function EnableHeroAspect takes player owner, integer heroIndex, integer usedButton returns nothing\r\n        local integer id\r\n        \r\n        set id = InvokeTimerWithUnit(udg_hero[GetPlayerId(owner) + 1], \"acpe\", 0.02, false, function EnableHeroAspectTimer )\r\n        call SaveInteger( udg_hash, id, StringHash( \"acpe\" ), heroIndex )\r\n        call SaveInteger( udg_hash, id, StringHash( \"acpeb\" ), usedButton)\r\n\r\n        set owner = null\r\n    endfunction \r\n    \r\n    private function RemoveAspect takes unit hero, integer key01, integer key02 returns nothing\r\n        if IsAspectActive[key01][key02] == true then\r\n            set IsAspectActive[key01][key02] = false\r\n            //call BJDebugMsg(\"remove key 01 02: \" + I2S(key01) + \" \" + I2S(key02))\r\n            \r\n            set Event_AspectRemoved_Key01 = key01\r\n            set Event_AspectRemoved_Key02 = key02\r\n            set Event_AspectRemoved_Hero = hero\r\n            \r\n            set Event_AspectRemoved_Real = 0.00\r\n            set Event_AspectRemoved_Real = 1.00\r\n            set Event_AspectRemoved_Real = 0.00\r\n        endif\r\n        \r\n        set hero = null\r\n    endfunction \r\n    \r\n    private function DisableHeroAspectsTimer takes nothing returns nothing\r\n        local integer id = GetHandleId( GetExpiredTimer() )\r\n        local integer i = 0\r\n        local unit hero = LoadUnitHandle( udg_hash, id, StringHash( \"acpc\" ) )\r\n        local integer heroIndex = LoadInteger( udg_hash, id, StringHash( \"acpc\" ) )\r\n        \r\n        set i = 1\r\n        loop\r\n            exitwhen i > ASPECT_LIMIT\r\n            call RemoveAspect(hero, heroIndex, i)\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        set hero = null\r\n    endfunction\r\n    \r\n    private function DisableHeroAspects takes player owner, integer heroIndex returns nothing\r\n        local integer id\r\n        \r\n        set id = InvokeTimerWithUnit(udg_hero[GetPlayerId(owner) + 1], \"acpc\", 0.01, false, function DisableHeroAspectsTimer )\r\n        call SaveInteger( udg_hash, id, StringHash( \"acpc\" ), heroIndex )\r\n\r\n        set owner = null\r\n    endfunction \r\n    \r\n    //Buttons\r\n    private function UseButton takes integer usedButton returns nothing\r\n        local player owner = GetTriggerPlayer()\r\n        local integer playerIndex = GetPlayerId(owner) + 1\r\n        local integer heroIndex = udg_HeroNum[playerIndex]\r\n        if usedButton < 0 or usedButton > 3 then\r\n            call BJDebugMsg(\"Invalid AspectButton button pressed. Please notify the map developer about this. Current button: \" + I2S(usedButton) + \".\")\r\n            return\r\n        endif\r\n        //call BJDebugMsg(\"used button: \" + I2S(usedButton))\r\n        call DisableHeroAspects(owner, heroIndex)\r\n        if usedButton != 0 then\r\n            call EnableHeroAspect(owner, heroIndex, usedButton)\r\n            set ChoosedAspect[playerIndex] = Aspect[heroIndex][usedButton]\r\n        else\r\n            set ChoosedAspect[playerIndex] = 0\r\n        endif\r\n        \r\n        if GetLocalPlayer() == owner then\r\n            call BlzFrameSetEnable(AspectButton[usedButton], false) \r\n            call BlzFrameSetEnable(AspectButton[usedButton], true) \r\n            call BlzFrameSetAllPoints(ChoosedAspect, AspectButton[usedButton])\r\n            if usedButton > 0 then\r\n                call BlzFrameSetVisible( AspectVision, true )\r\n                call BlzFrameSetTexture(AspectVision, BlzGetAbilityIcon(ChoosedAspect[playerIndex]), 0, true)\r\n            else\r\n                call BlzFrameSetVisible( AspectVision, false )\r\n            endif\r\n        endif\r\n        \r\n        set owner = null\r\n    endfunction \r\n    \r\n    function Aspect0Func takes nothing returns nothing \r\n        call UseButton(0)\r\n    endfunction \r\n     \r\n    function Aspect1Func takes nothing returns nothing \r\n        call UseButton(1)\r\n    endfunction \r\n     \r\n    function Aspect2Func takes nothing returns nothing \r\n        call UseButton(2)\r\n    endfunction \r\n     \r\n    function Aspect3Func takes nothing returns nothing \r\n        call UseButton(3)\r\n    endfunction \r\n    \r\n    //Tooltip\r\n    private function TooltipEnable takes integer index returns nothing \r\n        local player owner = GetTriggerPlayer()\r\n        local integer playerIndex = GetPlayerId(owner)\r\n    \r\n        /*if GetLocalPlayer() == owner then\r\n            call BlzFrameSetVisible( TooltipBackdrop, true )\r\n        endif*/\r\n        call Tooltip_SetLocalTooltipText(owner, AspectName[playerIndex][index], AspectDescription[playerIndex][index])\r\n        \r\n        set owner = null\r\n    endfunction \r\n    \r\n    private function TooltipEnable0 takes nothing returns nothing \r\n        call TooltipEnable(0)\r\n    endfunction\r\n    \r\n    private function TooltipEnable1 takes nothing returns nothing \r\n        call TooltipEnable(1)\r\n    endfunction\r\n    \r\n    private function TooltipEnable2 takes nothing returns nothing \r\n        call TooltipEnable(2)\r\n    endfunction\r\n    \r\n    private function TooltipEnable3 takes nothing returns nothing \r\n        call TooltipEnable(3)\r\n    endfunction\r\n   \r\n    //Events\r\n    private function IsHeroHasAspects takes unit hero returns boolean \r\n        local boolean hasAspect = false\r\n        \r\n        if Aspects_IsHeroCanUseAspects(hero) then\r\n            set hasAspect = true\r\n        endif\r\n        \r\n        set hero = null\r\n        return hasAspect\r\n    endfunction \r\n    \r\n    //OnBattleStart\r\n    private function Aspects_Start_Actions takes nothing returns nothing \r\n        call BlzFrameSetVisible( AspectBackground, false )\r\n    endfunction\r\n    \r\n    //OnBattleEnd\r\n    private function Aspects_End_Condition takes nothing returns boolean\r\n        return IsHeroHasAspects(udg_FightEnd_Unit)\r\n    endfunction\r\n    \r\n    private function Aspects_End_Actions takes nothing returns nothing \r\n        if GetLocalPlayer() == GetOwningPlayer(udg_FightEnd_Unit) then\r\n            call BlzFrameSetVisible( AspectBackground, true )\r\n        endif\r\n    endfunction\r\n    \r\n    //OnHeroRepick\r\n    private function Aspects_Repick_Actions takes nothing returns nothing \r\n        local integer heroIndex = udg_HeroNum[GetUnitUserData(Event_HeroRepick_Hero)]\r\n        if GetLocalPlayer() == GetOwningPlayer(Event_HeroRepick_Hero) then\r\n            call BlzFrameSetVisible( AspectBackground, false )\r\n            call BlzFrameSetAllPoints(ChoosedAspect, AspectButton[0])\r\n        endif\r\n        call DisableHeroAspects(GetOwningPlayer(Event_HeroRepick_Hero), heroIndex)\r\n    endfunction\r\n    \r\n    //OnHeroCreate\r\n    private function Choose_Condition takes nothing returns boolean\r\n        return IsHeroHasAspects(Event_HeroChoose_Hero)\r\n    endfunction\r\n    \r\n    private function Choose_Actions takes nothing returns nothing \r\n        local player owner = GetOwningPlayer(Event_HeroChoose_Hero)\r\n        local integer heroIndex = udg_HeroNum[GetUnitUserData(Event_HeroChoose_Hero)]\r\n        local integer i \r\n        \r\n        if GetLocalPlayer() == owner then\r\n            call BlzFrameSetVisible( AspectBackground, true )\r\n        endif\r\n\r\n        set i = 1\r\n        loop\r\n            exitwhen i > ASPECT_LIMIT\r\n            call SetAspectButtons(owner, i, Aspect[heroIndex][i])\r\n            set i = i + 1\r\n        endloop\r\n        \r\n        set owner = null\r\n    endfunction\r\n    \r\n    //Initialization\r\n    private function init takes nothing returns nothing\r\n        local framehandle outline = null\r\n        local integer i\r\n\r\n         set AspectBackground = BlzCreateFrame(\"CheckListBox\", BlzGetFrameByName(\"ConsoleUIBackdrop\", 0),0,0) \r\n         call BlzFrameSetAbsPoint(AspectBackground, FRAMEPOINT_TOPLEFT, 0.00519000, 0.216140) \r\n         call BlzFrameSetAbsPoint(AspectBackground, FRAMEPOINT_BOTTOMRIGHT, 0.184490, 0.164600) \r\n         call BlzFrameSetVisible( AspectBackground, false )\r\n\r\n         set AspectButton[0] = BlzCreateFrame(\"ScriptDialogButton\", AspectBackground, 0, 0) \r\n         call BlzFrameSetAbsPoint(AspectButton[0], FRAMEPOINT_TOPLEFT, 0.0100000, 0.210000) \r\n         call BlzFrameSetAbsPoint(AspectButton[0], FRAMEPOINT_BOTTOMRIGHT, 0.0500100, 0.170000) \r\n         set BackdropAspect[0] = BlzCreateFrameByType(\"BACKDROP\", \"BackdropAspect0\", AspectButton[0], \"\", 1) \r\n         call BlzFrameSetAllPoints(BackdropAspect[0], AspectButton[0]) \r\n         call BlzFrameSetTexture(BackdropAspect[0], \"ReplaceableTextures\\\\CommandButtons\\\\BTNCancel.blp\", 0, true) \r\n         set TriggerAspect[0] = CreateTrigger() \r\n         call BlzTriggerRegisterFrameEvent(TriggerAspect[0], AspectButton[0], FRAMEEVENT_CONTROL_CLICK) \r\n         call TriggerAddAction(TriggerAspect[0], function Aspect0Func) \r\n         call Tooltip_AddEvent(AspectButton[0], function TooltipEnable0 )\r\n\r\n         set AspectButton[1] = BlzCreateFrame(\"ScriptDialogButton\", AspectBackground, 0, 0) \r\n         call BlzFrameSetAbsPoint(AspectButton[1], FRAMEPOINT_TOPLEFT, 0.0520100, 0.210000) \r\n         call BlzFrameSetAbsPoint(AspectButton[1], FRAMEPOINT_BOTTOMRIGHT, 0.0920200, 0.170000) \r\n         set BackdropAspect[1] = BlzCreateFrameByType(\"BACKDROP\", \"BackdropAspect1\", AspectButton[1], \"\", 1) \r\n         call BlzFrameSetAllPoints(BackdropAspect[1], AspectButton[1]) \r\n         call BlzFrameSetTexture(BackdropAspect[1], \"\", 0, true) \r\n         set TriggerAspect[1] = CreateTrigger() \r\n         call BlzTriggerRegisterFrameEvent(TriggerAspect[1], AspectButton[1], FRAMEEVENT_CONTROL_CLICK) \r\n         call TriggerAddAction(TriggerAspect[1], function Aspect1Func) \r\n         call Tooltip_AddEvent(AspectButton[1], function TooltipEnable1 )\r\n\r\n         set AspectButton[2] = BlzCreateFrame(\"ScriptDialogButton\", AspectBackground, 0, 0) \r\n         call BlzFrameSetAbsPoint(AspectButton[2], FRAMEPOINT_TOPLEFT, 0.0940200, 0.210000) \r\n         call BlzFrameSetAbsPoint(AspectButton[2], FRAMEPOINT_BOTTOMRIGHT, 0.134030, 0.170000) \r\n         set BackdropAspect[2] = BlzCreateFrameByType(\"BACKDROP\", \"BackdropAspect2\", AspectButton[2], \"\", 1) \r\n         call BlzFrameSetAllPoints(BackdropAspect[2], AspectButton[2]) \r\n         call BlzFrameSetTexture(BackdropAspect[2], \"\", 0, true) \r\n         set TriggerAspect[2] = CreateTrigger() \r\n         call BlzTriggerRegisterFrameEvent(TriggerAspect[2], AspectButton[2], FRAMEEVENT_CONTROL_CLICK) \r\n         call TriggerAddAction(TriggerAspect[2], function Aspect2Func) \r\n         call Tooltip_AddEvent(AspectButton[2], function TooltipEnable2 )\r\n\r\n         set AspectButton[3] = BlzCreateFrame(\"ScriptDialogButton\", AspectBackground, 0, 0) \r\n         call BlzFrameSetAbsPoint(AspectButton[3], FRAMEPOINT_TOPLEFT, 0.136030, 0.210000) \r\n         call BlzFrameSetAbsPoint(AspectButton[3], FRAMEPOINT_BOTTOMRIGHT, 0.176040, 0.170000) \r\n         set BackdropAspect[3] = BlzCreateFrameByType(\"BACKDROP\", \"BackdropAspect3\", AspectButton[3], \"\", 1) \r\n         call BlzFrameSetAllPoints(BackdropAspect[3], AspectButton[3]) \r\n         call BlzFrameSetTexture(BackdropAspect[3], \"\", 0, true) \r\n         set TriggerAspect[3] = CreateTrigger() \r\n         call BlzTriggerRegisterFrameEvent(TriggerAspect[3], AspectButton[3], FRAMEEVENT_CONTROL_CLICK) \r\n         call TriggerAddAction(TriggerAspect[3], function Aspect3Func) \r\n         call Tooltip_AddEvent(AspectButton[3], function TooltipEnable3 )\r\n         \r\n         set i = 0\r\n        loop\r\n            exitwhen i > 3\r\n            set ChoosedAspect[i+1] = 0\r\n            set AspectName[i][0] = ASPECT_CANCEL_NAME\r\n            set AspectDescription[i][0] = ASPECT_CANCEL_DESCRIPTION\r\n            \r\n            set outline = BlzCreateFrameByType(\"BACKDROP\", \"\", AspectButton[i], \"\", 1) \r\n            call BlzFrameSetAllPoints(outline, AspectButton[i]) \r\n            call BlzFrameSetTexture(outline, \"BTNOutline.blp\", 0, true) \r\n            set i = i + 1\r\n        endloop\r\n\r\n        set ChoosedAspect = BlzCreateFrameByType(\"BACKDROP\", \"\", AspectBackground, \"\", 1) \r\n        call BlzFrameSetAllPoints(ChoosedAspect, AspectButton[0])\r\n        call BlzFrameSetTexture(ChoosedAspect, \"ChoosedApsect.blp\", 0, true) \r\n         \r\n        call CreateEventTrigger( \"udg_FightEnd_Real\", function Aspects_End_Actions, function Aspects_End_Condition )\r\n        call CreateEventTrigger( \"udg_FightStartGlobal_Real\", function Aspects_Start_Actions, null )\r\n        \r\n        call CreateEventTrigger( \"Event_HeroChoose_Real\", function Choose_Actions, function Choose_Condition )\r\n        call CreateEventTrigger( \"Event_HeroRepick_Real\", function Aspects_Repick_Actions, null )\r\n        \r\n        //Small icon with aspect\r\n        set AspectVision = BlzCreateFrameByType(\"BACKDROP\", \"AspectVision\", BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0), \"\", 1) \r\n        call BlzFrameSetAbsPoint(AspectVision, FRAMEPOINT_BOTTOM, 0.202, 0.04)\r\n        call BlzFrameSetSize( AspectVision, 0.017, 0.017 )\r\n        call BlzFrameSetTexture( AspectVision, \"\", 0, true) \r\n        call BlzFrameSetVisible( AspectVision, false )\r\n        \r\n        set outline = null\r\n    endfunction \r\nendlibrary\r\n\r\n\r\n",
  "Events": [],
  "LocalVariables": [],
  "Conditions": [],
  "Actions": []
}